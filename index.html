<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ff9500" />
  <meta name="description" content="A sleek interface for crafting and tracking your digital identity goals." />
  <title>Identity Forge</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest" />

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png" />

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png" />

  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Identity Forge" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg-dark: #0a0a0a;
      --bg-card: #151515;
      --bg-elevated: #1a1a1a;
      --accent: #ff9500;
      --accent-hover: #ffa733;
      --accent-dim: #ff950033;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-dim: #666666;
      --border: #2a2a2a;
      --success: #00ff88;
      --warning: #ffaa00;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
      --shadow-accent: 0 8px 24px rgba(255, 59, 48, 0.25);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
      background: var(--bg-dark);
      background-image:
        radial-gradient(circle at 20% 50%, rgba(255, 59, 48, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 59, 48, 0.03) 0%, transparent 50%);
      background-attachment: fixed;
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding: 0;
      margin: 0;
    }
    
    .app-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      padding: 60px 20px 50px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 40px;
      position: relative;
      background: linear-gradient(180deg, rgba(255, 59, 48, 0.03) 0%, transparent 100%);
    }

    .header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      border-radius: 2px;
    }

    .header h1 {
      font-size: 2.8rem;
      font-weight: 900;
      letter-spacing: -0.04em;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--accent) 0%, #ffb347 50%, #ffd180 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 40px rgba(255, 59, 48, 0.3);
      animation: titleGlow 3s ease-in-out infinite alternate;
    }

    @keyframes titleGlow {
      from { filter: brightness(1); }
      to { filter: brightness(1.1); }
    }

    .header .tagline {
      color: var(--text-secondary);
      font-size: 1.05rem;
      font-weight: 500;
      line-height: 1.6;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 40px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(21, 21, 21, 0.8) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: rgba(255, 59, 48, 0.3);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), #ffb347, var(--accent));
      background-size: 200% 100%;
      animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
      0%, 100% { background-position: 0% 0%; }
      50% { background-position: 100% 0%; }
    }
    
    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-dim);
      margin-bottom: 8px;
      font-weight: 700;
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 900;
      color: var(--accent);
      line-height: 1;
      margin-bottom: 4px;
    }
    
    .stat-trend {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .nav-tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 32px;
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(21, 21, 21, 0.95) 100%);
      padding: 8px;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }

    .nav-tab {
      flex: 1;
      padding: 16px 20px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 700;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      position: relative;
    }

    .nav-tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 50%;
      height: 2px;
      background: var(--accent);
      transition: transform 0.3s ease;
    }

    .nav-tab:hover {
      color: var(--text-primary);
      background: var(--bg-elevated);
    }

    .nav-tab:hover::after {
      transform: translateX(-50%) scaleX(1);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: var(--bg-dark);
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
    }

    .nav-tab.active::after {
      display: none;
    }
    
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section {
      background: linear-gradient(135deg, rgba(21, 21, 21, 0.95) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at top right, rgba(255, 59, 48, 0.05), transparent 50%);
      pointer-events: none;
    }

    .section:hover {
      border-color: rgba(255, 59, 48, 0.2);
      box-shadow: var(--shadow-lg);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .section-icon {
      font-size: 1.5rem;
    }
    
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-primary);
    }
    
    .truth-card {
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.95) 100%);
      border-left: 4px solid var(--accent);
      padding: 28px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .truth-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(255, 59, 48, 0.1), transparent 70%);
      pointer-events: none;
    }

    .truth-card:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
      border-left-color: var(--accent-hover);
    }
    
    .truth-text {
      font-size: 1.3rem;
      font-weight: 700;
      line-height: 1.4;
      margin-bottom: 16px;
      color: var(--text-primary);
    }
    
    .truth-question {
      font-size: 1rem;
      color: var(--text-secondary);
      font-style: italic;
      line-height: 1.6;
    }
    
    .question-block {
      margin-bottom: 32px;
    }
    
    .question-label {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
      display: block;
    }
    
    .question-hint {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 16px;
      font-style: italic;
    }
    
    .input-text,
    .input-textarea {
      width: 100%;
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.8) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 18px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .input-text:hover,
    .input-textarea:hover {
      border-color: rgba(255, 59, 48, 0.3);
    }

    .input-text:focus,
    .input-textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-dark);
      box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.1), inset 0 2px 4px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }
    
    .input-textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.6;
    }
    
    .slider-group {
      margin-bottom: 24px;
    }
    
    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .slider-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .slider-value {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--accent);
    }
    
    .slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--bg-elevated), rgba(26, 26, 26, 0.9));
      outline: none;
      -webkit-appearance: none;
      cursor: pointer;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
    }

    .slider:hover {
      background: linear-gradient(90deg, rgba(26, 26, 26, 0.95), var(--bg-elevated));
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(255, 59, 48, 0.4);
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.25);
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.6);
    }

    .slider::-webkit-slider-thumb:active {
      transform: scale(1.1);
    }

    .slider::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(255, 59, 48, 0.4);
      transition: all 0.3s ease;
    }

    .slider::-moz-range-thumb:hover {
      transform: scale(1.25);
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.6);
    }
    
    .btn {
      width: 100%;
      padding: 18px 32px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: var(--bg-dark);
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 24px;
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      background: linear-gradient(135deg, var(--accent-hover) 0%, #ffd180 100%);
      transform: translateY(-3px);
      box-shadow: var(--shadow-accent);
    }

    .btn:active {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.2);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: var(--bg-elevated);
      border-radius: 24px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 20px;
      border: 1px solid transparent;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .status-indicator.complete {
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 255, 136, 0.1) 100%);
      color: var(--success);
      border-color: rgba(0, 255, 136, 0.2);
    }

    .status-indicator.pending {
      background: linear-gradient(135deg, rgba(255, 170, 0, 0.15) 0%, rgba(255, 170, 0, 0.1) 100%);
      color: var(--warning);
      border-color: rgba(255, 170, 0, 0.2);
    }
    
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .history-item {
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .history-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, var(--accent), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .history-item:hover {
      transform: translateX(8px);
      border-color: rgba(255, 59, 48, 0.4);
      box-shadow: var(--shadow-md);
    }

    .history-item:hover::before {
      opacity: 1;
    }
    
    .history-date {
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 12px;
      font-size: 0.95rem;
    }
    
    .history-content {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    .history-content strong {
      color: var(--text-primary);
      display: block;
      margin-top: 12px;
      margin-bottom: 4px;
    }
    
    .history-scores {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 0.85rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, var(--success) 0%, #00cc6f 100%);
      color: var(--bg-dark);
      padding: 18px 28px;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 8px 32px rgba(0, 255, 136, 0.4);
      transform: translateX(400px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }

    .toast.show {
      transform: translateX(0);
      animation: toastBounce 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes toastBounce {
      0% { transform: translateX(400px); }
      60% { transform: translateX(-10px); }
      80% { transform: translateX(5px); }
      100% { transform: translateX(0); }
    }
    
    .yes-no-group {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .yes-no-btn {
      flex: 1;
      padding: 16px;
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .yes-no-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 59, 48, 0.1);
      transform: translate(-50%, -50%);
      transition: width 0.3s ease, height 0.3s ease;
    }

    .yes-no-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .yes-no-btn:hover::before {
      width: 100%;
      height: 100%;
    }

    .yes-no-btn.selected {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      border-color: var(--accent);
      color: var(--bg-dark);
      transform: scale(1.02);
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.4);
    }
    
    @media (max-width: 640px) {
      .app-container {
        padding: 12px;
      }
      
      .header {
        padding: 40px 12px 30px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .section {
        padding: 24px 20px;
      }
      
      .stats-bar {
        grid-template-columns: 1fr;
      }
      
      .nav-tabs {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .nav-tab {
        font-size: 0.85rem;
        padding: 12px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="header">
      <h1>IDENTITY FORGE</h1>
      <p class="tagline">Your life matters. Your time is limited. Your future self is watching.</p>
    </header>
    
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-label">Vitality</div>
        <div class="stat-value" id="vitalityScore">--</div>
        <div class="stat-trend" id="vitalityTrend">Not yet tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Courage</div>
        <div class="stat-value" id="courageScore">--</div>
        <div class="stat-trend" id="courageTrend">Not yet tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Meaning</div>
        <div class="stat-value" id="meaningScore">--</div>
        <div class="stat-trend" id="meaningTrend">Not yet tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Streak</div>
        <div class="stat-value" id="streakCount">0</div>
        <div class="stat-trend">Days</div>
      </div>
    </div>
    
    <nav class="nav-tabs">
      <button class="nav-tab active" onclick="switchView('morning')">Morning</button>
      <button class="nav-tab" onclick="switchView('evening')">Evening</button>
      <button class="nav-tab" onclick="switchView('history')">History</button>
      <button class="nav-tab" onclick="switchView('settings')">Settings</button>
    </nav>
    
    <!-- MORNING VIEW -->
    <div id="morning" class="view active">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üî•</span>
          <h2 class="section-title">Wake-Up Truth</h2>
        </div>
        
        <div class="truth-card">
          <div class="truth-text" id="dailyTruth">Loading truth...</div>
          <div class="truth-question" id="dailyQuestion">Loading question...</div>
        </div>
        
        <div class="question-block">
          <label class="question-label">Your honest response:</label>
          <textarea class="input-textarea" id="truthResponse" placeholder="Write your answer..."></textarea>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">‚ö°</span>
          <h2 class="section-title">Foundational Question</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label" id="foundationalQuestion">Loading question...</label>
          <textarea class="input-textarea" id="foundationalResponse" placeholder="Your answer..."></textarea>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üéØ</span>
          <h2 class="section-title">Identity Declaration</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">Today I am the man who...</label>
          <p class="question-hint">One clear sentence. Declare who you're becoming.</p>
          <input type="text" class="input-text" id="identityDeclaration" placeholder="Today I am the man who..." />
        </div>
        
        <div class="question-block">
          <label class="question-label">One action to prove it:</label>
          <p class="question-hint">What specific thing will you do today?</p>
          <input type="text" class="input-text" id="proofAction" placeholder="I will..." />
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üìä</span>
          <h2 class="section-title">Quick Check</h2>
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Energy Level</span>
            <span class="slider-value" id="energyValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="energySlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Optimism</span>
            <span class="slider-value" id="optimismValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="optimismSlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Confidence</span>
            <span class="slider-value" id="confidenceValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="confidenceSlider">
        </div>
      </div>
      
      <button class="btn" onclick="saveMorning()">Complete Morning</button>
    </div>
    
    <!-- EVENING VIEW -->
    <div id="evening" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">‚úì</span>
          <h2 class="section-title">Accountability</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">Did you do what you said you'd do?</label>
          <p class="question-hint" id="actionReminder">Loading your commitment...</p>
          <div class="yes-no-group">
            <button class="yes-no-btn" id="didItYes" onclick="selectYesNo(true)">YES</button>
            <button class="yes-no-btn" id="didItNo" onclick="selectYesNo(false)">NO</button>
          </div>
          <textarea class="input-textarea" id="accountabilityWhy" placeholder="Why or why not? Be honest."></textarea>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üèÜ</span>
          <h2 class="section-title">Today's Win</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">What's one thing you did well today?</label>
          <p class="question-hint">No matter how small. Acknowledge it.</p>
          <textarea class="input-textarea" id="todayWin" placeholder="Today I..."></textarea>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üìä</span>
          <h2 class="section-title">Evening Check</h2>
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Overall Happiness</span>
            <span class="slider-value" id="happinessValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="happinessSlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Handled Challenges</span>
            <span class="slider-value" id="challengesValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="challengesSlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Felt Connected</span>
            <span class="slider-value" id="connectionValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="connectionSlider">
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üîÆ</span>
          <h2 class="section-title">Tomorrow</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">What's your focus for tomorrow?</label>
          <p class="question-hint">One clear priority.</p>
          <input type="text" class="input-text" id="tomorrowFocus" placeholder="Tomorrow I will focus on..." />
        </div>
      </div>
      
      <button class="btn" onclick="saveEvening()">Complete Evening</button>
    </div>
    
    <!-- HISTORY VIEW -->
    <div id="history" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üìú</span>
          <h2 class="section-title">Your Journey</h2>
        </div>
        
        <div class="history-list" id="historyList">
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No entries yet. Complete your first check-in to start.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- SETTINGS VIEW -->
    <div id="settings" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">‚öôÔ∏è</span>
          <h2 class="section-title">Notification Settings</h2>
        </div>
        
        <div class="question-block">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <label class="question-label" style="margin: 0;">Enable Notifications</label>
            <button class="yes-no-btn" id="notifToggle" onclick="toggleNotifications()" style="width: 120px; padding: 10px;">
              <span id="notifStatus">OFF</span>
            </button>
          </div>
          <p class="question-hint" id="notifPermissionHint">Click to enable browser notifications</p>
        </div>
        
        <div id="notifSettings" style="display: none;">
          <div class="question-block">
            <label class="question-label">Morning Reminder</label>
            <p class="question-hint">When should we remind you to do your morning check-in?</p>
            <input type="time" class="input-text" id="morningTime" value="07:00" style="font-size: 1.1rem; padding: 16px;" />
          </div>
          
          <div class="question-block">
            <label class="question-label">Evening Reminder</label>
            <p class="question-hint">When should we remind you to do your evening reflection?</p>
            <input type="time" class="input-text" id="eveningTime" value="21:00" style="font-size: 1.1rem; padding: 16px;" />
          </div>
          
          <div class="question-block">
            <label class="question-label">Test Notification</label>
            <p class="question-hint">Send a test notification right now to make sure it's working</p>
            <button class="btn" onclick="testNotification()" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border);">Send Test Notification</button>
          </div>
          
          <button class="btn" onclick="saveNotificationSettings()">Save Reminder Times</button>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üíæ</span>
          <h2 class="section-title">Data Management</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">Export Your Data</label>
          <p class="question-hint">Download all your entries as a JSON file for backup</p>
          <button class="btn" onclick="exportData()" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border);">Download Data</button>
        </div>
        
        <div class="question-block">
          <label class="question-label" style="color: var(--warning);">Reset Everything</label>
          <p class="question-hint">This will delete all your entries. This cannot be undone.</p>
          <button class="btn" onclick="confirmReset()" style="background: transparent; color: var(--warning); border: 1px solid var(--warning);">Clear All Data</button>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">‚ÑπÔ∏è</span>
          <h2 class="section-title">App Info</h2>
        </div>

        <div class="question-block">
          <label class="question-label">Current Version</label>
          <p class="question-hint">Use this to verify you have the latest update</p>
          <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border: 1px solid var(--border); text-align: center;">
            <span style="font-size: 1.2rem; font-weight: 700; color: var(--accent);" id="appVersion">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  
  <script>
    // App Version - Update this timestamp when making changes
    const APP_VERSION = 'v2025-12-14 00:45';

    // Register Service Worker for PWA notifications
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('Service Worker registered');
        })
        .catch(err => {
          console.log('Service Worker registration failed:', err);
        });
    }

    // Wake-up truths and questions
    const truths = [
      {
        truth: "You are the youngest you will ever be.",
        question: "If today is the youngest, strongest version of you that will ever exist, what will you do with it that your older self will thank you for?"
      },
      {
        truth: "Every day might be your last.",
        question: "If today was the final page of your life, how would you want the story to end by midnight?"
      },
      {
        truth: "You are wealthier than most of the world.",
        question: "With the level of wealth, safety, and freedom you have, what excuse do you actually have to play small?"
      },
      {
        truth: "You have opportunities people would kill for.",
        question: "If someone with nothing had your life for 24 hours, how much harder would they push than you?"
      },
      {
        truth: "Your life is not guaranteed beyond today.",
        question: "If life was borrowed time, how would you spend the next twelve hours?"
      }
    ];
    
    // Foundational questions (rotating)
    const foundationalQuestions = [
      "Are you healthy today? If yes, what is stopping you from using this body fully?",
      "Is there someone who would stand at your funeral even if it rained? If not, how will you build relationships worth dying for?",
      "If you were gone tonight, what would people say about your life? Is that acceptable to you?",
      "What is one thing you can do today so that by bedtime, you feel genuine pride instead of regret?",
      "What fear or insecurity will you confront today that will raise your character one level higher?"
    ];
    
    // State management
    let entries = [];
    let currentDayIndex = 0;
    let eveningDidIt = null;
    let notificationsEnabled = false;
    let morningReminderTime = '07:00';
    let eveningReminderTime = '21:00';
    let notificationCheckInterval = null;
    
    // Initialize
    function init() {
      console.log(`üî• Identity Forge ${APP_VERSION} - App loaded successfully`);
      setupSliders();
      loadDailyContent();
      updateStats();
      checkEveningAvailability();
      loadNotificationSettings();
      startNotificationChecker();
      scheduleNextNotifications();
    }
    
    // Setup slider value displays
    function setupSliders() {
      const sliders = [
        {id: 'energySlider', valueId: 'energyValue'},
        {id: 'optimismSlider', valueId: 'optimismValue'},
        {id: 'confidenceSlider', valueId: 'confidenceValue'},
        {id: 'happinessSlider', valueId: 'happinessValue'},
        {id: 'challengesSlider', valueId: 'challengesValue'},
        {id: 'connectionSlider', valueId: 'connectionValue'}
      ];
      
      sliders.forEach(({id, valueId}) => {
        const slider = document.getElementById(id);
        const valueDisplay = document.getElementById(valueId);
        if (slider && valueDisplay) {
          slider.addEventListener('input', (e) => {
            valueDisplay.textContent = e.target.value;
          });
        }
      });
    }
    
    // Load daily rotating content
    function loadDailyContent() {
      const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
      const truthIndex = dayOfYear % truths.length;
      const questionIndex = dayOfYear % foundationalQuestions.length;
      
      currentDayIndex = dayOfYear;
      
      document.getElementById('dailyTruth').textContent = truths[truthIndex].truth;
      document.getElementById('dailyQuestion').textContent = truths[truthIndex].question;
      document.getElementById('foundationalQuestion').textContent = foundationalQuestions[questionIndex];
    }
    
    // Check if evening is available
    function checkEveningAvailability() {
      const today = getTodayEntries();
      if (today.morning) {
        document.getElementById('actionReminder').textContent = `You said: "${today.morning.proofAction}"`;
      }
    }
    
    // Get today's entries
    function getTodayEntries() {
      const today = new Date().toDateString();
      return {
        morning: entries.find(e => e.type === 'morning' && new Date(e.date).toDateString() === today),
        evening: entries.find(e => e.type === 'evening' && new Date(e.date).toDateString() === today)
      };
    }
    
    // Switch view
    function switchView(viewName) {
      const tabs = document.querySelectorAll('.nav-tab');
      const views = document.querySelectorAll('.view');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      views.forEach(view => view.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(viewName).classList.add('active');
      
      if (viewName === 'evening') {
        checkEveningAvailability();
      } else if (viewName === 'history') {
        displayHistory();
      } else if (viewName === 'settings') {
        updateSettingsUI();
      }
    }
    
    // Yes/No selection
    function selectYesNo(value) {
      eveningDidIt = value;
      document.getElementById('didItYes').classList.toggle('selected', value === true);
      document.getElementById('didItNo').classList.toggle('selected', value === false);
    }
    
    // Save morning
    function saveMorning() {
      const data = {
        date: new Date().toISOString(),
        type: 'morning',
        dayIndex: currentDayIndex,
        truthResponse: document.getElementById('truthResponse').value,
        foundationalResponse: document.getElementById('foundationalResponse').value,
        identityDeclaration: document.getElementById('identityDeclaration').value,
        proofAction: document.getElementById('proofAction').value,
        energy: parseInt(document.getElementById('energySlider').value),
        optimism: parseInt(document.getElementById('optimismSlider').value),
        confidence: parseInt(document.getElementById('confidenceSlider').value)
      };
      
      // Validate
      if (!data.truthResponse || !data.foundationalResponse || !data.identityDeclaration || !data.proofAction) {
        showToast('Please complete all fields');
        return;
      }
      
      // Remove old morning entry for today
      const today = new Date().toDateString();
      entries = entries.filter(e => !(e.type === 'morning' && new Date(e.date).toDateString() === today));
      
      entries.push(data);
      saveToStorage();
      showToast('Morning complete. Make it count.');
      updateStats();
      scheduleNextNotifications(); // Reschedule evening notification
      
      // Clear form
      document.getElementById('truthResponse').value = '';
      document.getElementById('foundationalResponse').value = '';
      document.getElementById('identityDeclaration').value = '';
      document.getElementById('proofAction').value = '';
    }
    
    // Save evening
    function saveEvening() {
      const todayMorning = getTodayEntries().morning;
      
      if (!todayMorning) {
        showToast('Complete your morning check-in first');
        return;
      }
      
      if (eveningDidIt === null) {
        showToast('Please select Yes or No for accountability');
        return;
      }
      
      const data = {
        date: new Date().toISOString(),
        type: 'evening',
        dayIndex: currentDayIndex,
        didIt: eveningDidIt,
        accountabilityWhy: document.getElementById('accountabilityWhy').value,
        todayWin: document.getElementById('todayWin').value,
        happiness: parseInt(document.getElementById('happinessSlider').value),
        challenges: parseInt(document.getElementById('challengesSlider').value),
        connection: parseInt(document.getElementById('connectionSlider').value),
        tomorrowFocus: document.getElementById('tomorrowFocus').value
      };
      
      // Validate
      if (!data.accountabilityWhy || !data.todayWin || !data.tomorrowFocus) {
        showToast('Please complete all fields');
        return;
      }
      
      // Remove old evening entry for today
      const today = new Date().toDateString();
      entries = entries.filter(e => !(e.type === 'evening' && new Date(e.date).toDateString() === today));
      
      entries.push(data);
      saveToStorage();
      showToast('Evening complete. Rest well.');
      updateStats();
      scheduleNextNotifications(); // Reschedule for tomorrow
      
      // Clear form
      eveningDidIt = null;
      document.getElementById('didItYes').classList.remove('selected');
      document.getElementById('didItNo').classList.remove('selected');
      document.getElementById('accountabilityWhy').value = '';
      document.getElementById('todayWin').value = '';
      document.getElementById('tomorrowFocus').value = '';
    }
    
    // Calculate stats
    function updateStats() {
      if (entries.length === 0) return;
      
      const morningEntries = entries.filter(e => e.type === 'morning');
      const eveningEntries = entries.filter(e => e.type === 'evening');
      
      // Calculate Vitality (energy + optimism)
      let vitalityScores = [];
      morningEntries.forEach(e => {
        vitalityScores.push((e.energy + e.optimism) / 2);
      });
      const vitality = vitalityScores.length > 0 
        ? (vitalityScores.reduce((a, b) => a + b, 0) / vitalityScores.length).toFixed(1)
        : '--';
      
      // Calculate Courage (confidence + challenges handled + did what you said)
      let courageScores = [];
      morningEntries.forEach(e => courageScores.push(e.confidence));
      eveningEntries.forEach(e => {
        courageScores.push(e.challenges);
        courageScores.push(e.didIt ? 10 : 5); // Bonus for following through
      });
      const courage = courageScores.length > 0
        ? (courageScores.reduce((a, b) => a + b, 0) / courageScores.length).toFixed(1)
        : '--';
      
      // Calculate Meaning (happiness + connection)
      let meaningScores = [];
      eveningEntries.forEach(e => {
        meaningScores.push((e.happiness + e.connection) / 2);
      });
      const meaning = meaningScores.length > 0
        ? (meaningScores.reduce((a, b) => a + b, 0) / meaningScores.length).toFixed(1)
        : '--';
      
      // Calculate streak
      const streak = calculateStreak();
      
      // Update display
      document.getElementById('vitalityScore').textContent = vitality;
      document.getElementById('courageScore').textContent = courage;
      document.getElementById('meaningScore').textContent = meaning;
      document.getElementById('streakCount').textContent = streak;
      
      // Update trends (last 7 days average)
      updateTrends();
    }
    
    // Calculate streak
    function calculateStreak() {
      const today = new Date();
      let streak = 0;
      
      for (let i = 0; i < 365; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() - i);
        const dateStr = checkDate.toDateString();
        
        const hasBoth = entries.some(e => e.type === 'morning' && new Date(e.date).toDateString() === dateStr) &&
                       entries.some(e => e.type === 'evening' && new Date(e.date).toDateString() === dateStr);
        
        if (hasBoth) {
          streak++;
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    // Update trends
    function updateTrends() {
      const trends = {
        vitality: 'Building energy',
        courage: 'Growing stronger',
        meaning: 'Finding purpose'
      };
      
      document.getElementById('vitalityTrend').textContent = trends.vitality;
      document.getElementById('courageTrend').textContent = trends.courage;
      document.getElementById('meaningTrend').textContent = trends.meaning;
    }
    
    // Display history
    function displayHistory() {
      const historyList = document.getElementById('historyList');
      
      if (entries.length === 0) {
        historyList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No entries yet. Complete your first check-in to start.</p>
          </div>
        `;
        return;
      }
      
      // Group by date
      const grouped = {};
      entries.forEach(entry => {
        const dateKey = new Date(entry.date).toDateString();
        if (!grouped[dateKey]) grouped[dateKey] = {};
        grouped[dateKey][entry.type] = entry;
      });
      
      // Sort by date descending
      const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
      
      historyList.innerHTML = sortedDates.slice(0, 30).map(dateStr => {
        const day = grouped[dateStr];
        const date = new Date(dateStr);
        const formattedDate = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        
        return `
          <div class="history-item">
            <div class="history-date">${formattedDate}</div>
            ${day.morning ? `
              <div class="history-content">
                <strong>Identity:</strong> ${day.morning.identityDeclaration}
                <strong>Action:</strong> ${day.morning.proofAction}
              </div>
            ` : ''}
            ${day.evening ? `
              <div class="history-content">
                <strong>Did it?</strong> ${day.evening.didIt ? 'YES ‚úì' : 'NO'}
                <strong>Win:</strong> ${day.evening.todayWin}
              </div>
            ` : ''}
            ${day.morning && day.evening ? `
              <div class="history-scores">
                <span>Vitality: ${((day.morning.energy + day.morning.optimism) / 2).toFixed(1)}</span>
                <span>Courage: ${day.morning.confidence}</span>
                <span>Meaning: ${((day.evening.happiness + day.evening.connection) / 2).toFixed(1)}</span>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    // Storage using localStorage with migration from old window-based storage
    function saveToStorage() {
      try {
        localStorage.setItem('identityForgeData', JSON.stringify(entries));
        localStorage.setItem('identityForgeSettings', JSON.stringify({
          notificationsEnabled,
          morningReminderTime,
          eveningReminderTime
        }));
        console.log(`Saved ${entries.length} entries to localStorage`);
      } catch (e) {
        console.error('Failed to save to localStorage:', e);
      }
    }

    function loadFromStorage() {
      // Migration: Check for old window-based storage first
      if (window.identityForgeData && !localStorage.getItem('identityForgeData')) {
        console.log('Migrating data from window storage to localStorage...');
        try {
          localStorage.setItem('identityForgeData', window.identityForgeData);
          const migratedData = JSON.parse(window.identityForgeData);
          console.log(`Migrated ${migratedData.length} entries to localStorage`);
        } catch (e) {
          console.error('Migration failed:', e);
        }
      }

      if (window.identityForgeSettings && !localStorage.getItem('identityForgeSettings')) {
        try {
          localStorage.setItem('identityForgeSettings', window.identityForgeSettings);
          console.log('Migrated settings to localStorage');
        } catch (e) {
          console.error('Settings migration failed:', e);
        }
      }

      // Load from localStorage
      try {
        const data = localStorage.getItem('identityForgeData');
        if (data) {
          entries = JSON.parse(data);
          console.log(`Loaded ${entries.length} entries from localStorage`);
        } else {
          console.log('No saved data found');
        }
      } catch (e) {
        console.error('Failed to load data:', e);
        entries = [];
      }

      try {
        const settings = localStorage.getItem('identityForgeSettings');
        if (settings) {
          const parsed = JSON.parse(settings);
          notificationsEnabled = parsed.notificationsEnabled || false;
          morningReminderTime = parsed.morningReminderTime || '07:00';
          eveningReminderTime = parsed.eveningReminderTime || '21:00';
          console.log('Settings loaded successfully');
        }
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
    }
    
    // Notification functions
    async function toggleNotifications() {
      if (!notificationsEnabled) {
        // Request permission
        if (!("Notification" in window)) {
          showToast("This browser doesn't support notifications");
          return;
        }

        // Check if service worker is available (required for Samsung)
        if (!('serviceWorker' in navigator)) {
          showToast("Service workers not supported. Try Chrome or Samsung Internet.");
          return;
        }

        showToast("Requesting permission...");

        const permission = await Notification.requestPermission();

        if (permission === "granted") {
          // Wait for service worker to be ready
          try {
            const registration = await navigator.serviceWorker.ready;
            console.log('Service worker ready for notifications');

            notificationsEnabled = true;
            showToast("Notifications enabled! Tap 'Test' to verify.");
            saveToStorage();
            updateSettingsUI();
            scheduleNextNotifications();
          } catch (err) {
            console.error('Service worker issue:', err);
            showToast("Service worker error. Try refreshing the page.");
          }
        } else if (permission === "denied") {
          showToast("Permission denied. Enable in browser settings > Site settings > Notifications");
        } else {
          showToast("Permission dismissed. Try again.");
        }
      } else {
        // Disable notifications
        notificationsEnabled = false;
        showToast("Notifications disabled");
        saveToStorage();
        updateSettingsUI();
      }
    }
    
    function scheduleNextNotifications() {
      if (!notificationsEnabled) return;
      
      const now = new Date();
      const today = getTodayEntries();
      
      // Calculate next morning time
      const morningTime = new Date();
      const [mHour, mMin] = morningReminderTime.split(':');
      morningTime.setHours(parseInt(mHour), parseInt(mMin), 0, 0);
      
      // If morning time has passed today and morning is done, schedule for tomorrow
      if (morningTime < now || today.morning) {
        morningTime.setDate(morningTime.getDate() + 1);
      }
      
      // Calculate next evening time  
      const eveningTime = new Date();
      const [eHour, eMin] = eveningReminderTime.split(':');
      eveningTime.setHours(parseInt(eHour), parseInt(eMin), 0, 0);
      
      // If evening time has passed today or evening is done, schedule for tomorrow
      if (eveningTime < now || today.evening) {
        eveningTime.setDate(eveningTime.getDate() + 1);
      }
      
      // Schedule via service worker if available
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
          // Schedule morning notification if not done today
          if (!today.morning) {
            registration.active.postMessage({
              type: 'SCHEDULE_NOTIFICATION',
              title: 'üî• Morning Check-In',
              body: 'Your life matters. Your time is limited. Start your day with intention.',
              notifyAt: morningTime.getTime()
            });
            console.log('Morning notification scheduled for:', morningTime.toLocaleString());
          }
          
          // Schedule evening notification if morning is done but not evening
          if (today.morning && !today.evening) {
            registration.active.postMessage({
              type: 'SCHEDULE_NOTIFICATION',
              title: 'üåô Evening Reflection',
              body: 'Did you do what you said you\'d do? Complete your evening check-in.',
              notifyAt: eveningTime.getTime()
            });
            console.log('Evening notification scheduled for:', eveningTime.toLocaleString());
          }
        }).catch(err => {
          console.error('Failed to schedule notifications:', err);
        });
      }
    }
    
    function loadNotificationSettings() {
      if (document.getElementById('morningTime')) {
        document.getElementById('morningTime').value = morningReminderTime;
      }
      if (document.getElementById('eveningTime')) {
        document.getElementById('eveningTime').value = eveningReminderTime;
      }
      updateSettingsUI();
    }
    
    function updateSettingsUI() {
      const toggle = document.getElementById('notifToggle');
      const status = document.getElementById('notifStatus');
      const settings = document.getElementById('notifSettings');
      const hint = document.getElementById('notifPermissionHint');

      if (notificationsEnabled) {
        toggle.classList.add('selected');
        status.textContent = 'ON';
        settings.style.display = 'block';
        hint.textContent = 'Notifications are active';
      } else {
        toggle.classList.remove('selected');
        status.textContent = 'OFF';
        settings.style.display = 'none';
        hint.textContent = 'Click to enable browser notifications';
      }

      // Update app version display
      const versionElement = document.getElementById('appVersion');
      if (versionElement) {
        versionElement.textContent = APP_VERSION;
      }
    }
    
    function saveNotificationSettings() {
      morningReminderTime = document.getElementById('morningTime').value;
      eveningReminderTime = document.getElementById('eveningTime').value;
      saveToStorage();
      scheduleNextNotifications(); // Reschedule with new times
      showToast('Reminder times saved. Notifications rescheduled for ' + morningReminderTime + ' and ' + eveningReminderTime);
    }
    
    async function testNotification() {
      if (!notificationsEnabled) {
        showToast('Enable notifications first');
        return;
      }

      if (!("Notification" in window)) {
        showToast("This browser doesn't support notifications");
        return;
      }

      if (Notification.permission !== "granted") {
        showToast("Notification permission not granted. Please enable in browser settings.");
        return;
      }

      // Check if service worker is ready (required for Samsung)
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.ready;
          if (!registration.active) {
            showToast("Service worker not active. Try refreshing the page.");
            return;
          }
        } catch (err) {
          showToast("Service worker error: " + err.message);
          return;
        }
      }

      showToast('Sending notification...');

      await sendNotification(
        'Test Notification',
        'Your notifications are working! You will receive reminders at your set times.',
        'settings'
      );

      // Delay the success message so user sees the notification first
      setTimeout(() => {
        showToast('Notification sent! Check your notification panel.');
      }, 500);
    }
    
    function startNotificationChecker() {
      // Check every 15 seconds for notifications
      notificationCheckInterval = setInterval(checkAndSendNotifications, 15000);
      // Check immediately
      checkAndSendNotifications();

      // Also check when app becomes visible (user returns to app)
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          console.log('App visible, checking for missed notifications...');
          checkAndSendNotifications();
        }
      });

      // Check when window gets focus
      window.addEventListener('focus', () => {
        console.log('Window focused, checking notifications...');
        checkAndSendNotifications();
      });
    }

    // Helper to parse time string to minutes since midnight
    function timeToMinutes(timeStr) {
      const [hours, mins] = timeStr.split(':').map(Number);
      return hours * 60 + mins;
    }

    // Helper to get today's date string for storage keys
    function getTodayDateString() {
      return new Date().toISOString().split('T')[0];
    }

    // Load last notification times from storage
    function getLastNotificationTime(type) {
      const key = `lastNotif_${type}_${getTodayDateString()}`;
      const stored = localStorage.getItem(key);
      return stored ? parseInt(stored, 10) : 0;
    }

    // Save last notification time to storage
    function setLastNotificationTime(type) {
      const key = `lastNotif_${type}_${getTodayDateString()}`;
      localStorage.setItem(key, Date.now().toString());
    }

    function checkAndSendNotifications() {
      if (!notificationsEnabled) return;
      if (!("Notification" in window) || Notification.permission !== "granted") return;

      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      const today = getTodayEntries();

      const morningMinutes = timeToMinutes(morningReminderTime);
      const eveningMinutes = timeToMinutes(eveningReminderTime);

      // Use a 5-minute window to catch notifications even if check was delayed
      const WINDOW_MINUTES = 5;

      // Check if we've already sent today (persisted in localStorage)
      const lastMorningNotif = getLastNotificationTime('morning');
      const lastEveningNotif = getLastNotificationTime('evening');
      const tenMinutesAgo = Date.now() - (10 * 60 * 1000);

      // Morning reminder - trigger if within window and not already sent today
      const morningDiff = currentMinutes - morningMinutes;
      if (morningDiff >= 0 && morningDiff <= WINDOW_MINUTES && !today.morning && lastMorningNotif < tenMinutesAgo) {
        console.log('Sending morning notification...');
        sendNotification(
          'Morning Check-In',
          'Your life matters. Your time is limited. Start your day with intention.',
          'morning'
        );
        setLastNotificationTime('morning');
      }

      // Evening reminder - trigger if within window and morning is done
      const eveningDiff = currentMinutes - eveningMinutes;
      if (eveningDiff >= 0 && eveningDiff <= WINDOW_MINUTES && today.morning && !today.evening && lastEveningNotif < tenMinutesAgo) {
        console.log('Sending evening notification...');
        sendNotification(
          'Evening Reflection',
          'Did you do what you said you\'d do? Complete your evening check-in.',
          'evening'
        );
        setLastNotificationTime('evening');
      }
    }
    
    async function sendNotification(title, body, type) {
      if (!("Notification" in window) || Notification.permission !== "granted") {
        console.log('Notification permission not granted');
        return;
      }

      // Use Service Worker for notifications (required for Samsung/Android)
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.ready;
          await registration.showNotification(title, {
            body: body,
            icon: '/icons/icon-192.png',
            badge: '/icons/icon-192.png',
            vibrate: [200, 100, 200, 100, 200],
            tag: 'identity-forge-' + type,
            requireInteraction: true,
            actions: [
              { action: 'open', title: 'Open App' },
              { action: 'dismiss', title: 'Dismiss' }
            ],
            data: { type: type }
          });
          console.log('Notification sent via Service Worker');
          return;
        } catch (err) {
          console.error('Service Worker notification failed:', err);
        }
      }

      // Fallback to direct notification (desktop browsers)
      try {
        const notification = new Notification(title, {
          body: body,
          icon: '/icons/icon-192.png',
          badge: '/icons/icon-192.png',
          requireInteraction: false,
          silent: false
        });

        notification.onclick = function() {
          window.focus();
          switchView(type);
          notification.close();
        };
      } catch (err) {
        console.error('Direct notification failed:', err);
      }
    }
    
    // Data management
    function exportData() {
      const dataStr = JSON.stringify({
        entries: entries,
        exportDate: new Date().toISOString(),
        version: '1.0'
      }, null, 2);
      
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `identity-forge-backup-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('Data exported successfully');
    }
    
    function confirmReset() {
      if (confirm('Are you absolutely sure? This will delete ALL your entries and cannot be undone.')) {
        if (confirm('Last chance. Delete everything?')) {
          entries = [];
          saveToStorage();
          updateStats();
          displayHistory();
          showToast('All data cleared');
        }
      }
    }
    
    // Toast notification
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // Initialize on load
    loadFromStorage();
    init();
  </script>
</body>
</html>
