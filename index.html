<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ff9500" />
  <meta name="description" content="A sleek interface for crafting and tracking your digital identity goals." />
  <title>Identity Forge</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest" />

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png" />

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png" />

  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Identity Forge" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg-dark: #0a0a0a;
      --bg-card: #151515;
      --bg-elevated: #1a1a1a;
      --accent: #ff9500;
      --accent-hover: #ffa733;
      --accent-dim: #ff950033;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-dim: #666666;
      --border: #2a2a2a;
      --success: #00ff88;
      --warning: #ffaa00;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
      --shadow-accent: 0 8px 24px rgba(255, 59, 48, 0.25);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
      background: var(--bg-dark);
      background-image:
        radial-gradient(circle at 20% 50%, rgba(255, 59, 48, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 59, 48, 0.03) 0%, transparent 50%);
      background-attachment: fixed;
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding: 0;
      margin: 0;
    }
    
    .app-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      padding: 60px 20px 50px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 40px;
      position: relative;
      background: linear-gradient(180deg, rgba(255, 59, 48, 0.03) 0%, transparent 100%);
    }

    .header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      border-radius: 2px;
    }

    .header h1 {
      font-size: 2.8rem;
      font-weight: 900;
      letter-spacing: -0.04em;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--accent) 0%, #ffb347 50%, #ffd180 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 40px rgba(255, 59, 48, 0.3);
      animation: titleGlow 3s ease-in-out infinite alternate;
    }

    @keyframes titleGlow {
      from { filter: brightness(1); }
      to { filter: brightness(1.1); }
    }

    .header .tagline {
      color: var(--text-secondary);
      font-size: 1.05rem;
      font-weight: 500;
      line-height: 1.6;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 40px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(21, 21, 21, 0.8) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: rgba(255, 59, 48, 0.3);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), #ffb347, var(--accent));
      background-size: 200% 100%;
      animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
      0%, 100% { background-position: 0% 0%; }
      50% { background-position: 100% 0%; }
    }
    
    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-dim);
      margin-bottom: 8px;
      font-weight: 700;
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 900;
      color: var(--accent);
      line-height: 1;
      margin-bottom: 4px;
    }
    
    .stat-trend {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .nav-tabs {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-bottom: 32px;
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(21, 21, 21, 0.95) 100%);
      padding: 8px;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }

    .nav-icon {
      display: none;
    }

    .nav-tab {
      flex: 1;
      padding: 16px 20px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 700;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      position: relative;
    }

    .nav-tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 50%;
      height: 2px;
      background: var(--accent);
      transition: transform 0.3s ease;
    }

    .nav-tab:hover {
      color: var(--text-primary);
      background: var(--bg-elevated);
    }

    .nav-tab:hover::after {
      transform: translateX(-50%) scaleX(1);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: var(--bg-dark);
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
    }

    .nav-tab.active::after {
      display: none;
    }
    
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section {
      background: linear-gradient(135deg, rgba(21, 21, 21, 0.95) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at top right, rgba(255, 59, 48, 0.05), transparent 50%);
      pointer-events: none;
    }

    .section:hover {
      border-color: rgba(255, 59, 48, 0.2);
      box-shadow: var(--shadow-lg);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .section-icon {
      font-size: 1.5rem;
    }
    
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-primary);
    }
    
    .truth-card {
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.95) 100%);
      border-left: 4px solid var(--accent);
      padding: 28px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .truth-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(255, 59, 48, 0.1), transparent 70%);
      pointer-events: none;
    }

    .truth-card:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
      border-left-color: var(--accent-hover);
    }
    
    .truth-text {
      font-size: 1.3rem;
      font-weight: 700;
      line-height: 1.4;
      margin-bottom: 16px;
      color: var(--text-primary);
    }
    
    .truth-question {
      font-size: 1rem;
      color: var(--text-secondary);
      font-style: italic;
      line-height: 1.6;
    }
    
    .question-block {
      margin-bottom: 32px;
    }
    
    .question-label {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
      display: block;
    }
    
    .question-hint {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 16px;
      font-style: italic;
    }
    
    .input-text,
    .input-textarea {
      width: 100%;
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.8) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 18px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .input-text:hover,
    .input-textarea:hover {
      border-color: rgba(255, 59, 48, 0.3);
    }

    .input-text:focus,
    .input-textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-dark);
      box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.1), inset 0 2px 4px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }
    
    .input-textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.6;
    }
    
    .slider-group {
      margin-bottom: 24px;
    }
    
    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .slider-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .slider-value {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--accent);
    }
    
    .slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--bg-elevated), rgba(26, 26, 26, 0.9));
      outline: none;
      -webkit-appearance: none;
      cursor: pointer;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
    }

    .slider:hover {
      background: linear-gradient(90deg, rgba(26, 26, 26, 0.95), var(--bg-elevated));
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(255, 59, 48, 0.4);
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.25);
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.6);
    }

    .slider::-webkit-slider-thumb:active {
      transform: scale(1.1);
    }

    .slider::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(255, 59, 48, 0.4);
      transition: all 0.3s ease;
    }

    .slider::-moz-range-thumb:hover {
      transform: scale(1.25);
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.6);
    }
    
    .btn {
      width: 100%;
      padding: 18px 32px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: var(--bg-dark);
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 24px;
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      background: linear-gradient(135deg, var(--accent-hover) 0%, #ffd180 100%);
      transform: translateY(-3px);
      box-shadow: var(--shadow-accent);
    }

    .btn:active {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.2);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: var(--bg-elevated);
      border-radius: 24px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 20px;
      border: 1px solid transparent;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .status-indicator.complete {
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 255, 136, 0.1) 100%);
      color: var(--success);
      border-color: rgba(0, 255, 136, 0.2);
    }

    .status-indicator.pending {
      background: linear-gradient(135deg, rgba(255, 170, 0, 0.15) 0%, rgba(255, 170, 0, 0.1) 100%);
      color: var(--warning);
      border-color: rgba(255, 170, 0, 0.2);
    }
    
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .history-item {
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .history-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, var(--accent), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .history-item:hover {
      transform: translateX(8px);
      border-color: rgba(255, 59, 48, 0.4);
      box-shadow: var(--shadow-md);
    }

    .history-item:hover::before {
      opacity: 1;
    }
    
    .history-date {
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 12px;
      font-size: 0.95rem;
    }
    
    .history-content {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    .history-content strong {
      color: var(--text-primary);
      display: block;
      margin-top: 12px;
      margin-bottom: 4px;
    }
    
    .history-scores {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 0.85rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, var(--success) 0%, #00cc6f 100%);
      color: var(--bg-dark);
      padding: 18px 28px;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 8px 32px rgba(0, 255, 136, 0.4);
      transform: translateX(400px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }

    .toast.show {
      transform: translateX(0);
      animation: toastBounce 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes toastBounce {
      0% { transform: translateX(400px); }
      60% { transform: translateX(-10px); }
      80% { transform: translateX(5px); }
      100% { transform: translateX(0); }
    }
    
    .yes-no-group {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .yes-no-btn {
      flex: 1;
      padding: 16px;
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .yes-no-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 59, 48, 0.1);
      transform: translate(-50%, -50%);
      transition: width 0.3s ease, height 0.3s ease;
    }

    .yes-no-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .yes-no-btn:hover::before {
      width: 100%;
      height: 100%;
    }

    .yes-no-btn.selected {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      border-color: var(--accent);
      color: var(--bg-dark);
      transform: scale(1.02);
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.4);
    }
    
    @media (max-width: 640px) {
      .app-container {
        padding: 12px;
      }

      .header {
        padding: 40px 12px 30px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .section {
        padding: 24px 20px;
      }

      .stats-bar {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        grid-template-columns: repeat(3, 1fr);
      }

      .nav-tab {
        font-size: 0.8rem;
        padding: 12px 8px;
      }

      .nav-icon {
        display: inline;
        margin-right: 2px;
      }
    }

    /* Ground/Reality Check Styles */
    .ground-container {
      position: relative;
      min-height: 400px;
    }

    .ground-screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .ground-screen.active {
      display: block;
    }

    .ground-progress {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding: 16px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .ground-progress-text {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-secondary);
    }

    .ground-progress-bar {
      flex: 1;
      height: 6px;
      background: var(--bg-dark);
      border-radius: 3px;
      margin: 0 16px;
      overflow: hidden;
    }

    .ground-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .ground-question-text {
      font-size: 1.3rem;
      font-weight: 700;
      line-height: 1.5;
      color: var(--text-primary);
      margin-bottom: 32px;
      text-align: center;
    }

    .ground-yes-no {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .ground-yes-no .yes-no-btn {
      flex: 1;
      padding: 20px;
      font-size: 1.1rem;
      min-height: 60px;
    }

    .ground-response {
      animation: fadeIn 0.3s ease;
    }

    .ground-truth {
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.05) 100%);
      border-left: 4px solid var(--accent);
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text-primary);
    }

    .ground-commitment-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
      display: block;
    }

    .ground-mode-card {
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
    }

    .ground-mode-card:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
    }

    .ground-mode-card:active {
      transform: translateY(-2px);
    }

    .ground-mode-title {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .ground-mode-desc {
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    .ground-summary {
      text-align: center;
      padding: 20px 0;
    }

    .ground-summary-count {
      font-size: 3rem;
      font-weight: 900;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .ground-summary-label {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .ground-summary-message {
      font-size: 1.1rem;
      line-height: 1.8;
      color: var(--text-primary);
      margin-bottom: 32px;
      padding: 24px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .ground-summary-message strong {
      color: var(--accent);
      display: block;
      margin: 16px 0 8px;
    }

    .ground-meta {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 24px;
    }

    .ground-btn-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ground-btn-secondary {
      width: 100%;
      padding: 16px;
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .ground-btn-secondary:hover {
      border-color: var(--accent);
      background: var(--bg-dark);
    }

    .ground-exit-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 0.9rem;
      cursor: pointer;
      padding: 8px 16px;
      transition: color 0.2s ease;
    }

    .ground-exit-btn:hover {
      color: var(--text-primary);
    }

    .ground-last-check {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 24px;
      text-align: center;
    }

    .ground-commitments-list {
      text-align: left;
      max-height: 400px;
      overflow-y: auto;
    }

    .ground-commitment-item {
      padding: 16px;
      background: var(--bg-elevated);
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 3px solid var(--accent);
    }

    .ground-commitment-q {
      font-size: 0.85rem;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    .ground-commitment-a {
      font-size: 1rem;
      color: var(--text-primary);
    }

    /* Principles Section Styles */
    .principles-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .principles-header h2 {
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--accent);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .principles-header .tagline {
      font-size: 1rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    .today-principle-card {
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.15) 0%, rgba(255, 149, 0, 0.05) 100%);
      border: 2px solid var(--accent);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
    }

    .today-principle-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, rgba(255, 149, 0, 0.2), transparent 70%);
      pointer-events: none;
    }

    .today-principle-label {
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--accent);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .today-principle-number {
      font-size: 1rem;
      font-weight: 800;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .today-principle-text {
      font-size: 1.2rem;
      font-weight: 600;
      line-height: 1.6;
      color: var(--text-primary);
      margin-bottom: 20px;
    }

    .today-principle-status {
      display: inline-block;
      padding: 8px 16px;
      background: var(--bg-dark);
      border-radius: 20px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .today-principle-status.honored {
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 255, 136, 0.1) 100%);
      color: var(--success);
      border-color: rgba(0, 255, 136, 0.3);
    }

    .principles-list {
      margin-bottom: 32px;
    }

    .principle-item {
      display: flex;
      gap: 16px;
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .principle-item:hover {
      border-color: rgba(255, 149, 0, 0.3);
      transform: translateX(4px);
    }

    .principle-item.today-highlight {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.02) 100%);
    }

    .principle-number {
      font-size: 1.4rem;
      font-weight: 900;
      color: var(--accent);
      min-width: 32px;
    }

    .principle-text {
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text-primary);
    }

    .weekly-tracking {
      margin-bottom: 32px;
    }

    .weekly-tracking-title {
      font-size: 0.9rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .week-day-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 12px 16px;
      background: var(--bg-elevated);
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
    }

    .week-day-row.today {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.02) 100%);
    }

    .week-day-name {
      font-weight: 700;
      color: var(--text-primary);
      min-width: 50px;
    }

    .week-day-principles {
      font-size: 0.9rem;
      color: var(--text-secondary);
      flex: 1;
      text-align: right;
    }

    .week-day-principles .honored {
      color: var(--success);
    }

    .week-score {
      text-align: center;
      padding: 16px;
      background: var(--bg-dark);
      border-radius: 12px;
      margin-top: 16px;
      border: 1px solid var(--border);
    }

    .week-score-value {
      font-size: 2rem;
      font-weight: 900;
      color: var(--accent);
    }

    .week-score-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .monthly-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .monthly-stat-card {
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .monthly-stat-label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    .monthly-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.4;
    }

    .monthly-stat-value .highlight {
      color: var(--accent);
    }

    /* Principles checkboxes in evening */
    .principles-checkbox-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .principle-checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-elevated);
      border-radius: 10px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .principle-checkbox-item:hover {
      border-color: rgba(255, 149, 0, 0.4);
      background: var(--bg-dark);
    }

    .principle-checkbox-item.checked {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 255, 136, 0.02) 100%);
    }

    .principle-checkbox {
      width: 24px;
      height: 24px;
      min-width: 24px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      color: transparent;
      font-size: 14px;
    }

    .principle-checkbox-item.checked .principle-checkbox {
      background: var(--success);
      border-color: var(--success);
      color: var(--bg-dark);
    }

    .principle-checkbox-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .principle-checkbox-item.checked .principle-checkbox-text {
      color: var(--text-primary);
    }

    /* Morning principle reminder */
    .morning-principle-reminder {
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.03) 100%);
      border-left: 4px solid var(--accent);
      padding: 20px;
      border-radius: 12px;
      margin-top: 8px;
    }

    .morning-principle-label {
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .morning-principle-text {
      font-size: 1rem;
      color: var(--text-primary);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .morning-principle-prompt {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    @media (max-width: 640px) {
      .monthly-stats {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        grid-template-columns: repeat(3, 1fr);
      }

      .today-principle-card {
        padding: 20px;
      }

      .today-principle-text {
        font-size: 1.1rem;
      }
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="app-container">
    <header class="header">
      <div id="syncStatus" style="position: absolute; top: 20px; right: 20px; font-size: 0.85rem; color: var(--text-secondary); display: none;">
        <span id="syncIcon">‚òÅÔ∏è</span> <span id="syncText">Synced</span>
      </div>
      <h1>IDENTITY FORGE</h1>
      <p class="tagline">Your life matters. Your time is limited. Your future self is watching.</p>
      <div style="max-width: 700px; margin: 30px auto 0; text-align: left; padding: 24px; background: var(--bg-elevated); border-radius: 12px; border-left: 4px solid var(--accent);">
        <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--accent); margin-bottom: 20px; text-align: center;">
          Discipline is the name of the game.
        </h3>
        
        <h4 style="font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">
          My Two Golden Rules for an Amazing Life
        </h4>
        
        <div style="margin-bottom: 20px;">
          <p style="font-size: 0.95rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; line-height: 1.6;">
            1. Do what needs to be done, ESPECIALLY when you don't feel like it.
          </p>
          <p style="font-size: 0.9rem; color: var(--text-secondary); font-style: italic; padding-left: 20px; line-height: 1.5;">
            This is where discipline is built and identity is forged.
          </p>
        </div>
        
        <div>
          <p style="font-size: 0.95rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; line-height: 1.6;">
            2. Find the advantage in every situation life throws at you, and remember to smile.
          </p>
          <p style="font-size: 0.9rem; color: var(--text-secondary); font-style: italic; padding-left: 20px; line-height: 1.5;">
            Every moment is training you. Use it.
          </p>
        </div>
      </div>
    </header>
    
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-label">Vitality</div>
        <div class="stat-value" id="vitalityScore">--</div>
        <div class="stat-trend" id="vitalityTrend">Not yet tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Courage</div>
        <div class="stat-value" id="courageScore">--</div>
        <div class="stat-trend" id="courageTrend">Not yet tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Meaning</div>
        <div class="stat-value" id="meaningScore">--</div>
        <div class="stat-trend" id="meaningTrend">Not yet tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Streak</div>
        <div class="stat-value" id="streakCount">0</div>
        <div class="stat-trend">Days</div>
      </div>
    </div>
    
    <nav class="nav-tabs">
      <button class="nav-tab active" onclick="switchView('morning')">Morning</button>
      <button class="nav-tab" onclick="switchView('evening')">Evening</button>
      <button class="nav-tab" onclick="switchView('history')">History</button>
      <button class="nav-tab" onclick="switchView('ground')"><span class="nav-icon">‚öñÔ∏è</span> Ground</button>
      <button class="nav-tab" onclick="switchView('principles')"><span class="nav-icon">üìú</span> Principles</button>
      <button class="nav-tab" onclick="switchView('settings')">Settings</button>
    </nav>
    
    <!-- LOGIN VIEW -->
    <div id="login" class="view active">
      <div class="section" style="max-width: 500px; margin: 100px auto; text-align: center;">
        <div style="margin-bottom: 40px;">
          <h1 style="font-size: 3rem; margin-bottom: 16px; background: linear-gradient(135deg, var(--accent) 0%, #ffb347 50%, #ffd180 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">IDENTITY FORGE</h1>
          <p style="font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 40px;">
            Your life. Your rules. Your transformation.
          </p>
        </div>

        <button class="btn" onclick="signInWithGoogle()" style="display: flex; align-items: center; justify-content: center; gap: 12px; margin: 0 auto;">
          <svg width="24" height="24" viewBox="0 0 24 24">
            <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Sign in with Google
        </button>

        <div style="margin-top: 40px; padding: 24px; background: var(--bg-elevated); border-radius: 12px; border: 1px solid var(--border);">
          <p style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
            <strong style="color: var(--text-primary);">Your data syncs across all devices</strong><br>
            Sign in once, access anywhere. Your progress is always backed up and secure.
          </p>
        </div>
      </div>
    </div>

    <!-- MORNING VIEW -->
    <div id="morning" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üî•</span>
          <h2 class="section-title">Wake-Up Truth</h2>
        </div>
        
        <div class="truth-card">
          <div class="truth-text" id="dailyTruth">Loading truth...</div>
          <div class="truth-question" id="dailyQuestion">Loading question...</div>
        </div>
        
        <div class="question-block">
          <label class="question-label">Your honest response:</label>
          <textarea class="input-textarea" id="truthResponse" placeholder="Write your answer..."></textarea>
        </div>

        <!-- Today's Principle Reminder -->
        <div class="morning-principle-reminder">
          <div class="morning-principle-label">üéØ Today's Principle</div>
          <div class="morning-principle-text" id="morningPrincipleText">Loading...</div>
          <div class="morning-principle-prompt" id="morningPrinciplePrompt">What leap will you take today?</div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">‚ö°</span>
          <h2 class="section-title">Foundational Question</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label" id="foundationalQuestion">Loading question...</label>
          <textarea class="input-textarea" id="foundationalResponse" placeholder="Your answer..."></textarea>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üéØ</span>
          <h2 class="section-title">Identity Declaration</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">Today I am the man who...</label>
          <p class="question-hint">One clear sentence. Declare who you're becoming.</p>
          <input type="text" class="input-text" id="identityDeclaration" placeholder="Today I am the man who..." />
        </div>
        
        <div class="question-block">
          <label class="question-label">One action to prove it:</label>
          <p class="question-hint">What specific thing will you do today?</p>
          <input type="text" class="input-text" id="proofAction" placeholder="I will..." />
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üìä</span>
          <h2 class="section-title">Quick Check</h2>
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Energy Level</span>
            <span class="slider-value" id="energyValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="energySlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Optimism</span>
            <span class="slider-value" id="optimismValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="optimismSlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Confidence</span>
            <span class="slider-value" id="confidenceValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="confidenceSlider">
        </div>
      </div>
      
      <button class="btn" onclick="saveMorning()">Complete Morning</button>
    </div>
    
    <!-- EVENING VIEW -->
    <div id="evening" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">‚úì</span>
          <h2 class="section-title">Accountability</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">Did you do what you said you'd do?</label>
          <p class="question-hint" id="actionReminder">Loading your commitment...</p>
          <div class="yes-no-group">
            <button class="yes-no-btn" id="didItYes" onclick="selectYesNo(true)">YES</button>
            <button class="yes-no-btn" id="didItNo" onclick="selectYesNo(false)">NO</button>
          </div>
          <textarea class="input-textarea" id="accountabilityWhy" placeholder="Why or why not? Be honest."></textarea>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üèÜ</span>
          <h2 class="section-title">Today's Win</h2>
        </div>

        <div class="question-block">
          <label class="question-label">What's one thing you did well today?</label>
          <p class="question-hint">No matter how small. Acknowledge it.</p>
          <textarea class="input-textarea" id="todayWin" placeholder="Today I..."></textarea>
        </div>
      </div>

      <!-- Principles Check -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üìú</span>
          <h2 class="section-title">Principles Check</h2>
        </div>

        <div class="question-block">
          <label class="question-label">Which principles did you live by today?</label>
          <p class="question-hint">Select all that apply</p>

          <div class="principles-checkbox-list" id="principlesCheckboxList">
            <!-- Populated by JavaScript -->
          </div>
        </div>

        <div class="question-block">
          <label class="question-label">Reflection (Optional)</label>
          <p class="question-hint">Which principle did you break? How will you honor it tomorrow?</p>
          <textarea class="input-textarea" id="principlesReflection" placeholder="Today I struggled with..."></textarea>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">üìä</span>
          <h2 class="section-title">Evening Check</h2>
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Overall Happiness</span>
            <span class="slider-value" id="happinessValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="happinessSlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Handled Challenges</span>
            <span class="slider-value" id="challengesValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="challengesSlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Felt Connected</span>
            <span class="slider-value" id="connectionValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="connectionSlider">
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üîÆ</span>
          <h2 class="section-title">Tomorrow</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">What's your focus for tomorrow?</label>
          <p class="question-hint">One clear priority.</p>
          <input type="text" class="input-text" id="tomorrowFocus" placeholder="Tomorrow I will focus on..." />
        </div>
      </div>
      
      <button class="btn" onclick="saveEvening()">Complete Evening</button>
    </div>
    
    <!-- HISTORY VIEW -->
    <div id="history" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üìú</span>
          <h2 class="section-title">Your Journey</h2>
        </div>
        
        <div class="history-list" id="historyList">
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No entries yet. Complete your first check-in to start.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- SETTINGS VIEW -->
    <div id="settings" class="view">
      <!-- Account Section -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üë§</span>
          <h2 class="section-title">Account</h2>
        </div>

        <div id="userInfo" class="question-block">
          <label class="question-label">Signed in as:</label>
          <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border: 1px solid var(--border); margin-bottom: 16px;">
            <div id="userEmail" style="font-weight: 600; margin-bottom: 8px;">Loading...</div>
            <div id="lastSynced" style="font-size: 0.85rem; color: var(--text-secondary);">Synced with cloud</div>
          </div>
        </div>

        <div class="question-block">
          <label class="question-label">Migrate Local Data</label>
          <p class="question-hint">Upload your existing localStorage data to cloud</p>
          <button class="btn" onclick="migrateLocalDataToFirebase()" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border);">
            Import Local Data to Cloud
          </button>
        </div>

        <div class="question-block">
          <button class="btn" onclick="signOut()" style="background: transparent; color: var(--warning); border: 1px solid var(--warning);">
            Sign Out
          </button>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">‚öôÔ∏è</span>
          <h2 class="section-title">Notification Settings</h2>
        </div>
        
        <div class="question-block">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <label class="question-label" style="margin: 0;">Enable Notifications</label>
            <button class="yes-no-btn" id="notifToggle" onclick="toggleNotifications()" style="width: 120px; padding: 10px;">
              <span id="notifStatus">OFF</span>
            </button>
          </div>
          <p class="question-hint" id="notifPermissionHint">Click to enable browser notifications</p>
        </div>
        
        <div id="notifSettings" style="display: none;">
          <div class="question-block">
            <label class="question-label">Morning Reminder</label>
            <p class="question-hint">When should we remind you to do your morning check-in?</p>
            <input type="time" class="input-text" id="morningTime" value="07:00" style="font-size: 1.1rem; padding: 16px;" />
          </div>
          
          <div class="question-block">
            <label class="question-label">Evening Reminder</label>
            <p class="question-hint">When should we remind you to do your evening reflection?</p>
            <input type="time" class="input-text" id="eveningTime" value="21:00" style="font-size: 1.1rem; padding: 16px;" />
          </div>
          
          <div class="question-block">
            <label class="question-label">Test Notification</label>
            <p class="question-hint">Send a test notification right now to make sure it's working</p>
            <button class="btn" onclick="testNotification()" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border);">Send Test Notification</button>
          </div>
          
          <button class="btn" onclick="saveNotificationSettings()">Save Reminder Times</button>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üíæ</span>
          <h2 class="section-title">Data Management</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">Export Your Data</label>
          <p class="question-hint">Download all your entries as a JSON file for backup</p>
          <button class="btn" onclick="exportData()" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border);">Download Data</button>
        </div>
        
        <div class="question-block">
          <label class="question-label" style="color: var(--warning);">Reset Everything</label>
          <p class="question-hint">This will delete all your entries. This cannot be undone.</p>
          <button class="btn" onclick="confirmReset()" style="background: transparent; color: var(--warning); border: 1px solid var(--warning);">Clear All Data</button>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">‚ÑπÔ∏è</span>
          <h2 class="section-title">App Info</h2>
        </div>

        <div class="question-block">
          <label class="question-label">Current Version</label>
          <p class="question-hint">Use this to verify you have the latest update</p>
          <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border: 1px solid var(--border); text-align: center;">
            <span style="font-size: 1.2rem; font-weight: 700; color: var(--accent);" id="appVersion">Loading...</span>
          </div>
        </div>

        <div class="question-block">
          <label class="question-label">Gratitude Grounding</label>
          <p class="question-hint">Last reality check to remind yourself of your wealth</p>
          <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border: 1px solid var(--border);">
            <span id="lastGroundCheck">Never completed</span>
          </div>
          <button class="btn" onclick="switchView('ground')" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border); margin-top: 12px;">
            Take Reality Check
          </button>
        </div>

        <div class="question-block">
          <label class="question-label">Principles Practice</label>
          <p class="question-hint">Track how you live by your 7 core principles</p>
          <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border: 1px solid var(--border);">
            <span id="principlesMonthlyAvg">Not tracked yet</span>
          </div>
          <button class="btn" onclick="switchView('principles')" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border); margin-top: 12px;">
            View Principles
          </button>
        </div>
      </div>
    </div>

    <!-- GROUND VIEW (Reality Check) -->
    <div id="ground" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">‚öñÔ∏è</span>
          <h2 class="section-title">Reality Check</h2>
        </div>

        <div class="ground-container">
          <!-- Mode Selection Screen -->
          <div id="groundModeSelect" class="ground-screen active">
            <p class="ground-last-check" id="groundLastCheckDisplay">Last check: Never</p>

            <div class="ground-mode-card" onclick="startGroundCheck('quick')">
              <div class="ground-mode-title">Quick Mode</div>
              <div class="ground-mode-desc">5 random questions (~3 minutes)</div>
            </div>

            <div class="ground-mode-card" onclick="startGroundCheck('full')">
              <div class="ground-mode-title">Full Mode</div>
              <div class="ground-mode-desc">All 15 questions (~10 minutes)</div>
            </div>

            <div id="groundResumeOption" style="display: none; margin-top: 24px;">
              <button class="ground-btn-secondary" onclick="resumeGroundCheck()">
                Resume Previous Check
              </button>
            </div>
          </div>

          <!-- Question Screen -->
          <div id="groundQuestion" class="ground-screen">
            <button class="ground-exit-btn" onclick="exitGroundCheck()">Exit</button>

            <div class="ground-progress">
              <span class="ground-progress-text" id="groundProgressText">1 / 15</span>
              <div class="ground-progress-bar">
                <div class="ground-progress-fill" id="groundProgressFill" style="width: 0%"></div>
              </div>
            </div>

            <div class="ground-question-text" id="groundQuestionText">Loading...</div>

            <div class="ground-yes-no">
              <button class="yes-no-btn" id="groundYes" onclick="groundAnswer('yes')">YES</button>
              <button class="yes-no-btn" id="groundNo" onclick="groundAnswer('no')">NO</button>
            </div>

            <div id="groundResponseArea" class="ground-response" style="display: none;">
              <div class="ground-truth" id="groundTruthText"></div>

              <label class="ground-commitment-label" id="groundCommitmentLabel">Name one way you will respect this gift today.</label>
              <input type="text" class="input-text" id="groundCommitmentInput" placeholder="I will..." />

              <button class="btn" id="groundNextBtn" onclick="groundNext()" style="display: none;">Next</button>
            </div>
          </div>

          <!-- Summary Screen -->
          <div id="groundSummary" class="ground-screen">
            <div class="ground-summary">
              <div class="ground-summary-count" id="groundWealthCount">0</div>
              <div class="ground-summary-label">forms of wealth acknowledged</div>

              <div class="ground-summary-message">
                Billions will never have them.<br><br>
                You are not owed anything.<br>
                You were given a lot.<br><br>
                <strong>You owe life a response.</strong>
                What will you do with it today?
              </div>

              <div class="ground-meta">
                <div>Wealth forms: <span id="groundSummaryWealth">0</span> / <span id="groundSummaryTotal">15</span></div>
                <div>Completed: <span id="groundSummaryDate">-</span></div>
              </div>

              <div class="ground-btn-group">
                <button class="ground-btn-secondary" onclick="viewGroundCommitments()">View My Commitments</button>
                <button class="btn" onclick="resetGroundCheck()">Start Again</button>
                <button class="ground-btn-secondary" onclick="switchView('morning')">Done</button>
              </div>
            </div>
          </div>

          <!-- Commitments View Screen -->
          <div id="groundCommitments" class="ground-screen">
            <button class="ground-exit-btn" onclick="showGroundSummary()">‚Üê Back</button>

            <h3 style="margin-bottom: 24px; color: var(--text-primary);">Your Commitments</h3>

            <div class="ground-commitments-list" id="groundCommitmentsList"></div>

            <button class="ground-btn-secondary" onclick="showGroundSummary()" style="margin-top: 24px;">Back to Summary</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PRINCIPLES VIEW -->
    <div id="principles" class="view">
      <div class="section">
        <div class="principles-header">
          <h2>How to Live Well</h2>
          <p class="tagline">The rules you forget when life gets hard</p>
        </div>

        <!-- Today's Principle Card -->
        <div class="today-principle-card">
          <div class="today-principle-label">üéØ Today's Focus</div>
          <div class="today-principle-number" id="todayPrincipleNumber">Principle #1</div>
          <div class="today-principle-text" id="todayPrincipleText">Loading...</div>
          <div class="today-principle-status" id="todayPrincipleStatus">Check in evening</div>
        </div>

        <!-- All Principles List -->
        <div class="principles-list" id="principlesList">
          <!-- Populated by JavaScript -->
        </div>
      </div>

      <!-- Weekly Tracking Section -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üìä</span>
          <h2 class="section-title">This Week's Practice</h2>
        </div>

        <div class="weekly-tracking" id="weeklyTracking">
          <!-- Populated by JavaScript -->
        </div>

        <div class="week-score">
          <div class="week-score-value" id="weekScoreValue">0</div>
          <div class="week-score-label">principles honored this week</div>
        </div>
      </div>

      <!-- Monthly Stats Section -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üìà</span>
          <h2 class="section-title">This Month</h2>
        </div>

        <div class="monthly-stats" id="monthlyStats">
          <div class="monthly-stat-card">
            <div class="monthly-stat-label">Most Honored</div>
            <div class="monthly-stat-value" id="mostHonoredPrinciple">Not enough data</div>
          </div>
          <div class="monthly-stat-card">
            <div class="monthly-stat-label">Least Honored</div>
            <div class="monthly-stat-value" id="leastHonoredPrinciple">Not enough data</div>
          </div>
          <div class="monthly-stat-card">
            <div class="monthly-stat-label">Best Day</div>
            <div class="monthly-stat-value" id="bestDayPrinciple">Not enough data</div>
          </div>
          <div class="monthly-stat-card">
            <div class="monthly-stat-label">Daily Average</div>
            <div class="monthly-stat-value" id="avgPrinciplesDay">Not enough data</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  
  <script>
    // ===== FIREBASE CONFIGURATION =====
    const firebaseConfig = {
      apiKey: "AIzaSyDOpPd6VIHLB8moCVGPoeoMPM-8dw6hxa4",
      authDomain: "identity-forge-a7651.firebaseapp.com",
      projectId: "identity-forge-a7651",
      storageBucket: "identity-forge-a7651.firebasestorage.app",
      messagingSenderId: "112698545602",
      appId: "1:112698545602:web:251b97c25de3ccf5eef25b"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Enable offline persistence
    db.enablePersistence()
      .catch((err) => {
        if (err.code == 'failed-precondition') {
          console.log('Multiple tabs open, persistence enabled in first tab only');
        } else if (err.code == 'unimplemented') {
          console.log('Browser does not support persistence');
        }
      });

    let currentUser = null;

    // Auth state listener
    auth.onAuthStateChanged((user) => {
      currentUser = user;
      if (user) {
        console.log('User signed in:', user.email);
        onUserSignedIn(user);
      } else {
        console.log('User signed out');
        onUserSignedOut();
      }
    });

    // ===== END FIREBASE CONFIGURATION =====

    // App Version - Update this timestamp when making changes
    const APP_VERSION = 'v2025-12-15 01:00';

    // Register Service Worker for PWA notifications
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('Service Worker registered');
        })
        .catch(err => {
          console.log('Service Worker registration failed:', err);
        });
    }

    // Wake-up truths and questions
    const truths = [
      {
        truth: "You are the youngest you will ever be.",
        question: "If today is the youngest, strongest version of you that will ever exist, what will you do with it that your older self will thank you for?"
      },
      {
        truth: "Every day might be your last.",
        question: "If today was the final page of your life, how would you want the story to end by midnight?"
      },
      {
        truth: "You are wealthier than most of the world.",
        question: "With the level of wealth, safety, and freedom you have, what excuse do you actually have to play small?"
      },
      {
        truth: "You have opportunities people would kill for.",
        question: "If someone with nothing had your life for 24 hours, how much harder would they push than you?"
      },
      {
        truth: "Your life is not guaranteed beyond today.",
        question: "If life was borrowed time, how would you spend the next twelve hours?"
      }
    ];
    
    // Foundational questions (rotating)
    const foundationalQuestions = [
      "Are you healthy today? If yes, what is stopping you from using this body fully?",
      "Is there someone who would stand at your funeral even if it rained? If not, how will you build relationships worth dying for?",
      "If you were gone tonight, what would people say about your life? Is that acceptable to you?",
      "What is one thing you can do today so that by bedtime, you feel genuine pride instead of regret?",
      "What fear or insecurity will you confront today that will raise your character one level higher?"
    ];

    // Principles for living well
    const principles = [
      {
        number: 1,
        short: "Be your own best friend",
        full: "Be your own best friend. Never attack yourself.",
        prompt: "How will you practice self-compassion today?"
      },
      {
        number: 2,
        short: "Nothing is yours (no loss, only gain)",
        full: "Believe that nothing is yours so there is no loss, only gain.",
        prompt: "What can you appreciate without clinging to today?"
      },
      {
        number: 3,
        short: "Invest in good friends",
        full: "Invest in good friends. They tend to add colors to life.",
        prompt: "Who will you connect with today?"
      },
      {
        number: 4,
        short: "Take relentless action",
        full: "Take relentless action by reducing overthinking and taking the leaps. That tends to add more excitement and opportunity into your life.",
        prompt: "What leap will you take today?"
      },
      {
        number: 5,
        short: "Give more than you take",
        full: "Give more than you take. Giving provides sense of meaning into your life.",
        prompt: "What will you give freely today?"
      },
      {
        number: 6,
        short: "Enjoy little moments",
        full: "Enjoy little moments. Beautiful breakfast, sunsets, laughs. Life is just a series of moments.",
        prompt: "What small moment will you fully embrace today?"
      },
      {
        number: 7,
        short: "Play a musical instrument",
        full: "Learn to play a musical instrument. It adds another form of expression.",
        prompt: "How will you express yourself creatively today?"
      }
    ];

    // Principles tracking data
    let principlesData = {
      tracking: []
    };
    let selectedPrinciples = [];

    // State management
    let entries = [];
    let currentDayIndex = 0;
    let eveningDidIt = null;
    let notificationsEnabled = false;
    let morningReminderTime = '07:00';
    let eveningReminderTime = '21:00';
    let notificationCheckInterval = null;

    // ===== FIREBASE AUTHENTICATION FUNCTIONS =====

    // Sign in with Google
    async function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await auth.signInWithPopup(provider);
        showToast('Signed in successfully!');
      } catch (error) {
        console.error('Sign in error:', error);
        showToast('Sign in failed: ' + error.message);
      }
    }

    // Sign out
    async function signOut() {
      try {
        await auth.signOut();
        showToast('Signed out');
      } catch (error) {
        console.error('Sign out error:', error);
      }
    }

    // When user signs in
    function onUserSignedIn(user) {
      // Hide login view, show app
      document.getElementById('login').classList.remove('active');
      document.getElementById('morning').classList.add('active');

      // Show sync status, header, nav tabs, and stats bar
      document.getElementById('syncStatus').style.display = 'block';
      document.querySelector('.header').style.display = 'block';
      document.querySelector('.stats-bar').style.display = 'grid';
      document.querySelector('.nav-tabs').style.display = 'grid';

      // Load user data from Firestore
      loadUserDataFromFirebase(user.uid);

      // Show user email in settings
      updateUserInfoInSettings(user);
    }

    // When user signs out
    function onUserSignedOut() {
      // Show login view, hide app
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById('login').classList.add('active');

      // Hide sync status, header, nav tabs, and stats bar
      document.getElementById('syncStatus').style.display = 'none';
      document.querySelector('.header').style.display = 'none';
      document.querySelector('.stats-bar').style.display = 'none';
      document.querySelector('.nav-tabs').style.display = 'none';

      // Clear entries array
      entries = [];
    }

    // ===== FIRESTORE DATA FUNCTIONS =====

    // Load data from Firestore
    async function loadUserDataFromFirebase(userId) {
      updateSyncStatus('syncing');

      try {
        // Load entries
        const entriesDoc = await db.collection('users').doc(userId).collection('data').doc('entries').get();
        if (entriesDoc.exists) {
          entries = entriesDoc.data().items || [];
        }

        // Load settings
        const settingsDoc = await db.collection('users').doc(userId).collection('data').doc('settings').get();
        if (settingsDoc.exists) {
          const settings = settingsDoc.data();
          notificationsEnabled = settings.notificationsEnabled || false;
          morningReminderTime = settings.morningReminderTime || '07:00';
          eveningReminderTime = settings.eveningReminderTime || '21:00';
        }

        // Load principles data
        const principlesDoc = await db.collection('users').doc(userId).collection('data').doc('principles').get();
        if (principlesDoc.exists) {
          principlesData = principlesDoc.data() || { tracking: [] };
        }

        // Update UI
        updateStats();
        loadNotificationSettings();
        initPrinciplesUI();
        checkEveningAvailability();
        startNotificationChecker();
        scheduleNextNotifications();
        updateSyncStatus('synced');

        console.log('User data loaded from Firebase');
      } catch (error) {
        console.error('Firebase load error:', error);
        updateSyncStatus('error');
        showToast('Could not load cloud data');

        // Fallback to localStorage
        loadFromStorage();
        loadPrinciplesData();
        updateStats();
        loadNotificationSettings();
        initPrinciplesUI();
        checkEveningAvailability();
        startNotificationChecker();
        scheduleNextNotifications();
      }
    }

    // Save entries to Firebase
    async function saveEntriesToFirebase() {
      if (!currentUser) return;

      updateSyncStatus('syncing');

      try {
        await db.collection('users').doc(currentUser.uid).collection('data').doc('entries').set({
          items: entries,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        updateSyncStatus('synced');
      } catch (error) {
        console.error('Error saving entries:', error);
        updateSyncStatus('error');
      }
    }

    // Save settings to Firebase
    async function saveSettingsToFirebase() {
      if (!currentUser) return;

      try {
        await db.collection('users').doc(currentUser.uid).collection('data').doc('settings').set({
          notificationsEnabled,
          morningReminderTime,
          eveningReminderTime,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.error('Error saving settings:', error);
      }
    }

    // Save principles data to Firebase
    async function savePrinciplesDataToFirebase() {
      if (!currentUser) return;

      try {
        await db.collection('users').doc(currentUser.uid).collection('data').doc('principles').set({
          ...principlesData,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.error('Error saving principles data:', error);
      }
    }

    // Update sync status indicator
    function updateSyncStatus(status) {
      const icon = document.getElementById('syncIcon');
      const text = document.getElementById('syncText');

      if (!icon || !text) return;

      switch(status) {
        case 'syncing':
          icon.textContent = 'üîÑ';
          text.textContent = 'Syncing...';
          break;
        case 'synced':
          icon.textContent = '‚òÅÔ∏è';
          text.textContent = 'Synced';
          break;
        case 'error':
          icon.textContent = '‚ö†Ô∏è';
          text.textContent = 'Offline';
          break;
      }
    }

    // Migration function - import localStorage data to Firebase
    async function migrateLocalDataToFirebase() {
      if (!currentUser) {
        showToast('Sign in first');
        return;
      }

      if (!confirm('Upload your local data to cloud? This will merge with any existing cloud data.')) {
        return;
      }

      updateSyncStatus('syncing');
      showToast('Migrating data...');

      try {
        // Load from localStorage
        loadFromStorage();

        // Upload to Firebase
        await saveEntriesToFirebase();
        await saveSettingsToFirebase();
        await savePrinciplesDataToFirebase();

        updateSyncStatus('synced');
        showToast('Migration complete!');
      } catch (error) {
        console.error('Migration error:', error);
        updateSyncStatus('error');
        showToast('Migration failed');
      }
    }

    // Update user info display in settings
    function updateUserInfoInSettings(user) {
      const emailEl = document.getElementById('userEmail');
      if (emailEl && user) {
        emailEl.textContent = user.email;
      }
    }

    // ===== END FIREBASE FUNCTIONS =====

    // Initialize
    function init() {
      console.log(`üî• Identity Forge ${APP_VERSION} - App loaded successfully`);

      // Hide app elements initially (will be shown after sign-in)
      document.querySelector('.header').style.display = 'none';
      document.querySelector('.stats-bar').style.display = 'none';
      document.querySelector('.nav-tabs').style.display = 'none';

      // Setup UI elements that don't depend on user data
      setupSliders();
      loadDailyContent();

      // Update app version display in settings
      const appVersionEl = document.getElementById('appVersion');
      if (appVersionEl) appVersionEl.textContent = APP_VERSION;

      // Note: Data-dependent functions (updateStats, checkEveningAvailability, etc.)
      // are called from onUserSignedIn() after Firebase loads user data
    }
    
    // Setup slider value displays
    function setupSliders() {
      const sliders = [
        {id: 'energySlider', valueId: 'energyValue'},
        {id: 'optimismSlider', valueId: 'optimismValue'},
        {id: 'confidenceSlider', valueId: 'confidenceValue'},
        {id: 'happinessSlider', valueId: 'happinessValue'},
        {id: 'challengesSlider', valueId: 'challengesValue'},
        {id: 'connectionSlider', valueId: 'connectionValue'}
      ];
      
      sliders.forEach(({id, valueId}) => {
        const slider = document.getElementById(id);
        const valueDisplay = document.getElementById(valueId);
        if (slider && valueDisplay) {
          slider.addEventListener('input', (e) => {
            valueDisplay.textContent = e.target.value;
          });
        }
      });
    }
    
    // Load daily rotating content
    function loadDailyContent() {
      const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
      const truthIndex = dayOfYear % truths.length;
      const questionIndex = dayOfYear % foundationalQuestions.length;
      
      currentDayIndex = dayOfYear;
      
      document.getElementById('dailyTruth').textContent = truths[truthIndex].truth;
      document.getElementById('dailyQuestion').textContent = truths[truthIndex].question;
      document.getElementById('foundationalQuestion').textContent = foundationalQuestions[questionIndex];
    }
    
    // Check if evening is available
    function checkEveningAvailability() {
      const today = getTodayEntries();
      if (today.morning) {
        document.getElementById('actionReminder').textContent = `You said: "${today.morning.proofAction}"`;
      }
    }
    
    // Get today's entries
    function getTodayEntries() {
      const today = new Date().toDateString();
      return {
        morning: entries.find(e => e.type === 'morning' && new Date(e.date).toDateString() === today),
        evening: entries.find(e => e.type === 'evening' && new Date(e.date).toDateString() === today)
      };
    }
    
    // Switch view
    function switchView(viewName) {
      const tabs = document.querySelectorAll('.nav-tab');
      const views = document.querySelectorAll('.view');

      tabs.forEach(tab => tab.classList.remove('active'));
      views.forEach(view => view.classList.remove('active'));

      // Find and activate the correct tab
      tabs.forEach(tab => {
        if (tab.textContent.toLowerCase().includes(viewName.toLowerCase()) ||
            (viewName === 'ground' && tab.textContent.includes('Ground')) ||
            (viewName === 'principles' && tab.textContent.includes('Principles'))) {
          tab.classList.add('active');
        }
      });

      document.getElementById(viewName).classList.add('active');

      if (viewName === 'evening') {
        checkEveningAvailability();
        initPrinciplesCheckboxes();
      } else if (viewName === 'history') {
        displayHistory();
      } else if (viewName === 'settings') {
        updateSettingsUI();
      } else if (viewName === 'ground') {
        initGroundView();
      } else if (viewName === 'principles') {
        updatePrinciplesView();
      }
    }
    
    // Yes/No selection
    function selectYesNo(value) {
      eveningDidIt = value;
      document.getElementById('didItYes').classList.toggle('selected', value === true);
      document.getElementById('didItNo').classList.toggle('selected', value === false);
    }
    
    // Save morning
    function saveMorning() {
      const data = {
        date: new Date().toISOString(),
        type: 'morning',
        dayIndex: currentDayIndex,
        truthResponse: document.getElementById('truthResponse').value,
        foundationalResponse: document.getElementById('foundationalResponse').value,
        identityDeclaration: document.getElementById('identityDeclaration').value,
        proofAction: document.getElementById('proofAction').value,
        energy: parseInt(document.getElementById('energySlider').value),
        optimism: parseInt(document.getElementById('optimismSlider').value),
        confidence: parseInt(document.getElementById('confidenceSlider').value)
      };
      
      // Validate
      if (!data.truthResponse || !data.foundationalResponse || !data.identityDeclaration || !data.proofAction) {
        showToast('Please complete all fields');
        return;
      }
      
      // Remove old morning entry for today
      const today = new Date().toDateString();
      entries = entries.filter(e => !(e.type === 'morning' && new Date(e.date).toDateString() === today));
      
      entries.push(data);
      saveToStorage();
      saveEntriesToFirebase(); // Sync to Firebase
      showToast('Morning complete. Make it count.');
      updateStats();
      scheduleNextNotifications(); // Reschedule evening notification

      // Clear form
      document.getElementById('truthResponse').value = '';
      document.getElementById('foundationalResponse').value = '';
      document.getElementById('identityDeclaration').value = '';
      document.getElementById('proofAction').value = '';
    }

    // Save evening
    function saveEvening() {
      const todayMorning = getTodayEntries().morning;

      if (!todayMorning) {
        showToast('Complete your morning check-in first');
        return;
      }

      if (eveningDidIt === null) {
        showToast('Please select Yes or No for accountability');
        return;
      }

      const data = {
        date: new Date().toISOString(),
        type: 'evening',
        dayIndex: currentDayIndex,
        didIt: eveningDidIt,
        accountabilityWhy: document.getElementById('accountabilityWhy').value,
        todayWin: document.getElementById('todayWin').value,
        happiness: parseInt(document.getElementById('happinessSlider').value),
        challenges: parseInt(document.getElementById('challengesSlider').value),
        connection: parseInt(document.getElementById('connectionSlider').value),
        tomorrowFocus: document.getElementById('tomorrowFocus').value
      };

      // Validate
      if (!data.accountabilityWhy || !data.todayWin || !data.tomorrowFocus) {
        showToast('Please complete all fields');
        return;
      }

      // Remove old evening entry for today
      const today = new Date().toDateString();
      entries = entries.filter(e => !(e.type === 'evening' && new Date(e.date).toDateString() === today));

      entries.push(data);
      saveToStorage();
      saveEntriesToFirebase(); // Sync to Firebase

      // Save principles tracking
      savePrinciplesTracking();

      showToast('Evening complete. Rest well.');
      updateStats();
      scheduleNextNotifications(); // Reschedule for tomorrow

      // Clear form
      eveningDidIt = null;
      document.getElementById('didItYes').classList.remove('selected');
      document.getElementById('didItNo').classList.remove('selected');
      document.getElementById('accountabilityWhy').value = '';
      document.getElementById('todayWin').value = '';
      document.getElementById('tomorrowFocus').value = '';
      document.getElementById('principlesReflection').value = '';
      selectedPrinciples = [];
      initPrinciplesCheckboxes();
    }
    
    // Calculate stats
    function updateStats() {
      if (entries.length === 0) return;
      
      const morningEntries = entries.filter(e => e.type === 'morning');
      const eveningEntries = entries.filter(e => e.type === 'evening');
      
      // Calculate Vitality (energy + optimism)
      let vitalityScores = [];
      morningEntries.forEach(e => {
        vitalityScores.push((e.energy + e.optimism) / 2);
      });
      const vitality = vitalityScores.length > 0 
        ? (vitalityScores.reduce((a, b) => a + b, 0) / vitalityScores.length).toFixed(1)
        : '--';
      
      // Calculate Courage (confidence + challenges handled + did what you said)
      let courageScores = [];
      morningEntries.forEach(e => courageScores.push(e.confidence));
      eveningEntries.forEach(e => {
        courageScores.push(e.challenges);
        courageScores.push(e.didIt ? 10 : 5); // Bonus for following through
      });
      const courage = courageScores.length > 0
        ? (courageScores.reduce((a, b) => a + b, 0) / courageScores.length).toFixed(1)
        : '--';
      
      // Calculate Meaning (happiness + connection)
      let meaningScores = [];
      eveningEntries.forEach(e => {
        meaningScores.push((e.happiness + e.connection) / 2);
      });
      const meaning = meaningScores.length > 0
        ? (meaningScores.reduce((a, b) => a + b, 0) / meaningScores.length).toFixed(1)
        : '--';
      
      // Calculate streak
      const streak = calculateStreak();
      
      // Update display
      document.getElementById('vitalityScore').textContent = vitality;
      document.getElementById('courageScore').textContent = courage;
      document.getElementById('meaningScore').textContent = meaning;
      document.getElementById('streakCount').textContent = streak;
      
      // Update trends (last 7 days average)
      updateTrends();
    }
    
    // Calculate streak
    function calculateStreak() {
      const today = new Date();
      let streak = 0;
      
      for (let i = 0; i < 365; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() - i);
        const dateStr = checkDate.toDateString();
        
        const hasBoth = entries.some(e => e.type === 'morning' && new Date(e.date).toDateString() === dateStr) &&
                       entries.some(e => e.type === 'evening' && new Date(e.date).toDateString() === dateStr);
        
        if (hasBoth) {
          streak++;
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    // Update trends
    function updateTrends() {
      const trends = {
        vitality: 'Building energy',
        courage: 'Growing stronger',
        meaning: 'Finding purpose'
      };
      
      document.getElementById('vitalityTrend').textContent = trends.vitality;
      document.getElementById('courageTrend').textContent = trends.courage;
      document.getElementById('meaningTrend').textContent = trends.meaning;
    }
    
    // Display history
    function displayHistory() {
      const historyList = document.getElementById('historyList');
      
      if (entries.length === 0) {
        historyList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No entries yet. Complete your first check-in to start.</p>
          </div>
        `;
        return;
      }
      
      // Group by date
      const grouped = {};
      entries.forEach(entry => {
        const dateKey = new Date(entry.date).toDateString();
        if (!grouped[dateKey]) grouped[dateKey] = {};
        grouped[dateKey][entry.type] = entry;
      });
      
      // Sort by date descending
      const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
      
      historyList.innerHTML = sortedDates.slice(0, 30).map(dateStr => {
        const day = grouped[dateStr];
        const date = new Date(dateStr);
        const formattedDate = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        
        return `
          <div class="history-item">
            <div class="history-date">${formattedDate}</div>
            ${day.morning ? `
              <div class="history-content">
                <strong>Identity:</strong> ${day.morning.identityDeclaration}
                <strong>Action:</strong> ${day.morning.proofAction}
              </div>
            ` : ''}
            ${day.evening ? `
              <div class="history-content">
                <strong>Did it?</strong> ${day.evening.didIt ? 'YES ‚úì' : 'NO'}
                <strong>Win:</strong> ${day.evening.todayWin}
              </div>
            ` : ''}
            ${day.morning && day.evening ? `
              <div class="history-scores">
                <span>Vitality: ${((day.morning.energy + day.morning.optimism) / 2).toFixed(1)}</span>
                <span>Courage: ${day.morning.confidence}</span>
                <span>Meaning: ${((day.evening.happiness + day.evening.connection) / 2).toFixed(1)}</span>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    // Storage using localStorage with migration from old window-based storage
    function saveToStorage() {
      try {
        localStorage.setItem('identityForgeData', JSON.stringify(entries));
        localStorage.setItem('identityForgeSettings', JSON.stringify({
          notificationsEnabled,
          morningReminderTime,
          eveningReminderTime
        }));
        console.log(`Saved ${entries.length} entries to localStorage`);
      } catch (e) {
        console.error('Failed to save to localStorage:', e);
      }
    }

    function loadFromStorage() {
      // Migration: Check for old window-based storage first
      if (window.identityForgeData && !localStorage.getItem('identityForgeData')) {
        console.log('Migrating data from window storage to localStorage...');
        try {
          localStorage.setItem('identityForgeData', window.identityForgeData);
          const migratedData = JSON.parse(window.identityForgeData);
          console.log(`Migrated ${migratedData.length} entries to localStorage`);
        } catch (e) {
          console.error('Migration failed:', e);
        }
      }

      if (window.identityForgeSettings && !localStorage.getItem('identityForgeSettings')) {
        try {
          localStorage.setItem('identityForgeSettings', window.identityForgeSettings);
          console.log('Migrated settings to localStorage');
        } catch (e) {
          console.error('Settings migration failed:', e);
        }
      }

      // Load from localStorage
      try {
        const data = localStorage.getItem('identityForgeData');
        if (data) {
          entries = JSON.parse(data);
          console.log(`Loaded ${entries.length} entries from localStorage`);
        } else {
          console.log('No saved data found');
        }
      } catch (e) {
        console.error('Failed to load data:', e);
        entries = [];
      }

      try {
        const settings = localStorage.getItem('identityForgeSettings');
        if (settings) {
          const parsed = JSON.parse(settings);
          notificationsEnabled = parsed.notificationsEnabled || false;
          morningReminderTime = parsed.morningReminderTime || '07:00';
          eveningReminderTime = parsed.eveningReminderTime || '21:00';
          console.log('Settings loaded successfully');
        }
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
    }
    
    // Notification functions
    async function toggleNotifications() {
      if (!notificationsEnabled) {
        // Request permission
        if (!("Notification" in window)) {
          showToast("This browser doesn't support notifications");
          return;
        }

        // Check if service worker is available (required for Samsung)
        if (!('serviceWorker' in navigator)) {
          showToast("Service workers not supported. Try Chrome or Samsung Internet.");
          return;
        }

        showToast("Requesting permission...");

        const permission = await Notification.requestPermission();

        if (permission === "granted") {
          // Wait for service worker to be ready
          try {
            const registration = await navigator.serviceWorker.ready;
            console.log('Service worker ready for notifications');

            notificationsEnabled = true;
            showToast("Notifications enabled! Tap 'Test' to verify.");
            saveToStorage();
            updateSettingsUI();
            scheduleNextNotifications();
          } catch (err) {
            console.error('Service worker issue:', err);
            showToast("Service worker error. Try refreshing the page.");
          }
        } else if (permission === "denied") {
          showToast("Permission denied. Enable in browser settings > Site settings > Notifications");
        } else {
          showToast("Permission dismissed. Try again.");
        }
      } else {
        // Disable notifications
        notificationsEnabled = false;
        showToast("Notifications disabled");
        saveToStorage();
        updateSettingsUI();
      }
    }
    
    function scheduleNextNotifications() {
      if (!notificationsEnabled) return;
      
      const now = new Date();
      const today = getTodayEntries();
      
      // Calculate next morning time
      const morningTime = new Date();
      const [mHour, mMin] = morningReminderTime.split(':');
      morningTime.setHours(parseInt(mHour), parseInt(mMin), 0, 0);
      
      // If morning time has passed today and morning is done, schedule for tomorrow
      if (morningTime < now || today.morning) {
        morningTime.setDate(morningTime.getDate() + 1);
      }
      
      // Calculate next evening time  
      const eveningTime = new Date();
      const [eHour, eMin] = eveningReminderTime.split(':');
      eveningTime.setHours(parseInt(eHour), parseInt(eMin), 0, 0);
      
      // If evening time has passed today or evening is done, schedule for tomorrow
      if (eveningTime < now || today.evening) {
        eveningTime.setDate(eveningTime.getDate() + 1);
      }
      
      // Schedule via service worker if available
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
          // Schedule morning notification if not done today
          if (!today.morning) {
            registration.active.postMessage({
              type: 'SCHEDULE_NOTIFICATION',
              title: 'üî• Morning Check-In',
              body: 'Your life matters. Your time is limited. Start your day with intention.',
              notifyAt: morningTime.getTime()
            });
            console.log('Morning notification scheduled for:', morningTime.toLocaleString());
          }
          
          // Schedule evening notification if morning is done but not evening
          if (today.morning && !today.evening) {
            registration.active.postMessage({
              type: 'SCHEDULE_NOTIFICATION',
              title: 'üåô Evening Reflection',
              body: 'Did you do what you said you\'d do? Complete your evening check-in.',
              notifyAt: eveningTime.getTime()
            });
            console.log('Evening notification scheduled for:', eveningTime.toLocaleString());
          }
        }).catch(err => {
          console.error('Failed to schedule notifications:', err);
        });
      }
    }
    
    function loadNotificationSettings() {
      if (document.getElementById('morningTime')) {
        document.getElementById('morningTime').value = morningReminderTime;
      }
      if (document.getElementById('eveningTime')) {
        document.getElementById('eveningTime').value = eveningReminderTime;
      }
      updateSettingsUI();
    }
    
    function updateSettingsUI() {
      const toggle = document.getElementById('notifToggle');
      const status = document.getElementById('notifStatus');
      const settings = document.getElementById('notifSettings');
      const hint = document.getElementById('notifPermissionHint');

      if (notificationsEnabled) {
        toggle.classList.add('selected');
        status.textContent = 'ON';
        settings.style.display = 'block';
        hint.textContent = 'Notifications are active';
      } else {
        toggle.classList.remove('selected');
        status.textContent = 'OFF';
        settings.style.display = 'none';
        hint.textContent = 'Click to enable browser notifications';
      }

      // Update app version display
      const versionElement = document.getElementById('appVersion');
      if (versionElement) {
        versionElement.textContent = APP_VERSION;
      }

      // Update last ground check display
      updateGroundLastCheck();

      // Update principles monthly average
      updatePrinciplesSettingsDisplay();
    }

    // Update principles display in settings
    function updatePrinciplesSettingsDisplay() {
      const principlesAvgEl = document.getElementById('principlesMonthlyAvg');
      if (!principlesAvgEl) return;

      const stats = getPrinciplesStats();
      if (stats.count === 0) {
        principlesAvgEl.textContent = 'Not tracked yet';
      } else {
        principlesAvgEl.innerHTML = `This month: <strong style="color: var(--accent);">${stats.avg}</strong> principles per day (avg)`;
      }
    }
    
    function saveNotificationSettings() {
      morningReminderTime = document.getElementById('morningTime').value;
      eveningReminderTime = document.getElementById('eveningTime').value;
      saveToStorage();
      saveSettingsToFirebase(); // Sync to Firebase
      scheduleNextNotifications(); // Reschedule with new times
      showToast('Reminder times saved. Notifications rescheduled for ' + morningReminderTime + ' and ' + eveningReminderTime);
    }
    
    async function testNotification() {
      if (!notificationsEnabled) {
        showToast('Enable notifications first');
        return;
      }

      if (!("Notification" in window)) {
        showToast("This browser doesn't support notifications");
        return;
      }

      if (Notification.permission !== "granted") {
        showToast("Notification permission not granted. Please enable in browser settings.");
        return;
      }

      // Check if service worker is ready (required for Samsung)
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.ready;
          if (!registration.active) {
            showToast("Service worker not active. Try refreshing the page.");
            return;
          }
        } catch (err) {
          showToast("Service worker error: " + err.message);
          return;
        }
      }

      showToast('Sending notification...');

      await sendNotification(
        'Test Notification',
        'Your notifications are working! You will receive reminders at your set times.',
        'settings'
      );

      // Delay the success message so user sees the notification first
      setTimeout(() => {
        showToast('Notification sent! Check your notification panel.');
      }, 500);
    }
    
    function startNotificationChecker() {
      // Check every 15 seconds for notifications
      notificationCheckInterval = setInterval(checkAndSendNotifications, 15000);
      // Check immediately
      checkAndSendNotifications();

      // Also check when app becomes visible (user returns to app)
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          console.log('App visible, checking for missed notifications...');
          checkAndSendNotifications();
        }
      });

      // Check when window gets focus
      window.addEventListener('focus', () => {
        console.log('Window focused, checking notifications...');
        checkAndSendNotifications();
      });
    }

    // Helper to parse time string to minutes since midnight
    function timeToMinutes(timeStr) {
      const [hours, mins] = timeStr.split(':').map(Number);
      return hours * 60 + mins;
    }

    // Helper to get today's date string for storage keys
    function getTodayDateString() {
      return new Date().toISOString().split('T')[0];
    }

    // Load last notification times from storage
    function getLastNotificationTime(type) {
      const key = `lastNotif_${type}_${getTodayDateString()}`;
      const stored = localStorage.getItem(key);
      return stored ? parseInt(stored, 10) : 0;
    }

    // Save last notification time to storage
    function setLastNotificationTime(type) {
      const key = `lastNotif_${type}_${getTodayDateString()}`;
      localStorage.setItem(key, Date.now().toString());
    }

    function checkAndSendNotifications() {
      if (!notificationsEnabled) return;
      if (!("Notification" in window) || Notification.permission !== "granted") return;

      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      const today = getTodayEntries();

      const morningMinutes = timeToMinutes(morningReminderTime);
      const eveningMinutes = timeToMinutes(eveningReminderTime);

      // Use a 5-minute window to catch notifications even if check was delayed
      const WINDOW_MINUTES = 5;

      // Check if we've already sent today (persisted in localStorage)
      const lastMorningNotif = getLastNotificationTime('morning');
      const lastEveningNotif = getLastNotificationTime('evening');
      const tenMinutesAgo = Date.now() - (10 * 60 * 1000);

      // Morning reminder - trigger if within window and not already sent today
      const morningDiff = currentMinutes - morningMinutes;
      if (morningDiff >= 0 && morningDiff <= WINDOW_MINUTES && !today.morning && lastMorningNotif < tenMinutesAgo) {
        console.log('Sending morning notification...');
        sendNotification(
          'Morning Check-In',
          'Your life matters. Your time is limited. Start your day with intention.',
          'morning'
        );
        setLastNotificationTime('morning');
      }

      // Evening reminder - trigger if within window and morning is done
      const eveningDiff = currentMinutes - eveningMinutes;
      if (eveningDiff >= 0 && eveningDiff <= WINDOW_MINUTES && today.morning && !today.evening && lastEveningNotif < tenMinutesAgo) {
        console.log('Sending evening notification...');
        sendNotification(
          'Evening Reflection',
          'Did you do what you said you\'d do? Complete your evening check-in.',
          'evening'
        );
        setLastNotificationTime('evening');
      }
    }
    
    async function sendNotification(title, body, type) {
      if (!("Notification" in window) || Notification.permission !== "granted") {
        console.log('Notification permission not granted');
        return;
      }

      // Use Service Worker for notifications (required for Samsung/Android)
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.ready;
          await registration.showNotification(title, {
            body: body,
            icon: '/icons/icon-192.png',
            badge: '/icons/icon-192.png',
            vibrate: [200, 100, 200, 100, 200],
            tag: 'identity-forge-' + type,
            requireInteraction: true,
            actions: [
              { action: 'open', title: 'Open App' },
              { action: 'dismiss', title: 'Dismiss' }
            ],
            data: { type: type }
          });
          console.log('Notification sent via Service Worker');
          return;
        } catch (err) {
          console.error('Service Worker notification failed:', err);
        }
      }

      // Fallback to direct notification (desktop browsers)
      try {
        const notification = new Notification(title, {
          body: body,
          icon: '/icons/icon-192.png',
          badge: '/icons/icon-192.png',
          requireInteraction: false,
          silent: false
        });

        notification.onclick = function() {
          window.focus();
          switchView(type);
          notification.close();
        };
      } catch (err) {
        console.error('Direct notification failed:', err);
      }
    }
    
    // Data management
    function exportData() {
      const dataStr = JSON.stringify({
        entries: entries,
        exportDate: new Date().toISOString(),
        version: '1.0'
      }, null, 2);
      
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `identity-forge-backup-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('Data exported successfully');
    }
    
    function confirmReset() {
      if (confirm('Are you absolutely sure? This will delete ALL your entries and cannot be undone.')) {
        if (confirm('Last chance. Delete everything?')) {
          entries = [];
          saveToStorage();
          updateStats();
          displayHistory();
          showToast('All data cleared');
        }
      }
    }
    
    // Toast notification
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ===== PRINCIPLES SECTION =====

    // Get today's principle (based on day of week)
    function getTodayPrinciple() {
      const dayOfWeek = new Date().getDay(); // 0 (Sun) to 6 (Sat)
      // Map: Sun=7, Mon=1, Tue=2, Wed=3, Thu=4, Fri=5, Sat=6
      const principleIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
      return principles[principleIndex];
    }

    // Load principles data from localStorage
    function loadPrinciplesData() {
      try {
        const data = localStorage.getItem('principlesData');
        if (data) {
          principlesData = JSON.parse(data);
          // Clean up entries older than 90 days
          const ninetyDaysAgo = new Date();
          ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
          principlesData.tracking = principlesData.tracking.filter(entry => {
            return new Date(entry.date) > ninetyDaysAgo;
          });
          savePrinciplesData();
          console.log(`Loaded ${principlesData.tracking.length} principles tracking entries`);
        }
      } catch (e) {
        console.error('Failed to load principles data:', e);
        principlesData = { tracking: [] };
      }
    }

    // Save principles data to localStorage
    function savePrinciplesData() {
      try {
        localStorage.setItem('principlesData', JSON.stringify(principlesData));
        savePrinciplesDataToFirebase(); // Sync to Firebase
      } catch (e) {
        console.error('Failed to save principles data:', e);
      }
    }

    // Save today's principles tracking (called from saveEvening)
    function savePrinciplesTracking() {
      const today = new Date().toISOString().split('T')[0];
      const reflection = document.getElementById('principlesReflection')?.value || '';

      // Remove existing entry for today
      principlesData.tracking = principlesData.tracking.filter(entry => entry.date !== today);

      // Add new entry
      principlesData.tracking.push({
        date: today,
        principlesHonored: [...selectedPrinciples],
        reflection: reflection
      });

      savePrinciplesData();
    }

    // Initialize principles UI (called on app load)
    function initPrinciplesUI() {
      // Set up morning principle reminder
      updateMorningPrincipleReminder();
      // Set up evening checkboxes
      initPrinciplesCheckboxes();
    }

    // Update morning principle reminder
    function updateMorningPrincipleReminder() {
      const todayPrinciple = getTodayPrinciple();
      const morningTextEl = document.getElementById('morningPrincipleText');
      const morningPromptEl = document.getElementById('morningPrinciplePrompt');

      if (morningTextEl) {
        morningTextEl.textContent = `Principle #${todayPrinciple.number}: ${todayPrinciple.full}`;
      }
      if (morningPromptEl) {
        morningPromptEl.textContent = todayPrinciple.prompt;
      }
    }

    // Initialize principles checkboxes in evening view
    function initPrinciplesCheckboxes() {
      const container = document.getElementById('principlesCheckboxList');
      if (!container) return;

      // Check if already tracked today
      const today = new Date().toISOString().split('T')[0];
      const todayEntry = principlesData.tracking.find(e => e.date === today);

      if (todayEntry) {
        selectedPrinciples = [...todayEntry.principlesHonored];
      }

      container.innerHTML = principles.map(p => {
        const isChecked = selectedPrinciples.includes(p.number);
        return `
          <div class="principle-checkbox-item ${isChecked ? 'checked' : ''}" onclick="togglePrincipleCheckbox(${p.number})">
            <div class="principle-checkbox">${isChecked ? '‚úì' : ''}</div>
            <div class="principle-checkbox-text">${p.number}. ${p.short}</div>
          </div>
        `;
      }).join('');
    }

    // Toggle principle checkbox
    function togglePrincipleCheckbox(principleNumber) {
      const index = selectedPrinciples.indexOf(principleNumber);
      if (index > -1) {
        selectedPrinciples.splice(index, 1);
      } else {
        selectedPrinciples.push(principleNumber);
      }
      initPrinciplesCheckboxes();
    }

    // Update the main Principles view
    function updatePrinciplesView() {
      updateTodayPrincipleCard();
      updatePrinciplesList();
      updateWeeklyTracking();
      updateMonthlyStats();
    }

    // Update Today's Principle card in Principles view
    function updateTodayPrincipleCard() {
      const todayPrinciple = getTodayPrinciple();
      const numberEl = document.getElementById('todayPrincipleNumber');
      const textEl = document.getElementById('todayPrincipleText');
      const statusEl = document.getElementById('todayPrincipleStatus');

      if (numberEl) numberEl.textContent = `Principle #${todayPrinciple.number}`;
      if (textEl) textEl.textContent = todayPrinciple.full;

      // Check if today was tracked
      const today = new Date().toISOString().split('T')[0];
      const todayEntry = principlesData.tracking.find(e => e.date === today);

      if (statusEl) {
        if (todayEntry) {
          const honored = todayEntry.principlesHonored.includes(todayPrinciple.number);
          if (honored) {
            statusEl.textContent = '‚úì Honored today';
            statusEl.classList.add('honored');
          } else {
            statusEl.textContent = 'Not honored today';
            statusEl.classList.remove('honored');
          }
        } else {
          statusEl.textContent = 'Check in evening';
          statusEl.classList.remove('honored');
        }
      }
    }

    // Update Principles list in Principles view
    function updatePrinciplesList() {
      const container = document.getElementById('principlesList');
      if (!container) return;

      const todayPrinciple = getTodayPrinciple();

      container.innerHTML = principles.map(p => `
        <div class="principle-item ${p.number === todayPrinciple.number ? 'today-highlight' : ''}">
          <div class="principle-number">${p.number}</div>
          <div class="principle-text">${p.full}</div>
        </div>
      `).join('');
    }

    // Update weekly tracking display
    function updateWeeklyTracking() {
      const container = document.getElementById('weeklyTracking');
      const weekScoreEl = document.getElementById('weekScoreValue');
      if (!container) return;

      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const today = new Date();
      const todayDayIndex = today.getDay();

      // Get last 7 days
      const weekDays = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        weekDays.push({
          date: date,
          dayName: days[date.getDay()],
          dateStr: date.toISOString().split('T')[0],
          isToday: i === 0
        });
      }

      let totalPrinciples = 0;

      container.innerHTML = weekDays.map(day => {
        const entry = principlesData.tracking.find(e => e.date === day.dateStr);
        let content = '‚Äî';

        if (entry && entry.principlesHonored.length > 0) {
          const principleNums = entry.principlesHonored.sort((a, b) => a - b);
          content = `<span class="honored">‚úì #${principleNums.join(', #')} (${principleNums.length})</span>`;
          totalPrinciples += principleNums.length;
        } else if (day.isToday) {
          content = 'Track in evening';
        }

        return `
          <div class="week-day-row ${day.isToday ? 'today' : ''}">
            <div class="week-day-name">${day.dayName}</div>
            <div class="week-day-principles">${content}</div>
          </div>
        `;
      }).join('');

      if (weekScoreEl) {
        weekScoreEl.textContent = totalPrinciples;
      }
    }

    // Update monthly stats display
    function updateMonthlyStats() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      // Filter entries for current month
      const monthEntries = principlesData.tracking.filter(entry => {
        const entryDate = new Date(entry.date);
        return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
      });

      if (monthEntries.length === 0) {
        document.getElementById('mostHonoredPrinciple').textContent = 'Not enough data';
        document.getElementById('leastHonoredPrinciple').textContent = 'Not enough data';
        document.getElementById('bestDayPrinciple').textContent = 'Not enough data';
        document.getElementById('avgPrinciplesDay').textContent = 'Not enough data';
        return;
      }

      // Count occurrences of each principle
      const counts = {};
      principles.forEach(p => counts[p.number] = 0);

      let bestDay = null;
      let bestDayCount = 0;
      let totalPrinciples = 0;

      monthEntries.forEach(entry => {
        const count = entry.principlesHonored.length;
        totalPrinciples += count;

        if (count > bestDayCount) {
          bestDayCount = count;
          bestDay = entry.date;
        }

        entry.principlesHonored.forEach(num => {
          counts[num]++;
        });
      });

      // Find most and least honored
      let mostHonored = { num: 1, count: 0 };
      let leastHonored = { num: 1, count: Infinity };

      Object.entries(counts).forEach(([num, count]) => {
        if (count > mostHonored.count) {
          mostHonored = { num: parseInt(num), count };
        }
        if (count < leastHonored.count) {
          leastHonored = { num: parseInt(num), count };
        }
      });

      // Update display
      const mostPrinciple = principles.find(p => p.number === mostHonored.num);
      const leastPrinciple = principles.find(p => p.number === leastHonored.num);

      document.getElementById('mostHonoredPrinciple').innerHTML =
        `<span class="highlight">#${mostHonored.num}</span> - ${mostPrinciple.short} (${mostHonored.count} times)`;

      document.getElementById('leastHonoredPrinciple').innerHTML =
        `<span class="highlight">#${leastHonored.num}</span> - ${leastPrinciple.short} (${leastHonored.count} times)`;

      if (bestDay) {
        const bestDate = new Date(bestDay);
        const formatted = bestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        document.getElementById('bestDayPrinciple').innerHTML =
          `${formatted} (<span class="highlight">${bestDayCount}/7</span> principles)`;
      }

      const avg = (totalPrinciples / monthEntries.length).toFixed(1);
      document.getElementById('avgPrinciplesDay').innerHTML =
        `<span class="highlight">${avg}</span> principles per day`;
    }

    // Get principles stats for settings
    function getPrinciplesStats() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      const monthEntries = principlesData.tracking.filter(entry => {
        const entryDate = new Date(entry.date);
        return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
      });

      if (monthEntries.length === 0) {
        return { avg: 0, count: 0 };
      }

      let total = 0;
      monthEntries.forEach(entry => {
        total += entry.principlesHonored.length;
      });

      return {
        avg: (total / monthEntries.length).toFixed(1),
        count: monthEntries.length
      };
    }

    // ===== END PRINCIPLES SECTION =====

    // Initialize on load
    // ===== GROUND CHECK (Reality Check) =====

    // Ground check questions data
    const groundQuestions = [
      // Category 1: Family & Love
      {
        question: "Did you grow up with both parents present and involved in your life?",
        yesResponse: "Millions grew up without one or both parents. You had stability, support, love from day one. That's wealth most never know.",
        noResponse: "That absence shaped you. Acknowledge it.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Do you have a healthy child in your life?",
        yesResponse: "Some parents bury their children. Yours is alive, healthy, watching you. Every day with him is a gift denied to many.",
        noResponse: "That longing is real. Honor it.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Is there someone who would drop everything to help you if you called right now?",
        yesResponse: "Most people die without experiencing that level of loyalty. You have it. When did you last tell them they matter?",
        noResponse: "That solitude teaches strength. But connection is still possible.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      // Category 2: Health & Body
      {
        question: "Can you walk, run, and move your body without assistance?",
        yesResponse: "Right now someone your age is in a wheelchair wishing they could do what you're avoiding. Your legs work. Use them.",
        noResponse: "Your body has limits. You're working with what you have. That takes courage.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Is your mind clear enough to read, think, plan, and make decisions?",
        yesResponse: "Mental clarity is priceless. People lose it to disease, trauma, age. You have it right now. Are you using it to build or to worry?",
        noResponse: "Mental fog is real. Seeking help is strength, not weakness.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Did you wake up today without chronic physical pain?",
        yesResponse: "That alone makes you wealthier than millions who suffer daily. You have a body that doesn't fight you. What are you waiting for?",
        noResponse: "Pain is a relentless teacher. You're still here. That's resilience.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Can you see clearly, hear sounds, and speak your thoughts?",
        yesResponse: "People would give everything for what you take for granted. You can witness beauty, hear your son laugh, speak your truth. Why aren't you?",
        noResponse: "You've adapted to limitation. That's a different kind of strength.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      // Category 3: Opportunity & Freedom
      {
        question: "Were you born in a country without war, persecution, or violent oppression?",
        yesResponse: "Billions live in fear, violence, chaos. You were born into peace and freedom. That's not luck‚Äîthat's massive privilege. What are you building with it?",
        noResponse: "You know what instability costs. That knowledge is power.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Did you receive an education that taught you to read, write, think, and learn independently?",
        yesResponse: "Most of humanity never gets that. You can teach yourself anything. That's a superpower. Are you expanding or stagnating?",
        noResponse: "You've taught yourself despite the gaps. That resourcefulness matters.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Have you traveled beyond your home country and experienced other cultures?",
        yesResponse: "You're a citizen of the world while others never leave their village. You've seen perspective most never get. What are you doing with it?",
        noResponse: "Your world is smaller but no less rich. Depth beats breadth.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Can you choose how you earn money and spend your time?",
        yesResponse: "That's not normal‚Äîthat's extraordinary. You're not forced into labor. You choose your path. So why are you choosing to play small?",
        noResponse: "Limited freedom sharpens focus. You work with what you control.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      // Category 4: Resources & Security
      {
        question: "Do you have access to clean water whenever you want it?",
        yesResponse: "Half the world doesn't. You turn a tap and life flows out. Basic survival isn't your struggle. What worthy problem are you solving instead?",
        noResponse: "Scarcity teaches gratitude. You know what matters.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Do you have a safe, warm place to sleep tonight?",
        yesResponse: "People sleep on streets, in war zones, in fear. You have shelter. Safety. Peace. What are you doing with that security?",
        noResponse: "Instability is exhausting. You're surviving it. That takes everything.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Do you have enough food that you never go to bed hungry?",
        yesResponse: "Hunger is not your battle. You have the luxury of choosing harder problems. Are you choosing worthy ones?",
        noResponse: "Food insecurity is invisible suffering. You're navigating it.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Do you have daily access to the internet and unlimited information?",
        yesResponse: "You carry the entire library of human knowledge in your pocket. Billions don't. What are you learning? What are you creating?",
        noResponse: "You find ways without easy access. That's resourcefulness.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      }
    ];

    // Ground check state
    let groundState = {
      mode: null,
      questionIndices: [],
      currentIndex: 0,
      currentAnswer: null,
      responses: [],
      inProgress: false
    };

    // Initialize Ground view
    function initGroundView() {
      loadGroundData();
      updateGroundLastCheck();
      checkForResume();
      showGroundScreen('groundModeSelect');
    }

    // Load ground data from localStorage
    function loadGroundData() {
      try {
        const data = localStorage.getItem('groundCheckData');
        if (data) {
          return JSON.parse(data);
        }
      } catch (e) {
        console.error('Failed to load ground data:', e);
      }
      return null;
    }

    // Save ground data to localStorage
    function saveGroundData(data) {
      try {
        localStorage.setItem('groundCheckData', JSON.stringify(data));
      } catch (e) {
        console.error('Failed to save ground data:', e);
      }
    }

    // Save in-progress state
    function saveGroundProgress() {
      try {
        localStorage.setItem('groundCheckProgress', JSON.stringify(groundState));
      } catch (e) {
        console.error('Failed to save ground progress:', e);
      }
    }

    // Load in-progress state
    function loadGroundProgress() {
      try {
        const data = localStorage.getItem('groundCheckProgress');
        if (data) {
          return JSON.parse(data);
        }
      } catch (e) {
        console.error('Failed to load ground progress:', e);
      }
      return null;
    }

    // Clear in-progress state
    function clearGroundProgress() {
      localStorage.removeItem('groundCheckProgress');
    }

    // Update last check display
    function updateGroundLastCheck() {
      const data = loadGroundData();
      const lastCheckDisplay = document.getElementById('groundLastCheckDisplay');
      const settingsLastCheck = document.getElementById('lastGroundCheck');

      if (data && data.lastCompleted) {
        const date = new Date(data.lastCompleted);
        const formatted = date.toLocaleDateString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
        if (lastCheckDisplay) lastCheckDisplay.textContent = `Last check: ${formatted}`;
        if (settingsLastCheck) settingsLastCheck.textContent = formatted;
      } else {
        if (lastCheckDisplay) lastCheckDisplay.textContent = 'Last check: Never';
        if (settingsLastCheck) settingsLastCheck.textContent = 'Never completed';
      }
    }

    // Check if there's a resumable session
    function checkForResume() {
      const progress = loadGroundProgress();
      const resumeOption = document.getElementById('groundResumeOption');

      if (progress && progress.inProgress && progress.responses.length > 0) {
        resumeOption.style.display = 'block';
      } else {
        resumeOption.style.display = 'none';
      }
    }

    // Show a specific ground screen
    function showGroundScreen(screenId) {
      const screens = document.querySelectorAll('.ground-screen');
      screens.forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    // Start ground check
    function startGroundCheck(mode) {
      groundState = {
        mode: mode,
        questionIndices: [],
        currentIndex: 0,
        currentAnswer: null,
        responses: [],
        inProgress: true
      };

      if (mode === 'quick') {
        // Random 5 questions
        const indices = [];
        while (indices.length < 5) {
          const rand = Math.floor(Math.random() * groundQuestions.length);
          if (!indices.includes(rand)) {
            indices.push(rand);
          }
        }
        groundState.questionIndices = indices;
      } else {
        // All 15 questions in order
        groundState.questionIndices = groundQuestions.map((_, i) => i);
      }

      clearGroundProgress();
      saveGroundProgress();
      showQuestion();
    }

    // Resume ground check
    function resumeGroundCheck() {
      const progress = loadGroundProgress();
      if (progress && progress.inProgress) {
        groundState = progress;
        showQuestion();
      } else {
        showToast('No session to resume');
        checkForResume();
      }
    }

    // Show current question
    function showQuestion() {
      showGroundScreen('groundQuestion');

      const total = groundState.questionIndices.length;
      const current = groundState.currentIndex + 1;
      const qIndex = groundState.questionIndices[groundState.currentIndex];
      const q = groundQuestions[qIndex];

      // Update progress
      document.getElementById('groundProgressText').textContent = `${current} / ${total}`;
      document.getElementById('groundProgressFill').style.width = `${(current / total) * 100}%`;

      // Update question
      document.getElementById('groundQuestionText').textContent = q.question;

      // Reset answer state
      groundState.currentAnswer = null;
      document.getElementById('groundYes').classList.remove('selected');
      document.getElementById('groundNo').classList.remove('selected');
      document.getElementById('groundResponseArea').style.display = 'none';
      document.getElementById('groundCommitmentInput').value = '';
      document.getElementById('groundNextBtn').style.display = 'none';
    }

    // Handle yes/no answer
    function groundAnswer(answer) {
      groundState.currentAnswer = answer;

      const qIndex = groundState.questionIndices[groundState.currentIndex];
      const q = groundQuestions[qIndex];

      // Update button states
      document.getElementById('groundYes').classList.toggle('selected', answer === 'yes');
      document.getElementById('groundNo').classList.toggle('selected', answer === 'no');

      // Show response area
      document.getElementById('groundResponseArea').style.display = 'block';

      if (answer === 'yes') {
        document.getElementById('groundTruthText').textContent = q.yesResponse;
        document.getElementById('groundCommitmentLabel').textContent = q.yesPrompt;
        document.getElementById('groundCommitmentInput').placeholder = 'I will...';
        document.getElementById('groundCommitmentInput').required = true;
        document.getElementById('groundNextBtn').style.display = 'none';

        // Add input listener for required field
        const input = document.getElementById('groundCommitmentInput');
        input.oninput = function() {
          document.getElementById('groundNextBtn').style.display = this.value.trim() ? 'block' : 'none';
        };
      } else {
        document.getElementById('groundTruthText').textContent = q.noResponse;
        document.getElementById('groundCommitmentLabel').textContent = q.noPrompt;
        document.getElementById('groundCommitmentInput').placeholder = '(Optional)';
        document.getElementById('groundCommitmentInput').required = false;
        document.getElementById('groundNextBtn').style.display = 'block';

        // Remove required input listener
        document.getElementById('groundCommitmentInput').oninput = null;
      }
    }

    // Go to next question
    function groundNext() {
      const qIndex = groundState.questionIndices[groundState.currentIndex];
      const q = groundQuestions[qIndex];
      const commitment = document.getElementById('groundCommitmentInput').value.trim();

      // Validate if yes answer
      if (groundState.currentAnswer === 'yes' && !commitment) {
        showToast('Please enter your commitment');
        return;
      }

      // Save response
      groundState.responses.push({
        questionIndex: qIndex,
        question: q.question,
        answer: groundState.currentAnswer,
        commitment: commitment || null
      });

      // Save progress
      groundState.currentIndex++;
      saveGroundProgress();

      // Check if complete
      if (groundState.currentIndex >= groundState.questionIndices.length) {
        completeGroundCheck();
      } else {
        showQuestion();
      }
    }

    // Exit ground check (save progress)
    function exitGroundCheck() {
      if (groundState.inProgress && groundState.responses.length > 0) {
        saveGroundProgress();
        showToast('Progress saved. You can resume later.');
      }
      showGroundScreen('groundModeSelect');
      checkForResume();
    }

    // Complete ground check
    function completeGroundCheck() {
      groundState.inProgress = false;
      clearGroundProgress();

      // Count wealth (yes answers)
      const wealthCount = groundState.responses.filter(r => r.answer === 'yes').length;
      const totalQuestions = groundState.questionIndices.length;

      // Save completed data
      const data = {
        lastCompleted: new Date().toISOString(),
        mode: groundState.mode,
        totalWealth: wealthCount,
        responses: groundState.responses
      };
      saveGroundData(data);

      // Update displays
      updateGroundLastCheck();

      // Show summary
      document.getElementById('groundWealthCount').textContent = wealthCount;
      document.getElementById('groundSummaryWealth').textContent = wealthCount;
      document.getElementById('groundSummaryTotal').textContent = totalQuestions;
      document.getElementById('groundSummaryDate').textContent = new Date().toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });

      showGroundScreen('groundSummary');
    }

    // View commitments
    function viewGroundCommitments() {
      const data = loadGroundData();
      const list = document.getElementById('groundCommitmentsList');

      if (!data || !data.responses) {
        list.innerHTML = '<p style="color: var(--text-dim);">No commitments recorded.</p>';
        showGroundScreen('groundCommitments');
        return;
      }

      const commitments = data.responses.filter(r => r.answer === 'yes' && r.commitment);

      if (commitments.length === 0) {
        list.innerHTML = '<p style="color: var(--text-dim);">No commitments recorded.</p>';
      } else {
        list.innerHTML = commitments.map(c => `
          <div class="ground-commitment-item">
            <div class="ground-commitment-q">${c.question}</div>
            <div class="ground-commitment-a">${c.commitment}</div>
          </div>
        `).join('');
      }

      showGroundScreen('groundCommitments');
    }

    // Show ground summary
    function showGroundSummary() {
      showGroundScreen('groundSummary');
    }

    // Reset ground check
    function resetGroundCheck() {
      groundState = {
        mode: null,
        questionIndices: [],
        currentIndex: 0,
        currentAnswer: null,
        responses: [],
        inProgress: false
      };
      clearGroundProgress();
      showGroundScreen('groundModeSelect');
      checkForResume();
    }

    // ===== END GROUND CHECK =====

    // Initialize app - data loading is handled by Firebase auth state listener
    // loadFromStorage() is called automatically when user is not signed in or as fallback
    init();
  </script>
</body>
</html>
