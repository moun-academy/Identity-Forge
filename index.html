<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ff9500" />
  <meta name="description" content="A sleek interface for crafting and tracking your digital identity goals." />
  <title>Identity Forge</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest" />

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png" />

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png" />

  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Identity Forge" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg-dark: #0a0a0a;
      --bg-card: #151515;
      --bg-elevated: #1a1a1a;
      --accent: #ff9500;
      --accent-hover: #ffa733;
      --accent-dim: #ff950033;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-dim: #666666;
      --border: #2a2a2a;
      --success: #00ff88;
      --warning: #ffaa00;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
      --shadow-accent: 0 8px 24px rgba(255, 59, 48, 0.25);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
      background: var(--bg-dark);
      background-image:
        radial-gradient(circle at 20% 50%, rgba(255, 59, 48, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 59, 48, 0.03) 0%, transparent 50%);
      background-attachment: fixed;
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding: 0;
      margin: 0;
    }
    
    .app-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      padding: 60px 20px 50px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 40px;
      position: relative;
      background: linear-gradient(180deg, rgba(255, 59, 48, 0.03) 0%, transparent 100%);
    }

    .header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      border-radius: 2px;
    }

    .header h1 {
      font-size: 2.8rem;
      font-weight: 900;
      letter-spacing: -0.04em;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--accent) 0%, #ffb347 50%, #ffd180 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 40px rgba(255, 59, 48, 0.3);
      animation: titleGlow 3s ease-in-out infinite alternate;
    }

    @keyframes titleGlow {
      from { filter: brightness(1); }
      to { filter: brightness(1.1); }
    }

    .header .tagline {
      color: var(--text-secondary);
      font-size: 1.05rem;
      font-weight: 500;
      line-height: 1.6;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 40px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(21, 21, 21, 0.8) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: rgba(255, 59, 48, 0.3);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), #ffb347, var(--accent));
      background-size: 200% 100%;
      animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
      0%, 100% { background-position: 0% 0%; }
      50% { background-position: 100% 0%; }
    }
    
    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-dim);
      margin-bottom: 8px;
      font-weight: 700;
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 900;
      color: var(--accent);
      line-height: 1;
      margin-bottom: 4px;
    }
    
    .stat-trend {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .nav-tabs {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-bottom: 32px;
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(21, 21, 21, 0.95) 100%);
      padding: 8px;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }

    .nav-icon {
      display: none;
    }

    .nav-tab {
      flex: 1;
      padding: 16px 20px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 700;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      position: relative;
    }

    .nav-tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 50%;
      height: 2px;
      background: var(--accent);
      transition: transform 0.3s ease;
    }

    .nav-tab:hover {
      color: var(--text-primary);
      background: var(--bg-elevated);
    }

    .nav-tab:hover::after {
      transform: translateX(-50%) scaleX(1);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: var(--bg-dark);
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
    }

    .nav-tab.active::after {
      display: none;
    }
    
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section {
      background: linear-gradient(135deg, rgba(21, 21, 21, 0.95) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at top right, rgba(255, 59, 48, 0.05), transparent 50%);
      pointer-events: none;
    }

    .section:hover {
      border-color: rgba(255, 59, 48, 0.2);
      box-shadow: var(--shadow-lg);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .section-icon {
      font-size: 1.5rem;
    }
    
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-primary);
    }
    
    .truth-card {
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.95) 100%);
      border-left: 4px solid var(--accent);
      padding: 28px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .truth-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(255, 59, 48, 0.1), transparent 70%);
      pointer-events: none;
    }

    .truth-card:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
      border-left-color: var(--accent-hover);
    }
    
    .truth-text {
      font-size: 1.3rem;
      font-weight: 700;
      line-height: 1.4;
      margin-bottom: 16px;
      color: var(--text-primary);
    }
    
    .truth-question {
      font-size: 1rem;
      color: var(--text-secondary);
      font-style: italic;
      line-height: 1.6;
    }
    
    .question-block {
      margin-bottom: 32px;
    }
    
    .question-label {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
      display: block;
    }
    
    .question-hint {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 16px;
      font-style: italic;
    }
    
    .input-text,
    .input-textarea {
      width: 100%;
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.8) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 18px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .input-text:hover,
    .input-textarea:hover {
      border-color: rgba(255, 59, 48, 0.3);
    }

    .input-text:focus,
    .input-textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-dark);
      box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.1), inset 0 2px 4px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }
    
    .input-textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.6;
    }
    
    .slider-group {
      margin-bottom: 24px;
    }
    
    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .slider-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .slider-value {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--accent);
    }
    
    .slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--bg-elevated), rgba(26, 26, 26, 0.9));
      outline: none;
      -webkit-appearance: none;
      cursor: pointer;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
    }

    .slider:hover {
      background: linear-gradient(90deg, rgba(26, 26, 26, 0.95), var(--bg-elevated));
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(255, 59, 48, 0.4);
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.25);
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.6);
    }

    .slider::-webkit-slider-thumb:active {
      transform: scale(1.1);
    }

    .slider::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(255, 59, 48, 0.4);
      transition: all 0.3s ease;
    }

    .slider::-moz-range-thumb:hover {
      transform: scale(1.25);
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.6);
    }
    
    .btn {
      width: 100%;
      padding: 18px 32px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: var(--bg-dark);
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 24px;
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      background: linear-gradient(135deg, var(--accent-hover) 0%, #ffd180 100%);
      transform: translateY(-3px);
      box-shadow: var(--shadow-accent);
    }

    .btn:active {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.2);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: var(--bg-elevated);
      border-radius: 24px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 20px;
      border: 1px solid transparent;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .status-indicator.complete {
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 255, 136, 0.1) 100%);
      color: var(--success);
      border-color: rgba(0, 255, 136, 0.2);
    }

    .status-indicator.pending {
      background: linear-gradient(135deg, rgba(255, 170, 0, 0.15) 0%, rgba(255, 170, 0, 0.1) 100%);
      color: var(--warning);
      border-color: rgba(255, 170, 0, 0.2);
    }
    
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .history-item {
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .history-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, var(--accent), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .history-item:hover {
      transform: translateX(8px);
      border-color: rgba(255, 59, 48, 0.4);
      box-shadow: var(--shadow-md);
    }

    .history-item:hover::before {
      opacity: 1;
    }
    
    .history-date {
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 12px;
      font-size: 0.95rem;
    }
    
    .history-content {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    .history-content strong {
      color: var(--text-primary);
      display: block;
      margin-top: 12px;
      margin-bottom: 4px;
    }
    
    .history-scores {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 0.85rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, var(--success) 0%, #00cc6f 100%);
      color: var(--bg-dark);
      padding: 18px 28px;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 8px 32px rgba(0, 255, 136, 0.4);
      transform: translateX(400px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }

    .toast.show {
      transform: translateX(0);
      animation: toastBounce 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes toastBounce {
      0% { transform: translateX(400px); }
      60% { transform: translateX(-10px); }
      80% { transform: translateX(5px); }
      100% { transform: translateX(0); }
    }
    
    .yes-no-group {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .yes-no-btn {
      flex: 1;
      padding: 16px;
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .yes-no-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 59, 48, 0.1);
      transform: translate(-50%, -50%);
      transition: width 0.3s ease, height 0.3s ease;
    }

    .yes-no-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .yes-no-btn:hover::before {
      width: 100%;
      height: 100%;
    }

    .yes-no-btn.selected {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      border-color: var(--accent);
      color: var(--bg-dark);
      transform: scale(1.02);
      box-shadow: 0 4px 16px rgba(255, 59, 48, 0.4);
    }
    
    @media (max-width: 640px) {
      .app-container {
        padding: 12px;
      }

      .header {
        padding: 40px 12px 30px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .section {
        padding: 24px 20px;
      }

      .stats-bar {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        grid-template-columns: repeat(3, 1fr);
      }

      .nav-tab {
        font-size: 0.8rem;
        padding: 12px 8px;
      }

      .nav-icon {
        display: inline;
        margin-right: 2px;
      }
    }

    /* Ground/Reality Check Styles */
    .ground-container {
      position: relative;
      min-height: 400px;
    }

    .ground-screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .ground-screen.active {
      display: block;
    }

    .ground-progress {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding: 16px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .ground-progress-text {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-secondary);
    }

    .ground-progress-bar {
      flex: 1;
      height: 6px;
      background: var(--bg-dark);
      border-radius: 3px;
      margin: 0 16px;
      overflow: hidden;
    }

    .ground-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .ground-question-text {
      font-size: 1.3rem;
      font-weight: 700;
      line-height: 1.5;
      color: var(--text-primary);
      margin-bottom: 32px;
      text-align: center;
    }

    .ground-yes-no {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .ground-yes-no .yes-no-btn {
      flex: 1;
      padding: 20px;
      font-size: 1.1rem;
      min-height: 60px;
    }

    .ground-response {
      animation: fadeIn 0.3s ease;
    }

    .ground-truth {
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.05) 100%);
      border-left: 4px solid var(--accent);
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text-primary);
    }

    .ground-commitment-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
      display: block;
    }

    .ground-mode-card {
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
    }

    .ground-mode-card:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
    }

    .ground-mode-card:active {
      transform: translateY(-2px);
    }

    .ground-mode-title {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .ground-mode-desc {
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    .ground-summary {
      text-align: center;
      padding: 20px 0;
    }

    .ground-summary-count {
      font-size: 3rem;
      font-weight: 900;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .ground-summary-label {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .ground-summary-message {
      font-size: 1.1rem;
      line-height: 1.8;
      color: var(--text-primary);
      margin-bottom: 32px;
      padding: 24px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .ground-summary-message strong {
      color: var(--accent);
      display: block;
      margin: 16px 0 8px;
    }

    .ground-meta {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 24px;
    }

    .ground-btn-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ground-btn-secondary {
      width: 100%;
      padding: 16px;
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .ground-btn-secondary:hover {
      border-color: var(--accent);
      background: var(--bg-dark);
    }

    .ground-exit-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 0.9rem;
      cursor: pointer;
      padding: 8px 16px;
      transition: color 0.2s ease;
    }

    .ground-exit-btn:hover {
      color: var(--text-primary);
    }

    .ground-last-check {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 24px;
      text-align: center;
    }

    .ground-commitments-list {
      text-align: left;
      max-height: 400px;
      overflow-y: auto;
    }

    .ground-commitment-item {
      padding: 16px;
      background: var(--bg-elevated);
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 3px solid var(--accent);
    }

    .ground-commitment-q {
      font-size: 0.85rem;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    .ground-commitment-a {
      font-size: 1rem;
      color: var(--text-primary);
    }

    /* Principles Section Styles */
    .principles-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .principles-header h2 {
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--accent);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .principles-header .tagline {
      font-size: 1rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    .today-principle-card {
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.15) 0%, rgba(255, 149, 0, 0.05) 100%);
      border: 2px solid var(--accent);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
    }

    .today-principle-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, rgba(255, 149, 0, 0.2), transparent 70%);
      pointer-events: none;
    }

    .today-principle-label {
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--accent);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .today-principle-number {
      font-size: 1rem;
      font-weight: 800;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .today-principle-text {
      font-size: 1.2rem;
      font-weight: 600;
      line-height: 1.6;
      color: var(--text-primary);
      margin-bottom: 20px;
    }

    .today-principle-status {
      display: inline-block;
      padding: 8px 16px;
      background: var(--bg-dark);
      border-radius: 20px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .today-principle-status.honored {
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 255, 136, 0.1) 100%);
      color: var(--success);
      border-color: rgba(0, 255, 136, 0.3);
    }

    .principles-list {
      margin-bottom: 32px;
    }

    .principle-item {
      display: flex;
      gap: 16px;
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .principle-item:hover {
      border-color: rgba(255, 149, 0, 0.3);
      transform: translateX(4px);
    }

    .principle-item.today-highlight {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.02) 100%);
    }

    .principle-number {
      font-size: 1.4rem;
      font-weight: 900;
      color: var(--accent);
      min-width: 32px;
    }

    .principle-text {
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text-primary);
    }

    .weekly-tracking {
      margin-bottom: 32px;
    }

    .weekly-tracking-title {
      font-size: 0.9rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .week-day-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 12px 16px;
      background: var(--bg-elevated);
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
    }

    .week-day-row.today {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.02) 100%);
    }

    .week-day-name {
      font-weight: 700;
      color: var(--text-primary);
      min-width: 50px;
    }

    .week-day-principles {
      font-size: 0.9rem;
      color: var(--text-secondary);
      flex: 1;
      text-align: right;
    }

    .week-day-principles .honored {
      color: var(--success);
    }

    .week-score {
      text-align: center;
      padding: 16px;
      background: var(--bg-dark);
      border-radius: 12px;
      margin-top: 16px;
      border: 1px solid var(--border);
    }

    .week-score-value {
      font-size: 2rem;
      font-weight: 900;
      color: var(--accent);
    }

    .week-score-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .monthly-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .monthly-stat-card {
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .monthly-stat-label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    .monthly-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.4;
    }

    .monthly-stat-value .highlight {
      color: var(--accent);
    }

    /* Principles checkboxes in evening */
    .principles-checkbox-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .principle-checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-elevated);
      border-radius: 10px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .principle-checkbox-item:hover {
      border-color: rgba(255, 149, 0, 0.4);
      background: var(--bg-dark);
    }

    .principle-checkbox-item.checked {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 255, 136, 0.02) 100%);
    }

    .principle-checkbox {
      width: 24px;
      height: 24px;
      min-width: 24px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      color: transparent;
      font-size: 14px;
    }

    .principle-checkbox-item.checked .principle-checkbox {
      background: var(--success);
      border-color: var(--success);
      color: var(--bg-dark);
    }

    .principle-checkbox-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .principle-checkbox-item.checked .principle-checkbox-text {
      color: var(--text-primary);
    }

    /* Morning principle reminder */
    .morning-principle-reminder {
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.03) 100%);
      border-left: 4px solid var(--accent);
      padding: 20px;
      border-radius: 12px;
      margin-top: 8px;
    }

    .morning-principle-label {
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .morning-principle-text {
      font-size: 1rem;
      color: var(--text-primary);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .morning-principle-prompt {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    @media (max-width: 640px) {
      .monthly-stats {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        grid-template-columns: repeat(4, 1fr);
      }

      .today-principle-card {
        padding: 20px;
      }

      .today-principle-text {
        font-size: 1.1rem;
      }
    }

    /* ===== EXECUTION & PRESENCE TRACKING STYLES ===== */

    /* Live Scores Widget */
    .live-scores-widget {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 24px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(21, 21, 21, 0.95) 0%, rgba(26, 26, 26, 0.9) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow-sm);
    }

    .score-widget {
      text-align: center;
      padding: 12px 8px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
    }

    .score-widget:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
      box-shadow: var(--shadow-md);
    }

    .score-widget-value {
      font-size: 1.8rem;
      font-weight: 900;
      line-height: 1;
      margin-bottom: 4px;
    }

    .score-widget-label {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .score-widget-indicator {
      font-size: 0.75rem;
    }

    /* Score color classes */
    .score-red { color: #ff4444; }
    .score-orange { color: #ff9500; }
    .score-yellow { color: #ffcc00; }
    .score-green { color: #00ff88; }
    .score-blue { color: #00bbff; }

    /* Floating Action Button */
    .fab-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 900;
    }

    .fab-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      border: none;
      color: var(--bg-dark);
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(255, 149, 0, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fabPulse 10s ease-in-out infinite;
    }

    .fab-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 28px rgba(255, 149, 0, 0.5);
    }

    .fab-btn:active {
      transform: scale(0.95);
    }

    @keyframes fabPulse {
      0%, 90%, 100% { box-shadow: 0 4px 20px rgba(255, 149, 0, 0.4); }
      95% { box-shadow: 0 4px 30px rgba(255, 149, 0, 0.7); }
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-primary);
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      color: var(--text-primary);
      background: var(--bg-elevated);
    }

    /* Presence Check Options */
    .presence-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 20px 0;
    }

    .presence-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .presence-option:hover {
      border-color: var(--accent);
      background: var(--bg-dark);
    }

    .presence-option.selected {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 255, 136, 0.02) 100%);
    }

    .presence-checkbox {
      width: 24px;
      height: 24px;
      min-width: 24px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      color: transparent;
      font-size: 14px;
    }

    .presence-option.selected .presence-checkbox {
      background: var(--success);
      border-color: var(--success);
      color: var(--bg-dark);
    }

    .presence-option-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    .presence-option.selected .presence-option-text {
      color: var(--text-primary);
    }

    /* Time Blocks */
    .time-blocks-container {
      margin-top: 20px;
    }

    .time-block-item {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      position: relative;
      transition: all 0.2s ease;
    }

    .time-block-item:hover {
      border-color: rgba(255, 149, 0, 0.3);
    }

    .time-block-item.completed {
      border-left: 4px solid var(--success);
    }

    .time-block-item.in-progress {
      border-left: 4px solid var(--warning);
      background: linear-gradient(135deg, rgba(255, 170, 0, 0.1) 0%, rgba(255, 170, 0, 0.02) 100%);
    }

    .time-block-item.skipped {
      border-left: 4px solid #ff4444;
      opacity: 0.7;
    }

    .time-block-item.upcoming {
      border-left: 4px solid var(--text-dim);
    }

    .time-block-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .time-block-status-icon {
      font-size: 1.2rem;
    }

    .time-block-time {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--accent);
    }

    .time-block-activity {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .time-block-intention {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    .time-block-status {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
    }

    .time-block-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .time-block-btn {
      padding: 8px 16px;
      font-size: 0.8rem;
      font-weight: 700;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-dark);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-block-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .time-block-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-dark);
    }

    .time-block-btn.primary:hover {
      background: var(--accent-hover);
    }

    /* Add Time Block Form */
    .add-block-form {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      display: none;
    }

    .add-block-form.active {
      display: block;
      animation: fadeIn 0.2s ease;
    }

    .time-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .time-input-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .time-input-group input[type="time"] {
      width: 100%;
      padding: 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 1rem;
    }

    .time-input-group input[type="time"]:focus {
      outline: none;
      border-color: var(--accent);
    }

    .add-block-btns {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .add-block-btn {
      flex: 1;
      padding: 12px;
      font-size: 0.9rem;
      font-weight: 700;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .add-block-btn.save {
      background: var(--accent);
      color: var(--bg-dark);
    }

    .add-block-btn.save:hover {
      background: var(--accent-hover);
    }

    .add-block-btn.cancel {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .add-block-btn.cancel:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    /* Execution Score Bar */
    .execution-score-bar {
      margin-bottom: 24px;
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .execution-score-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .execution-score-label {
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
    }

    .execution-score-value {
      font-size: 1.2rem;
      font-weight: 900;
    }

    .execution-progress {
      height: 10px;
      background: var(--bg-dark);
      border-radius: 5px;
      overflow: hidden;
    }

    .execution-progress-fill {
      height: 100%;
      border-radius: 5px;
      transition: width 0.3s ease;
    }

    /* Presence Log */
    .presence-log {
      max-height: 300px;
      overflow-y: auto;
    }

    .presence-log-item {
      padding: 14px 16px;
      background: var(--bg-elevated);
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 3px solid var(--accent);
    }

    .presence-log-time {
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-bottom: 6px;
    }

    .presence-log-thought {
      font-size: 0.95rem;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .presence-log-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .presence-tag {
      font-size: 0.7rem;
      padding: 4px 8px;
      background: var(--bg-dark);
      border-radius: 12px;
      color: var(--text-secondary);
    }

    .presence-tag.positive {
      background: rgba(0, 255, 136, 0.15);
      color: var(--success);
    }

    /* Streaks Display */
    .streaks-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .streak-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .streak-icon {
      font-size: 1.5rem;
    }

    .streak-info {
      flex: 1;
    }

    .streak-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .streak-best {
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .streak-value {
      font-size: 1.4rem;
      font-weight: 900;
      color: var(--accent);
    }

    .streak-value span {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* Patterns View */
    .pattern-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .pattern-card-title {
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      margin-bottom: 16px;
    }

    .pattern-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .pattern-row:last-child {
      border-bottom: none;
    }

    .pattern-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .pattern-value {
      font-size: 0.9rem;
      font-weight: 700;
    }

    .pattern-insight {
      margin-top: 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.03) 100%);
      border-left: 4px solid var(--accent);
      border-radius: 8px;
      font-size: 0.9rem;
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* Level Badge */
    .level-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--bg-dark);
    }

    /* Achievement Badges */
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .achievement-item {
      padding: 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      text-align: center;
      transition: all 0.2s ease;
    }

    .achievement-item.earned {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.02) 100%);
    }

    .achievement-item.locked {
      opacity: 0.5;
    }

    .achievement-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .achievement-name {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .achievement-desc {
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    /* Evening Review Sections */
    .review-summary {
      background: var(--bg-elevated);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    .review-summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .review-summary-title {
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
    }

    .review-summary-score {
      font-size: 1.1rem;
      font-weight: 900;
    }

    .review-block-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .review-block-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-dark);
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .review-block-status {
      font-size: 1rem;
    }

    .review-block-time {
      color: var(--text-dim);
      min-width: 50px;
    }

    .review-block-activity {
      color: var(--text-primary);
      flex: 1;
    }

    /* Urge List */
    .urge-list {
      margin: 16px 0;
    }

    .urge-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-dark);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 0.85rem;
    }

    .urge-time {
      color: var(--text-dim);
      min-width: 45px;
    }

    .urge-text {
      color: var(--text-primary);
      flex: 1;
    }

    /* Mobile responsive for tracking */
    @media (max-width: 640px) {
      .live-scores-widget {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        padding: 12px;
      }

      .score-widget {
        padding: 10px 6px;
      }

      .score-widget-value {
        font-size: 1.4rem;
      }

      .score-widget-label {
        font-size: 0.6rem;
      }

      .fab-container {
        bottom: 20px;
        right: 20px;
      }

      .fab-btn {
        width: 56px;
        height: 56px;
        font-size: 1.3rem;
      }

      .achievements-grid {
        grid-template-columns: 1fr;
      }

      .time-inputs {
        grid-template-columns: 1fr;
      }
    }

    /* ===== END EXECUTION & PRESENCE TRACKING STYLES ===== */
  </style>
</head>
<body>
  <div class="app-container">
    <header class="header">
      <h1>IDENTITY FORGE</h1>
      <p class="tagline">Your life matters. Your time is limited. Your future self is watching.</p>
    </header>
    
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-label">Vitality</div>
        <div class="stat-value" id="vitalityScore">--</div>
        <div class="stat-trend" id="vitalityTrend">Not yet tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Courage</div>
        <div class="stat-value" id="courageScore">--</div>
        <div class="stat-trend" id="courageTrend">Not yet tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Meaning</div>
        <div class="stat-value" id="meaningScore">--</div>
        <div class="stat-trend" id="meaningTrend">Not yet tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Streak</div>
        <div class="stat-value" id="streakCount">0</div>
        <div class="stat-trend">Days</div>
      </div>
    </div>

    <!-- Live Scores Widget (Execution & Presence Tracking) -->
    <div class="live-scores-widget" id="liveScoresWidget">
      <div class="score-widget" onclick="openExecutionDetails()">
        <div class="score-widget-value" id="executeScoreValue">--</div>
        <div class="score-widget-label">Execute</div>
        <div class="score-widget-indicator" id="executeIndicator">ðŸ”´</div>
      </div>
      <div class="score-widget" onclick="openPresenceLog()">
        <div class="score-widget-value" id="presentScoreValue">--</div>
        <div class="score-widget-label">Present</div>
        <div class="score-widget-indicator" id="presentIndicator">ðŸ”´</div>
      </div>
      <div class="score-widget" onclick="switchView('track')">
        <div class="score-widget-value" id="planScoreValue">--</div>
        <div class="score-widget-label">Plan</div>
        <div class="score-widget-indicator" id="planIndicator"></div>
      </div>
    </div>

    <nav class="nav-tabs" style="grid-template-columns: repeat(4, 1fr);">
      <button class="nav-tab active" onclick="switchView('morning')"><span class="nav-icon">â˜€ï¸</span> Morning</button>
      <button class="nav-tab" onclick="switchView('track')"><span class="nav-icon">ðŸŽ¯</span> Track</button>
      <button class="nav-tab" onclick="switchView('evening')"><span class="nav-icon">ðŸŒ™</span> Evening</button>
      <button class="nav-tab" onclick="switchView('patterns')"><span class="nav-icon">ðŸ“Š</span> Patterns</button>
      <button class="nav-tab" onclick="switchView('ground')"><span class="nav-icon">âš–ï¸</span> Ground</button>
      <button class="nav-tab" onclick="switchView('principles')"><span class="nav-icon">ðŸ“œ</span> Principles</button>
      <button class="nav-tab" onclick="switchView('history')"><span class="nav-icon">ðŸ“š</span> History</button>
      <button class="nav-tab" onclick="switchView('settings')"><span class="nav-icon">âš™ï¸</span> Settings</button>
    </nav>
    
    <!-- MORNING VIEW -->
    <div id="morning" class="view active">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ”¥</span>
          <h2 class="section-title">Wake-Up Truth</h2>
        </div>
        
        <div class="truth-card">
          <div class="truth-text" id="dailyTruth">Loading truth...</div>
          <div class="truth-question" id="dailyQuestion">Loading question...</div>
        </div>
        
        <div class="question-block">
          <label class="question-label">Your honest response:</label>
          <textarea class="input-textarea" id="truthResponse" placeholder="Write your answer..."></textarea>
        </div>

        <!-- Today's Principle Reminder -->
        <div class="morning-principle-reminder">
          <div class="morning-principle-label">ðŸŽ¯ Today's Principle</div>
          <div class="morning-principle-text" id="morningPrincipleText">Loading...</div>
          <div class="morning-principle-prompt" id="morningPrinciplePrompt">What leap will you take today?</div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">âš¡</span>
          <h2 class="section-title">Foundational Question</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label" id="foundationalQuestion">Loading question...</label>
          <textarea class="input-textarea" id="foundationalResponse" placeholder="Your answer..."></textarea>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸŽ¯</span>
          <h2 class="section-title">Identity Declaration</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">Today I am the man who...</label>
          <p class="question-hint">One clear sentence. Declare who you're becoming.</p>
          <input type="text" class="input-text" id="identityDeclaration" placeholder="Today I am the man who..." />
        </div>
        
        <div class="question-block">
          <label class="question-label">One action to prove it:</label>
          <p class="question-hint">What specific thing will you do today?</p>
          <input type="text" class="input-text" id="proofAction" placeholder="I will..." />
        </div>
      </div>

      <!-- Today's Plan (Time Blocks) -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ“…</span>
          <h2 class="section-title">Today's Plan</h2>
        </div>

        <div class="question-block">
          <label class="question-label">What's your schedule today?</label>
          <p class="question-hint">Create time blocks with intentions. Be specific about what you'll do and the mindset you need.</p>

          <!-- Add Block Form -->
          <div class="add-block-form" id="addBlockForm">
            <div class="time-inputs">
              <div class="time-input-group">
                <label>Start Time</label>
                <input type="time" id="blockStartTime" value="09:00" />
              </div>
              <div class="time-input-group">
                <label>End Time</label>
                <input type="time" id="blockEndTime" value="10:00" />
              </div>
            </div>
            <div class="question-block" style="margin-bottom: 12px;">
              <label class="question-label" style="font-size: 0.85rem;">Activity</label>
              <input type="text" class="input-text" id="blockActivity" placeholder="What will you do?" style="padding: 12px;" />
            </div>
            <div class="question-block" style="margin-bottom: 0;">
              <label class="question-label" style="font-size: 0.85rem;">Intention (mindset)</label>
              <input type="text" class="input-text" id="blockIntention" placeholder="What mindset do you need?" style="padding: 12px;" />
            </div>
            <div class="add-block-btns">
              <button class="add-block-btn save" onclick="saveTimeBlock()">Save Block</button>
              <button class="add-block-btn cancel" onclick="cancelAddBlock()">Cancel</button>
            </div>
          </div>

          <!-- Time Blocks List -->
          <div class="time-blocks-container" id="morningTimeBlocks">
            <div class="empty-state" id="noBlocksMessage">
              <p style="color: var(--text-dim); font-size: 0.9rem;">No time blocks yet. Add your first block to start planning your day.</p>
            </div>
          </div>

          <button class="btn" onclick="showAddBlockForm()" id="addBlockBtn" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border); margin-top: 12px;">
            + Add Time Block
          </button>

          <div id="blockCount" style="text-align: center; margin-top: 12px; font-size: 0.85rem; color: var(--text-dim);"></div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ“Š</span>
          <h2 class="section-title">Quick Check</h2>
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Energy Level</span>
            <span class="slider-value" id="energyValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="energySlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Optimism</span>
            <span class="slider-value" id="optimismValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="optimismSlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Confidence</span>
            <span class="slider-value" id="confidenceValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="confidenceSlider">
        </div>
      </div>
      
      <button class="btn" onclick="saveMorning()">Complete Morning</button>
    </div>

    <!-- TRACK VIEW (Today's Execution) -->
    <div id="track" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸŽ¯</span>
          <h2 class="section-title">Today's Execution</h2>
        </div>

        <!-- Execution Score Bar -->
        <div class="execution-score-bar">
          <div class="execution-score-header">
            <span class="execution-score-label">Execution Score</span>
            <span class="execution-score-value" id="trackExecutionScore">--/100</span>
          </div>
          <div class="execution-progress">
            <div class="execution-progress-fill" id="trackExecutionFill" style="width: 0%; background: linear-gradient(90deg, #ff4444, #ff9500);"></div>
          </div>
        </div>

        <!-- Time Blocks List -->
        <div id="trackTimeBlocks">
          <div class="empty-state" id="noTrackBlocksMessage">
            <div class="empty-state-icon">ðŸ“…</div>
            <p>No plan created yet.</p>
            <p style="font-size: 0.85rem; color: var(--text-dim); margin-top: 8px;">Create your plan in the morning check-in to start tracking.</p>
            <button class="btn" onclick="switchView('morning')" style="margin-top: 16px; padding: 12px 24px; width: auto;">Go to Morning</button>
          </div>
        </div>
      </div>

      <!-- Streaks Section -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ”¥</span>
          <h2 class="section-title">Your Streaks</h2>
        </div>

        <div class="streaks-container">
          <div class="streak-item">
            <div class="streak-icon">ðŸ“…</div>
            <div class="streak-info">
              <div class="streak-name">Daily Plan</div>
              <div class="streak-best" id="planStreakBest">Best: 0 days</div>
            </div>
            <div class="streak-value"><span id="planStreakCurrent">0</span> <span>days</span></div>
          </div>
          <div class="streak-item">
            <div class="streak-icon">ðŸ§˜</div>
            <div class="streak-info">
              <div class="streak-name">Awareness</div>
              <div class="streak-best" id="awarenessStreakBest">Best: 0 days</div>
            </div>
            <div class="streak-value"><span id="awarenessStreakCurrent">0</span> <span>days</span></div>
          </div>
          <div class="streak-item">
            <div class="streak-icon">âœ…</div>
            <div class="streak-info">
              <div class="streak-name">Complete</div>
              <div class="streak-best" id="completeStreakBest">Best: 0 days</div>
            </div>
            <div class="streak-value"><span id="completeStreakCurrent">0</span> <span>days</span></div>
          </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
          <div class="level-badge" id="levelBadge">
            ðŸŒ± BEGINNER
          </div>
          <p style="font-size: 0.8rem; color: var(--text-dim); margin-top: 8px;" id="levelProgress">Day 0 of 7</p>
        </div>
      </div>

      <!-- Achievements -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ†</span>
          <h2 class="section-title">Achievements</h2>
        </div>

        <div class="achievements-grid" id="achievementsGrid">
          <div class="achievement-item locked" id="badge-execution-week">
            <div class="achievement-icon">ðŸ”¥</div>
            <div class="achievement-name">Week of Execution</div>
            <div class="achievement-desc">7 days with 70+ execution score</div>
          </div>
          <div class="achievement-item locked" id="badge-presence-week">
            <div class="achievement-icon">ðŸ§˜</div>
            <div class="achievement-name">Week of Presence</div>
            <div class="achievement-desc">7 days with 50+ presence score</div>
          </div>
          <div class="achievement-item locked" id="badge-perfect-day">
            <div class="achievement-icon">ðŸ’Ž</div>
            <div class="achievement-name">Perfect Day</div>
            <div class="achievement-desc">Both scores at 90+ in one day</div>
          </div>
          <div class="achievement-item locked" id="badge-30-day">
            <div class="achievement-icon">ðŸ†</div>
            <div class="achievement-name">30-Day Master</div>
            <div class="achievement-desc">30-day complete streak</div>
          </div>
        </div>
      </div>
    </div>

    <!-- EVENING VIEW -->
    <div id="evening" class="view">
      <!-- Execution Review -->
      <div class="section" id="eveningExecutionSection">
        <div class="section-header">
          <span class="section-icon">ðŸŽ¯</span>
          <h2 class="section-title">Execution Review</h2>
        </div>

        <div class="review-summary">
          <div class="review-summary-header">
            <span class="review-summary-title">Time Blocks</span>
            <span class="review-summary-score" id="eveningBlocksCompleted">0/0 completed</span>
          </div>
          <div class="review-summary-header">
            <span class="review-summary-title">Execution Score</span>
            <span class="review-summary-score" id="eveningExecutionScore">--/100</span>
          </div>
          <div class="review-block-list" id="eveningBlocksList">
            <p style="color: var(--text-dim); font-size: 0.85rem;">No blocks to review yet.</p>
          </div>
        </div>

        <div class="question-block">
          <label class="question-label">What pattern do you see?</label>
          <p class="question-hint">Where do you consistently fail? What's the common thread?</p>
          <textarea class="input-textarea" id="executionPattern" placeholder="I notice that..."></textarea>
        </div>

        <div class="question-block">
          <label class="question-label">Tomorrow, what changes?</label>
          <p class="question-hint">One specific adjustment based on today's pattern.</p>
          <textarea class="input-textarea" id="executionTomorrow" placeholder="Tomorrow I will..."></textarea>
        </div>
      </div>

      <!-- Presence Review -->
      <div class="section" id="eveningPresenceSection">
        <div class="section-header">
          <span class="section-icon">ðŸ§˜</span>
          <h2 class="section-title">Presence Review</h2>
        </div>

        <div class="review-summary">
          <div class="review-summary-header">
            <span class="review-summary-title">Presence Checks</span>
            <span class="review-summary-score" id="eveningPresenceChecks">0 times</span>
          </div>
          <div class="review-summary-header">
            <span class="review-summary-title">Presence Score</span>
            <span class="review-summary-score" id="eveningPresenceScore">--/100</span>
          </div>
        </div>

        <div id="eveningUrgesList" style="margin-bottom: 20px;">
          <label class="question-label" style="font-size: 0.9rem; margin-bottom: 12px; display: block;">Urges Caught Today:</label>
          <div class="urge-list" id="urgeListContainer">
            <p style="color: var(--text-dim); font-size: 0.85rem;">No urges logged today. Use the âš¡ button to log presence checks.</p>
          </div>
        </div>

        <div style="display: flex; gap: 16px; margin-bottom: 20px;">
          <div style="flex: 1; padding: 16px; background: var(--bg-elevated); border-radius: 12px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 900; color: var(--accent);" id="evening5SecondCount">0</div>
            <div style="font-size: 0.75rem; color: var(--text-dim);">5-Second Rule Used</div>
          </div>
          <div style="flex: 1; padding: 16px; background: var(--bg-elevated); border-radius: 12px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 900; color: var(--success);" id="eveningStayedPresentCount">0</div>
            <div style="font-size: 0.75rem; color: var(--text-dim);">Stayed Present</div>
          </div>
        </div>

        <div class="question-block">
          <label class="question-label">Most common urge today:</label>
          <p class="question-hint" id="commonUrgeHint">Analyze what triggered you most.</p>
          <div id="commonUrgeDisplay" style="padding: 12px; background: var(--bg-elevated); border-radius: 8px; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 16px;">
            Not enough data yet.
          </div>
        </div>

        <div class="question-block">
          <label class="question-label">Tomorrow's awareness focus:</label>
          <p class="question-hint">What will you watch for tomorrow?</p>
          <textarea class="input-textarea" id="awarenessFocus" placeholder="I will be aware of..."></textarea>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">âœ“</span>
          <h2 class="section-title">Accountability</h2>
        </div>

        <div class="question-block">
          <label class="question-label">Did you do what you said you'd do?</label>
          <p class="question-hint" id="actionReminder">Loading your commitment...</p>
          <div class="yes-no-group">
            <button class="yes-no-btn" id="didItYes" onclick="selectYesNo(true)">YES</button>
            <button class="yes-no-btn" id="didItNo" onclick="selectYesNo(false)">NO</button>
          </div>
          <textarea class="input-textarea" id="accountabilityWhy" placeholder="Why or why not? Be honest."></textarea>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ†</span>
          <h2 class="section-title">Today's Win</h2>
        </div>

        <div class="question-block">
          <label class="question-label">What's one thing you did well today?</label>
          <p class="question-hint">No matter how small. Acknowledge it.</p>
          <textarea class="input-textarea" id="todayWin" placeholder="Today I..."></textarea>
        </div>
      </div>

      <!-- Principles Check -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ“œ</span>
          <h2 class="section-title">Principles Check</h2>
        </div>

        <div class="question-block">
          <label class="question-label">Which principles did you live by today?</label>
          <p class="question-hint">Select all that apply</p>

          <div class="principles-checkbox-list" id="principlesCheckboxList">
            <!-- Populated by JavaScript -->
          </div>
        </div>

        <div class="question-block">
          <label class="question-label">Reflection (Optional)</label>
          <p class="question-hint">Which principle did you break? How will you honor it tomorrow?</p>
          <textarea class="input-textarea" id="principlesReflection" placeholder="Today I struggled with..."></textarea>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ“Š</span>
          <h2 class="section-title">Evening Check</h2>
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Overall Happiness</span>
            <span class="slider-value" id="happinessValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="happinessSlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Handled Challenges</span>
            <span class="slider-value" id="challengesValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="challengesSlider">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Felt Connected</span>
            <span class="slider-value" id="connectionValue">5</span>
          </div>
          <input type="range" min="1" max="10" value="5" class="slider" id="connectionSlider">
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ”®</span>
          <h2 class="section-title">Tomorrow</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">What's your focus for tomorrow?</label>
          <p class="question-hint">One clear priority.</p>
          <input type="text" class="input-text" id="tomorrowFocus" placeholder="Tomorrow I will focus on..." />
        </div>
      </div>
      
      <button class="btn" onclick="saveEvening()">Complete Evening</button>
    </div>
    
    <!-- HISTORY VIEW -->
    <div id="history" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ“œ</span>
          <h2 class="section-title">Your Journey</h2>
        </div>

        <div class="history-list" id="historyList">
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“</div>
            <p>No entries yet. Complete your first check-in to start.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- PATTERNS VIEW (Analytics) -->
    <div id="patterns" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ“Š</span>
          <h2 class="section-title">Your Execution Patterns</h2>
        </div>

        <div class="pattern-card">
          <div class="pattern-card-title">This Week</div>
          <div class="pattern-row">
            <span class="pattern-label">Morning blocks (6-11 AM)</span>
            <span class="pattern-value score-green" id="patternMorning">--%</span>
          </div>
          <div class="pattern-row">
            <span class="pattern-label">Afternoon blocks (12-5 PM)</span>
            <span class="pattern-value score-orange" id="patternAfternoon">--%</span>
          </div>
          <div class="pattern-row">
            <span class="pattern-label">Evening blocks (6-10 PM)</span>
            <span class="pattern-value score-yellow" id="patternEvening">--%</span>
          </div>
        </div>

        <div class="pattern-card">
          <div class="pattern-card-title">Activity Analysis</div>
          <div class="pattern-row">
            <span class="pattern-label">Most skipped activity</span>
            <span class="pattern-value" id="patternMostSkipped">No data</span>
          </div>
          <div class="pattern-row">
            <span class="pattern-label">Best day this week</span>
            <span class="pattern-value" id="patternBestDay">No data</span>
          </div>
          <div class="pattern-row">
            <span class="pattern-label">Worst day this week</span>
            <span class="pattern-value" id="patternWorstDay">No data</span>
          </div>
          <div class="pattern-row">
            <span class="pattern-label">Average execution score</span>
            <span class="pattern-value" id="patternAvgExecution">--/100</span>
          </div>
        </div>

        <div class="pattern-insight" id="executionInsight">
          <strong>ðŸ’¡ Insight:</strong> Complete more days to see patterns in your execution.
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ§˜</span>
          <h2 class="section-title">Your Awareness Patterns</h2>
        </div>

        <div class="pattern-card">
          <div class="pattern-card-title">This Month</div>
          <div class="pattern-row">
            <span class="pattern-label">Total presence checks</span>
            <span class="pattern-value" id="patternTotalChecks">0</span>
          </div>
          <div class="pattern-row">
            <span class="pattern-label">Average per day</span>
            <span class="pattern-value" id="patternAvgChecks">0</span>
          </div>
          <div class="pattern-row">
            <span class="pattern-label">5-second rule success rate</span>
            <span class="pattern-value" id="pattern5SecondRate">--%</span>
          </div>
        </div>

        <div class="pattern-card">
          <div class="pattern-card-title">Most Common Urges</div>
          <div id="commonUrgesContainer">
            <p style="color: var(--text-dim); font-size: 0.9rem;">Not enough data yet. Log presence checks to see patterns.</p>
          </div>
        </div>

        <div class="pattern-card">
          <div class="pattern-card-title">Your Trigger Times</div>
          <div id="triggerTimesContainer">
            <p style="color: var(--text-dim); font-size: 0.9rem;">Track more days to identify your trigger times.</p>
          </div>
        </div>

        <div class="pattern-insight" id="presenceInsight">
          <strong>ðŸ“ˆ Growth:</strong> Start tracking to see your awareness growth over time.
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ“…</span>
          <h2 class="section-title">Weekly Overview</h2>
        </div>

        <div id="weeklyOverview" style="display: flex; flex-direction: column; gap: 8px;">
          <!-- Populated by JavaScript -->
          <p style="color: var(--text-dim); font-size: 0.9rem;">Complete more days to see your weekly overview.</p>
        </div>
      </div>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="settings" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">âš™ï¸</span>
          <h2 class="section-title">Notification Settings</h2>
        </div>
        
        <div class="question-block">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <label class="question-label" style="margin: 0;">Enable Notifications</label>
            <button class="yes-no-btn" id="notifToggle" onclick="toggleNotifications()" style="width: 120px; padding: 10px;">
              <span id="notifStatus">OFF</span>
            </button>
          </div>
          <p class="question-hint" id="notifPermissionHint">Click to enable browser notifications</p>
        </div>
        
        <div id="notifSettings" style="display: none;">
          <div class="question-block">
            <label class="question-label">Morning Reminder</label>
            <p class="question-hint">When should we remind you to do your morning check-in?</p>
            <input type="time" class="input-text" id="morningTime" value="07:00" style="font-size: 1.1rem; padding: 16px;" />
          </div>
          
          <div class="question-block">
            <label class="question-label">Evening Reminder</label>
            <p class="question-hint">When should we remind you to do your evening reflection?</p>
            <input type="time" class="input-text" id="eveningTime" value="21:00" style="font-size: 1.1rem; padding: 16px;" />
          </div>
          
          <div class="question-block">
            <label class="question-label">Test Notification</label>
            <p class="question-hint">Send a test notification right now to make sure it's working</p>
            <button class="btn" onclick="testNotification()" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border);">Send Test Notification</button>
          </div>
          
          <button class="btn" onclick="saveNotificationSettings()">Save Reminder Times</button>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ’¾</span>
          <h2 class="section-title">Data Management</h2>
        </div>
        
        <div class="question-block">
          <label class="question-label">Export Your Data</label>
          <p class="question-hint">Download all your entries as a JSON file for backup</p>
          <button class="btn" onclick="exportData()" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border);">Download Data</button>
        </div>
        
        <div class="question-block">
          <label class="question-label" style="color: var(--warning);">Reset Everything</label>
          <p class="question-hint">This will delete all your entries. This cannot be undone.</p>
          <button class="btn" onclick="confirmReset()" style="background: transparent; color: var(--warning); border: 1px solid var(--warning);">Clear All Data</button>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">â„¹ï¸</span>
          <h2 class="section-title">App Info</h2>
        </div>

        <div class="question-block">
          <label class="question-label">Current Version</label>
          <p class="question-hint">Use this to verify you have the latest update</p>
          <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border: 1px solid var(--border); text-align: center;">
            <span style="font-size: 1.2rem; font-weight: 700; color: var(--accent);" id="appVersion">Loading...</span>
          </div>
        </div>

        <div class="question-block">
          <label class="question-label">Gratitude Grounding</label>
          <p class="question-hint">Last reality check to remind yourself of your wealth</p>
          <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border: 1px solid var(--border);">
            <span id="lastGroundCheck">Never completed</span>
          </div>
          <button class="btn" onclick="switchView('ground')" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border); margin-top: 12px;">
            Take Reality Check
          </button>
        </div>

        <div class="question-block">
          <label class="question-label">Principles Practice</label>
          <p class="question-hint">Track how you live by your 7 core principles</p>
          <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border: 1px solid var(--border);">
            <span id="principlesMonthlyAvg">Not tracked yet</span>
          </div>
          <button class="btn" onclick="switchView('principles')" style="background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border); margin-top: 12px;">
            View Principles
          </button>
        </div>
      </div>
    </div>

    <!-- GROUND VIEW (Reality Check) -->
    <div id="ground" class="view">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">âš–ï¸</span>
          <h2 class="section-title">Reality Check</h2>
        </div>

        <div class="ground-container">
          <!-- Mode Selection Screen -->
          <div id="groundModeSelect" class="ground-screen active">
            <p class="ground-last-check" id="groundLastCheckDisplay">Last check: Never</p>

            <div class="ground-mode-card" onclick="startGroundCheck('quick')">
              <div class="ground-mode-title">Quick Mode</div>
              <div class="ground-mode-desc">5 random questions (~3 minutes)</div>
            </div>

            <div class="ground-mode-card" onclick="startGroundCheck('full')">
              <div class="ground-mode-title">Full Mode</div>
              <div class="ground-mode-desc">All 15 questions (~10 minutes)</div>
            </div>

            <div id="groundResumeOption" style="display: none; margin-top: 24px;">
              <button class="ground-btn-secondary" onclick="resumeGroundCheck()">
                Resume Previous Check
              </button>
            </div>
          </div>

          <!-- Question Screen -->
          <div id="groundQuestion" class="ground-screen">
            <button class="ground-exit-btn" onclick="exitGroundCheck()">Exit</button>

            <div class="ground-progress">
              <span class="ground-progress-text" id="groundProgressText">1 / 15</span>
              <div class="ground-progress-bar">
                <div class="ground-progress-fill" id="groundProgressFill" style="width: 0%"></div>
              </div>
            </div>

            <div class="ground-question-text" id="groundQuestionText">Loading...</div>

            <div class="ground-yes-no">
              <button class="yes-no-btn" id="groundYes" onclick="groundAnswer('yes')">YES</button>
              <button class="yes-no-btn" id="groundNo" onclick="groundAnswer('no')">NO</button>
            </div>

            <div id="groundResponseArea" class="ground-response" style="display: none;">
              <div class="ground-truth" id="groundTruthText"></div>

              <label class="ground-commitment-label" id="groundCommitmentLabel">Name one way you will respect this gift today.</label>
              <input type="text" class="input-text" id="groundCommitmentInput" placeholder="I will..." />

              <button class="btn" id="groundNextBtn" onclick="groundNext()" style="display: none;">Next</button>
            </div>
          </div>

          <!-- Summary Screen -->
          <div id="groundSummary" class="ground-screen">
            <div class="ground-summary">
              <div class="ground-summary-count" id="groundWealthCount">0</div>
              <div class="ground-summary-label">forms of wealth acknowledged</div>

              <div class="ground-summary-message">
                Billions will never have them.<br><br>
                You are not owed anything.<br>
                You were given a lot.<br><br>
                <strong>You owe life a response.</strong>
                What will you do with it today?
              </div>

              <div class="ground-meta">
                <div>Wealth forms: <span id="groundSummaryWealth">0</span> / <span id="groundSummaryTotal">15</span></div>
                <div>Completed: <span id="groundSummaryDate">-</span></div>
              </div>

              <div class="ground-btn-group">
                <button class="ground-btn-secondary" onclick="viewGroundCommitments()">View My Commitments</button>
                <button class="btn" onclick="resetGroundCheck()">Start Again</button>
                <button class="ground-btn-secondary" onclick="switchView('morning')">Done</button>
              </div>
            </div>
          </div>

          <!-- Commitments View Screen -->
          <div id="groundCommitments" class="ground-screen">
            <button class="ground-exit-btn" onclick="showGroundSummary()">â† Back</button>

            <h3 style="margin-bottom: 24px; color: var(--text-primary);">Your Commitments</h3>

            <div class="ground-commitments-list" id="groundCommitmentsList"></div>

            <button class="ground-btn-secondary" onclick="showGroundSummary()" style="margin-top: 24px;">Back to Summary</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PRINCIPLES VIEW -->
    <div id="principles" class="view">
      <div class="section">
        <div class="principles-header">
          <h2>How to Live Well</h2>
          <p class="tagline">The rules you forget when life gets hard</p>
        </div>

        <!-- Today's Principle Card -->
        <div class="today-principle-card">
          <div class="today-principle-label">ðŸŽ¯ Today's Focus</div>
          <div class="today-principle-number" id="todayPrincipleNumber">Principle #1</div>
          <div class="today-principle-text" id="todayPrincipleText">Loading...</div>
          <div class="today-principle-status" id="todayPrincipleStatus">Check in evening</div>
        </div>

        <!-- All Principles List -->
        <div class="principles-list" id="principlesList">
          <!-- Populated by JavaScript -->
        </div>
      </div>

      <!-- Weekly Tracking Section -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ“Š</span>
          <h2 class="section-title">This Week's Practice</h2>
        </div>

        <div class="weekly-tracking" id="weeklyTracking">
          <!-- Populated by JavaScript -->
        </div>

        <div class="week-score">
          <div class="week-score-value" id="weekScoreValue">0</div>
          <div class="week-score-label">principles honored this week</div>
        </div>
      </div>

      <!-- Monthly Stats Section -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">ðŸ“ˆ</span>
          <h2 class="section-title">This Month</h2>
        </div>

        <div class="monthly-stats" id="monthlyStats">
          <div class="monthly-stat-card">
            <div class="monthly-stat-label">Most Honored</div>
            <div class="monthly-stat-value" id="mostHonoredPrinciple">Not enough data</div>
          </div>
          <div class="monthly-stat-card">
            <div class="monthly-stat-label">Least Honored</div>
            <div class="monthly-stat-value" id="leastHonoredPrinciple">Not enough data</div>
          </div>
          <div class="monthly-stat-card">
            <div class="monthly-stat-label">Best Day</div>
            <div class="monthly-stat-value" id="bestDayPrinciple">Not enough data</div>
          </div>
          <div class="monthly-stat-card">
            <div class="monthly-stat-label">Daily Average</div>
            <div class="monthly-stat-value" id="avgPrinciplesDay">Not enough data</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button (FAB) for Presence Check -->
  <div class="fab-container" id="fabContainer">
    <button class="fab-btn" onclick="openPresenceModal()" title="Log presence check">
      âš¡
    </button>
  </div>

  <!-- Presence Check Modal -->
  <div class="modal-overlay" id="presenceModal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">What are you thinking right now?</span>
        <button class="modal-close" onclick="closePresenceModal()">Ã—</button>
      </div>

      <div class="question-block" style="margin-bottom: 20px;">
        <label class="question-label">Name the thought/urge/feeling:</label>
        <textarea class="input-textarea" id="presenceThought" placeholder="I want to... / I feel... / I'm thinking about..." style="min-height: 80px;"></textarea>
      </div>

      <div class="presence-options" id="presenceOptions">
        <div class="presence-option" onclick="togglePresenceOption('caughtUrge')">
          <div class="presence-checkbox" id="check-caughtUrge">âœ“</div>
          <div class="presence-option-text">Caught an urge</div>
        </div>
        <div class="presence-option" onclick="togglePresenceOption('used5Second')">
          <div class="presence-checkbox" id="check-used5Second">âœ“</div>
          <div class="presence-option-text">Used the 5-second rule (5-4-3-2-1 then act)</div>
        </div>
        <div class="presence-option" onclick="togglePresenceOption('stayedPresent')">
          <div class="presence-checkbox" id="check-stayedPresent">âœ“</div>
          <div class="presence-option-text">Stayed present with my plan</div>
        </div>
        <div class="presence-option" onclick="togglePresenceOption('brokePlan')">
          <div class="presence-checkbox" id="check-brokePlan">âœ“</div>
          <div class="presence-option-text">Broke my plan / gave in to urge</div>
        </div>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button class="btn" onclick="logPresenceCheck()" style="flex: 1;">Log It</button>
        <button class="btn" onclick="closePresenceModal()" style="flex: 1; background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border);">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Block Completion Modal -->
  <div class="modal-overlay" id="blockCompleteModal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Complete Time Block</span>
        <button class="modal-close" onclick="closeBlockModal()">Ã—</button>
      </div>

      <div style="padding: 16px; background: var(--bg-elevated); border-radius: 12px; margin-bottom: 20px;">
        <div style="font-size: 0.9rem; color: var(--accent); font-weight: 700;" id="modalBlockTime">--:-- - --:--</div>
        <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-top: 8px;" id="modalBlockActivity">Activity</div>
      </div>

      <div class="question-block">
        <label class="question-label">Did you follow through?</label>
        <div class="presence-options" id="blockStatusOptions">
          <div class="presence-option" onclick="selectBlockStatus('completed')">
            <div class="presence-checkbox" id="status-completed">âœ“</div>
            <div class="presence-option-text">Yes, completed as planned</div>
          </div>
          <div class="presence-option" onclick="selectBlockStatus('partial')">
            <div class="presence-checkbox" id="status-partial">âœ“</div>
            <div class="presence-option-text">Partially completed</div>
          </div>
          <div class="presence-option" onclick="selectBlockStatus('skipped')">
            <div class="presence-checkbox" id="status-skipped">âœ“</div>
            <div class="presence-option-text">No, skipped/avoided</div>
          </div>
        </div>
      </div>

      <div class="question-block">
        <label class="question-label">Did you honor your intention?</label>
        <p class="question-hint" id="modalIntentionText">"Your intention here"</p>
        <div class="presence-option" onclick="toggleIntentionHonored()" id="intentionOption">
          <div class="presence-checkbox" id="check-intention">âœ“</div>
          <div class="presence-option-text">Yes, I honored this</div>
        </div>
      </div>

      <div class="question-block">
        <label class="question-label">Quick note (optional):</label>
        <input type="text" class="input-text" id="blockNote" placeholder="Any notes about this block..." />
      </div>

      <input type="hidden" id="currentBlockId" />

      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button class="btn" onclick="completeBlock()" style="flex: 1;">Mark Complete</button>
        <button class="btn" onclick="closeBlockModal()" style="flex: 1; background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border);">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Execution Details Modal -->
  <div class="modal-overlay" id="executionDetailsModal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Execution Details</span>
        <button class="modal-close" onclick="closeExecutionDetailsModal()">Ã—</button>
      </div>

      <div class="execution-score-bar">
        <div class="execution-score-header">
          <span class="execution-score-label">Today's Execution Score</span>
          <span class="execution-score-value" id="modalExecutionScore">--/100</span>
        </div>
        <div class="execution-progress">
          <div class="execution-progress-fill" id="modalExecutionFill" style="width: 0%;"></div>
        </div>
      </div>

      <div id="modalBlocksList" style="margin-top: 20px;">
        <!-- Populated by JavaScript -->
      </div>

      <button class="btn" onclick="switchView('track'); closeExecutionDetailsModal();" style="margin-top: 20px;">View Full Track</button>
    </div>
  </div>

  <!-- Presence Log Modal -->
  <div class="modal-overlay" id="presenceLogModal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Today's Presence Log</span>
        <button class="modal-close" onclick="closePresenceLogModal()">Ã—</button>
      </div>

      <div style="display: flex; gap: 16px; margin-bottom: 20px;">
        <div style="flex: 1; padding: 16px; background: var(--bg-elevated); border-radius: 12px; text-align: center;">
          <div style="font-size: 1.8rem; font-weight: 900; color: var(--accent);" id="modalPresenceScore">--</div>
          <div style="font-size: 0.75rem; color: var(--text-dim);">Presence Score</div>
        </div>
        <div style="flex: 1; padding: 16px; background: var(--bg-elevated); border-radius: 12px; text-align: center;">
          <div style="font-size: 1.8rem; font-weight: 900; color: var(--text-primary);" id="modalCheckCount">0</div>
          <div style="font-size: 0.75rem; color: var(--text-dim);">Checks Today</div>
        </div>
      </div>

      <div class="presence-log" id="modalPresenceLog">
        <p style="color: var(--text-dim); font-size: 0.9rem; text-align: center;">No presence checks logged today.</p>
      </div>

      <button class="btn" onclick="openPresenceModal(); closePresenceLogModal();" style="margin-top: 20px;">+ Log New Check</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // App Version - Update this timestamp when making changes
    const APP_VERSION = 'v2025-12-16 01:00';

    // Register Service Worker for PWA notifications
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('Service Worker registered');
        })
        .catch(err => {
          console.log('Service Worker registration failed:', err);
        });
    }

    // Wake-up truths and questions
    const truths = [
      {
        truth: "You are the youngest you will ever be.",
        question: "If today is the youngest, strongest version of you that will ever exist, what will you do with it that your older self will thank you for?"
      },
      {
        truth: "Every day might be your last.",
        question: "If today was the final page of your life, how would you want the story to end by midnight?"
      },
      {
        truth: "You are wealthier than most of the world.",
        question: "With the level of wealth, safety, and freedom you have, what excuse do you actually have to play small?"
      },
      {
        truth: "You have opportunities people would kill for.",
        question: "If someone with nothing had your life for 24 hours, how much harder would they push than you?"
      },
      {
        truth: "Your life is not guaranteed beyond today.",
        question: "If life was borrowed time, how would you spend the next twelve hours?"
      }
    ];
    
    // Foundational questions (rotating)
    const foundationalQuestions = [
      "Are you healthy today? If yes, what is stopping you from using this body fully?",
      "Is there someone who would stand at your funeral even if it rained? If not, how will you build relationships worth dying for?",
      "If you were gone tonight, what would people say about your life? Is that acceptable to you?",
      "What is one thing you can do today so that by bedtime, you feel genuine pride instead of regret?",
      "What fear or insecurity will you confront today that will raise your character one level higher?"
    ];

    // Principles for living well
    const principles = [
      {
        number: 1,
        short: "Be your own best friend",
        full: "Be your own best friend. Never attack yourself.",
        prompt: "How will you practice self-compassion today?"
      },
      {
        number: 2,
        short: "Nothing is yours (no loss, only gain)",
        full: "Believe that nothing is yours so there is no loss, only gain.",
        prompt: "What can you appreciate without clinging to today?"
      },
      {
        number: 3,
        short: "Invest in good friends",
        full: "Invest in good friends. They tend to add colors to life.",
        prompt: "Who will you connect with today?"
      },
      {
        number: 4,
        short: "Take relentless action",
        full: "Take relentless action by reducing overthinking and taking the leaps. That tends to add more excitement and opportunity into your life.",
        prompt: "What leap will you take today?"
      },
      {
        number: 5,
        short: "Give more than you take",
        full: "Give more than you take. Giving provides sense of meaning into your life.",
        prompt: "What will you give freely today?"
      },
      {
        number: 6,
        short: "Enjoy little moments",
        full: "Enjoy little moments. Beautiful breakfast, sunsets, laughs. Life is just a series of moments.",
        prompt: "What small moment will you fully embrace today?"
      },
      {
        number: 7,
        short: "Play a musical instrument",
        full: "Learn to play a musical instrument. It adds another form of expression.",
        prompt: "How will you express yourself creatively today?"
      }
    ];

    // Principles tracking data
    let principlesData = {
      tracking: []
    };
    let selectedPrinciples = [];

    // State management
    let entries = [];
    let currentDayIndex = 0;
    let eveningDidIt = null;
    let notificationsEnabled = false;
    let morningReminderTime = '07:00';
    let eveningReminderTime = '21:00';
    let notificationCheckInterval = null;
    
    // Initialize
    function init() {
      console.log(`ðŸ”¥ Identity Forge ${APP_VERSION} - App loaded successfully`);
      setupSliders();
      loadDailyContent();
      loadPrinciplesData();
      initPrinciplesUI();
      updateStats();
      checkEveningAvailability();
      loadNotificationSettings();
      startNotificationChecker();
      scheduleNextNotifications();
    }
    
    // Setup slider value displays
    function setupSliders() {
      const sliders = [
        {id: 'energySlider', valueId: 'energyValue'},
        {id: 'optimismSlider', valueId: 'optimismValue'},
        {id: 'confidenceSlider', valueId: 'confidenceValue'},
        {id: 'happinessSlider', valueId: 'happinessValue'},
        {id: 'challengesSlider', valueId: 'challengesValue'},
        {id: 'connectionSlider', valueId: 'connectionValue'}
      ];
      
      sliders.forEach(({id, valueId}) => {
        const slider = document.getElementById(id);
        const valueDisplay = document.getElementById(valueId);
        if (slider && valueDisplay) {
          slider.addEventListener('input', (e) => {
            valueDisplay.textContent = e.target.value;
          });
        }
      });
    }
    
    // Load daily rotating content
    function loadDailyContent() {
      const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
      const truthIndex = dayOfYear % truths.length;
      const questionIndex = dayOfYear % foundationalQuestions.length;
      
      currentDayIndex = dayOfYear;
      
      document.getElementById('dailyTruth').textContent = truths[truthIndex].truth;
      document.getElementById('dailyQuestion').textContent = truths[truthIndex].question;
      document.getElementById('foundationalQuestion').textContent = foundationalQuestions[questionIndex];
    }
    
    // Check if evening is available
    function checkEveningAvailability() {
      const today = getTodayEntries();
      if (today.morning) {
        document.getElementById('actionReminder').textContent = `You said: "${today.morning.proofAction}"`;
      }
    }
    
    // Get today's entries
    function getTodayEntries() {
      const today = new Date().toDateString();
      return {
        morning: entries.find(e => e.type === 'morning' && new Date(e.date).toDateString() === today),
        evening: entries.find(e => e.type === 'evening' && new Date(e.date).toDateString() === today)
      };
    }
    
    // Switch view
    function switchView(viewName) {
      const tabs = document.querySelectorAll('.nav-tab');
      const views = document.querySelectorAll('.view');

      tabs.forEach(tab => tab.classList.remove('active'));
      views.forEach(view => view.classList.remove('active'));

      // Find and activate the correct tab
      tabs.forEach(tab => {
        if (tab.textContent.toLowerCase().includes(viewName.toLowerCase()) ||
            (viewName === 'ground' && tab.textContent.includes('Ground')) ||
            (viewName === 'principles' && tab.textContent.includes('Principles'))) {
          tab.classList.add('active');
        }
      });

      document.getElementById(viewName).classList.add('active');

      if (viewName === 'evening') {
        checkEveningAvailability();
        initPrinciplesCheckboxes();
      } else if (viewName === 'history') {
        displayHistory();
      } else if (viewName === 'settings') {
        updateSettingsUI();
      } else if (viewName === 'ground') {
        initGroundView();
      } else if (viewName === 'principles') {
        updatePrinciplesView();
      }
    }
    
    // Yes/No selection
    function selectYesNo(value) {
      eveningDidIt = value;
      document.getElementById('didItYes').classList.toggle('selected', value === true);
      document.getElementById('didItNo').classList.toggle('selected', value === false);
    }
    
    // Save morning
    function saveMorning() {
      const data = {
        date: new Date().toISOString(),
        type: 'morning',
        dayIndex: currentDayIndex,
        truthResponse: document.getElementById('truthResponse').value,
        foundationalResponse: document.getElementById('foundationalResponse').value,
        identityDeclaration: document.getElementById('identityDeclaration').value,
        proofAction: document.getElementById('proofAction').value,
        energy: parseInt(document.getElementById('energySlider').value),
        optimism: parseInt(document.getElementById('optimismSlider').value),
        confidence: parseInt(document.getElementById('confidenceSlider').value)
      };
      
      // Validate
      if (!data.truthResponse || !data.foundationalResponse || !data.identityDeclaration || !data.proofAction) {
        showToast('Please complete all fields');
        return;
      }
      
      // Remove old morning entry for today
      const today = new Date().toDateString();
      entries = entries.filter(e => !(e.type === 'morning' && new Date(e.date).toDateString() === today));
      
      entries.push(data);
      saveToStorage();
      showToast('Morning complete. Make it count.');
      updateStats();
      scheduleNextNotifications(); // Reschedule evening notification
      
      // Clear form
      document.getElementById('truthResponse').value = '';
      document.getElementById('foundationalResponse').value = '';
      document.getElementById('identityDeclaration').value = '';
      document.getElementById('proofAction').value = '';
    }
    
    // Save evening
    function saveEvening() {
      const todayMorning = getTodayEntries().morning;

      if (!todayMorning) {
        showToast('Complete your morning check-in first');
        return;
      }

      if (eveningDidIt === null) {
        showToast('Please select Yes or No for accountability');
        return;
      }

      const data = {
        date: new Date().toISOString(),
        type: 'evening',
        dayIndex: currentDayIndex,
        didIt: eveningDidIt,
        accountabilityWhy: document.getElementById('accountabilityWhy').value,
        todayWin: document.getElementById('todayWin').value,
        happiness: parseInt(document.getElementById('happinessSlider').value),
        challenges: parseInt(document.getElementById('challengesSlider').value),
        connection: parseInt(document.getElementById('connectionSlider').value),
        tomorrowFocus: document.getElementById('tomorrowFocus').value
      };

      // Validate
      if (!data.accountabilityWhy || !data.todayWin || !data.tomorrowFocus) {
        showToast('Please complete all fields');
        return;
      }

      // Remove old evening entry for today
      const today = new Date().toDateString();
      entries = entries.filter(e => !(e.type === 'evening' && new Date(e.date).toDateString() === today));

      entries.push(data);
      saveToStorage();

      // Save principles tracking
      savePrinciplesTracking();

      showToast('Evening complete. Rest well.');
      updateStats();
      scheduleNextNotifications(); // Reschedule for tomorrow

      // Clear form
      eveningDidIt = null;
      document.getElementById('didItYes').classList.remove('selected');
      document.getElementById('didItNo').classList.remove('selected');
      document.getElementById('accountabilityWhy').value = '';
      document.getElementById('todayWin').value = '';
      document.getElementById('tomorrowFocus').value = '';
      document.getElementById('principlesReflection').value = '';
      selectedPrinciples = [];
      initPrinciplesCheckboxes();
    }
    
    // Calculate stats
    function updateStats() {
      if (entries.length === 0) return;
      
      const morningEntries = entries.filter(e => e.type === 'morning');
      const eveningEntries = entries.filter(e => e.type === 'evening');
      
      // Calculate Vitality (energy + optimism)
      let vitalityScores = [];
      morningEntries.forEach(e => {
        vitalityScores.push((e.energy + e.optimism) / 2);
      });
      const vitality = vitalityScores.length > 0 
        ? (vitalityScores.reduce((a, b) => a + b, 0) / vitalityScores.length).toFixed(1)
        : '--';
      
      // Calculate Courage (confidence + challenges handled + did what you said)
      let courageScores = [];
      morningEntries.forEach(e => courageScores.push(e.confidence));
      eveningEntries.forEach(e => {
        courageScores.push(e.challenges);
        courageScores.push(e.didIt ? 10 : 5); // Bonus for following through
      });
      const courage = courageScores.length > 0
        ? (courageScores.reduce((a, b) => a + b, 0) / courageScores.length).toFixed(1)
        : '--';
      
      // Calculate Meaning (happiness + connection)
      let meaningScores = [];
      eveningEntries.forEach(e => {
        meaningScores.push((e.happiness + e.connection) / 2);
      });
      const meaning = meaningScores.length > 0
        ? (meaningScores.reduce((a, b) => a + b, 0) / meaningScores.length).toFixed(1)
        : '--';
      
      // Calculate streak
      const streak = calculateStreak();
      
      // Update display
      document.getElementById('vitalityScore').textContent = vitality;
      document.getElementById('courageScore').textContent = courage;
      document.getElementById('meaningScore').textContent = meaning;
      document.getElementById('streakCount').textContent = streak;
      
      // Update trends (last 7 days average)
      updateTrends();
    }
    
    // Calculate streak
    function calculateStreak() {
      const today = new Date();
      let streak = 0;
      
      for (let i = 0; i < 365; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() - i);
        const dateStr = checkDate.toDateString();
        
        const hasBoth = entries.some(e => e.type === 'morning' && new Date(e.date).toDateString() === dateStr) &&
                       entries.some(e => e.type === 'evening' && new Date(e.date).toDateString() === dateStr);
        
        if (hasBoth) {
          streak++;
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    // Update trends
    function updateTrends() {
      const trends = {
        vitality: 'Building energy',
        courage: 'Growing stronger',
        meaning: 'Finding purpose'
      };
      
      document.getElementById('vitalityTrend').textContent = trends.vitality;
      document.getElementById('courageTrend').textContent = trends.courage;
      document.getElementById('meaningTrend').textContent = trends.meaning;
    }
    
    // Display history
    function displayHistory() {
      const historyList = document.getElementById('historyList');
      
      if (entries.length === 0) {
        historyList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“</div>
            <p>No entries yet. Complete your first check-in to start.</p>
          </div>
        `;
        return;
      }
      
      // Group by date
      const grouped = {};
      entries.forEach(entry => {
        const dateKey = new Date(entry.date).toDateString();
        if (!grouped[dateKey]) grouped[dateKey] = {};
        grouped[dateKey][entry.type] = entry;
      });
      
      // Sort by date descending
      const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
      
      historyList.innerHTML = sortedDates.slice(0, 30).map(dateStr => {
        const day = grouped[dateStr];
        const date = new Date(dateStr);
        const formattedDate = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        
        return `
          <div class="history-item">
            <div class="history-date">${formattedDate}</div>
            ${day.morning ? `
              <div class="history-content">
                <strong>Identity:</strong> ${day.morning.identityDeclaration}
                <strong>Action:</strong> ${day.morning.proofAction}
              </div>
            ` : ''}
            ${day.evening ? `
              <div class="history-content">
                <strong>Did it?</strong> ${day.evening.didIt ? 'YES âœ“' : 'NO'}
                <strong>Win:</strong> ${day.evening.todayWin}
              </div>
            ` : ''}
            ${day.morning && day.evening ? `
              <div class="history-scores">
                <span>Vitality: ${((day.morning.energy + day.morning.optimism) / 2).toFixed(1)}</span>
                <span>Courage: ${day.morning.confidence}</span>
                <span>Meaning: ${((day.evening.happiness + day.evening.connection) / 2).toFixed(1)}</span>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    // Storage using localStorage with migration from old window-based storage
    function saveToStorage() {
      try {
        localStorage.setItem('identityForgeData', JSON.stringify(entries));
        localStorage.setItem('identityForgeSettings', JSON.stringify({
          notificationsEnabled,
          morningReminderTime,
          eveningReminderTime
        }));
        console.log(`Saved ${entries.length} entries to localStorage`);
      } catch (e) {
        console.error('Failed to save to localStorage:', e);
      }
    }

    function loadFromStorage() {
      // Migration: Check for old window-based storage first
      if (window.identityForgeData && !localStorage.getItem('identityForgeData')) {
        console.log('Migrating data from window storage to localStorage...');
        try {
          localStorage.setItem('identityForgeData', window.identityForgeData);
          const migratedData = JSON.parse(window.identityForgeData);
          console.log(`Migrated ${migratedData.length} entries to localStorage`);
        } catch (e) {
          console.error('Migration failed:', e);
        }
      }

      if (window.identityForgeSettings && !localStorage.getItem('identityForgeSettings')) {
        try {
          localStorage.setItem('identityForgeSettings', window.identityForgeSettings);
          console.log('Migrated settings to localStorage');
        } catch (e) {
          console.error('Settings migration failed:', e);
        }
      }

      // Load from localStorage
      try {
        const data = localStorage.getItem('identityForgeData');
        if (data) {
          entries = JSON.parse(data);
          console.log(`Loaded ${entries.length} entries from localStorage`);
        } else {
          console.log('No saved data found');
        }
      } catch (e) {
        console.error('Failed to load data:', e);
        entries = [];
      }

      try {
        const settings = localStorage.getItem('identityForgeSettings');
        if (settings) {
          const parsed = JSON.parse(settings);
          notificationsEnabled = parsed.notificationsEnabled || false;
          morningReminderTime = parsed.morningReminderTime || '07:00';
          eveningReminderTime = parsed.eveningReminderTime || '21:00';
          console.log('Settings loaded successfully');
        }
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
    }
    
    // Notification functions
    async function toggleNotifications() {
      if (!notificationsEnabled) {
        // Request permission
        if (!("Notification" in window)) {
          showToast("This browser doesn't support notifications");
          return;
        }

        // Check if service worker is available (required for Samsung)
        if (!('serviceWorker' in navigator)) {
          showToast("Service workers not supported. Try Chrome or Samsung Internet.");
          return;
        }

        showToast("Requesting permission...");

        const permission = await Notification.requestPermission();

        if (permission === "granted") {
          // Wait for service worker to be ready
          try {
            const registration = await navigator.serviceWorker.ready;
            console.log('Service worker ready for notifications');

            notificationsEnabled = true;
            showToast("Notifications enabled! Tap 'Test' to verify.");
            saveToStorage();
            updateSettingsUI();
            scheduleNextNotifications();
          } catch (err) {
            console.error('Service worker issue:', err);
            showToast("Service worker error. Try refreshing the page.");
          }
        } else if (permission === "denied") {
          showToast("Permission denied. Enable in browser settings > Site settings > Notifications");
        } else {
          showToast("Permission dismissed. Try again.");
        }
      } else {
        // Disable notifications
        notificationsEnabled = false;
        showToast("Notifications disabled");
        saveToStorage();
        updateSettingsUI();
      }
    }
    
    function scheduleNextNotifications() {
      if (!notificationsEnabled) return;
      
      const now = new Date();
      const today = getTodayEntries();
      
      // Calculate next morning time
      const morningTime = new Date();
      const [mHour, mMin] = morningReminderTime.split(':');
      morningTime.setHours(parseInt(mHour), parseInt(mMin), 0, 0);
      
      // If morning time has passed today and morning is done, schedule for tomorrow
      if (morningTime < now || today.morning) {
        morningTime.setDate(morningTime.getDate() + 1);
      }
      
      // Calculate next evening time  
      const eveningTime = new Date();
      const [eHour, eMin] = eveningReminderTime.split(':');
      eveningTime.setHours(parseInt(eHour), parseInt(eMin), 0, 0);
      
      // If evening time has passed today or evening is done, schedule for tomorrow
      if (eveningTime < now || today.evening) {
        eveningTime.setDate(eveningTime.getDate() + 1);
      }
      
      // Schedule via service worker if available
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
          // Schedule morning notification if not done today
          if (!today.morning) {
            registration.active.postMessage({
              type: 'SCHEDULE_NOTIFICATION',
              title: 'ðŸ”¥ Morning Check-In',
              body: 'Your life matters. Your time is limited. Start your day with intention.',
              notifyAt: morningTime.getTime()
            });
            console.log('Morning notification scheduled for:', morningTime.toLocaleString());
          }
          
          // Schedule evening notification if morning is done but not evening
          if (today.morning && !today.evening) {
            registration.active.postMessage({
              type: 'SCHEDULE_NOTIFICATION',
              title: 'ðŸŒ™ Evening Reflection',
              body: 'Did you do what you said you\'d do? Complete your evening check-in.',
              notifyAt: eveningTime.getTime()
            });
            console.log('Evening notification scheduled for:', eveningTime.toLocaleString());
          }
        }).catch(err => {
          console.error('Failed to schedule notifications:', err);
        });
      }
    }
    
    function loadNotificationSettings() {
      if (document.getElementById('morningTime')) {
        document.getElementById('morningTime').value = morningReminderTime;
      }
      if (document.getElementById('eveningTime')) {
        document.getElementById('eveningTime').value = eveningReminderTime;
      }
      updateSettingsUI();
    }
    
    function updateSettingsUI() {
      const toggle = document.getElementById('notifToggle');
      const status = document.getElementById('notifStatus');
      const settings = document.getElementById('notifSettings');
      const hint = document.getElementById('notifPermissionHint');

      if (notificationsEnabled) {
        toggle.classList.add('selected');
        status.textContent = 'ON';
        settings.style.display = 'block';
        hint.textContent = 'Notifications are active';
      } else {
        toggle.classList.remove('selected');
        status.textContent = 'OFF';
        settings.style.display = 'none';
        hint.textContent = 'Click to enable browser notifications';
      }

      // Update app version display
      const versionElement = document.getElementById('appVersion');
      if (versionElement) {
        versionElement.textContent = APP_VERSION;
      }

      // Update last ground check display
      updateGroundLastCheck();

      // Update principles monthly average
      updatePrinciplesSettingsDisplay();
    }

    // Update principles display in settings
    function updatePrinciplesSettingsDisplay() {
      const principlesAvgEl = document.getElementById('principlesMonthlyAvg');
      if (!principlesAvgEl) return;

      const stats = getPrinciplesStats();
      if (stats.count === 0) {
        principlesAvgEl.textContent = 'Not tracked yet';
      } else {
        principlesAvgEl.innerHTML = `This month: <strong style="color: var(--accent);">${stats.avg}</strong> principles per day (avg)`;
      }
    }
    
    function saveNotificationSettings() {
      morningReminderTime = document.getElementById('morningTime').value;
      eveningReminderTime = document.getElementById('eveningTime').value;
      saveToStorage();
      scheduleNextNotifications(); // Reschedule with new times
      showToast('Reminder times saved. Notifications rescheduled for ' + morningReminderTime + ' and ' + eveningReminderTime);
    }
    
    async function testNotification() {
      if (!notificationsEnabled) {
        showToast('Enable notifications first');
        return;
      }

      if (!("Notification" in window)) {
        showToast("This browser doesn't support notifications");
        return;
      }

      if (Notification.permission !== "granted") {
        showToast("Notification permission not granted. Please enable in browser settings.");
        return;
      }

      // Check if service worker is ready (required for Samsung)
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.ready;
          if (!registration.active) {
            showToast("Service worker not active. Try refreshing the page.");
            return;
          }
        } catch (err) {
          showToast("Service worker error: " + err.message);
          return;
        }
      }

      showToast('Sending notification...');

      await sendNotification(
        'Test Notification',
        'Your notifications are working! You will receive reminders at your set times.',
        'settings'
      );

      // Delay the success message so user sees the notification first
      setTimeout(() => {
        showToast('Notification sent! Check your notification panel.');
      }, 500);
    }
    
    function startNotificationChecker() {
      // Check every 15 seconds for notifications
      notificationCheckInterval = setInterval(checkAndSendNotifications, 15000);
      // Check immediately
      checkAndSendNotifications();

      // Also check when app becomes visible (user returns to app)
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          console.log('App visible, checking for missed notifications...');
          checkAndSendNotifications();
        }
      });

      // Check when window gets focus
      window.addEventListener('focus', () => {
        console.log('Window focused, checking notifications...');
        checkAndSendNotifications();
      });
    }

    // Helper to parse time string to minutes since midnight
    function timeToMinutes(timeStr) {
      const [hours, mins] = timeStr.split(':').map(Number);
      return hours * 60 + mins;
    }

    // Helper to get today's date string for storage keys
    function getTodayDateString() {
      return new Date().toISOString().split('T')[0];
    }

    // Load last notification times from storage
    function getLastNotificationTime(type) {
      const key = `lastNotif_${type}_${getTodayDateString()}`;
      const stored = localStorage.getItem(key);
      return stored ? parseInt(stored, 10) : 0;
    }

    // Save last notification time to storage
    function setLastNotificationTime(type) {
      const key = `lastNotif_${type}_${getTodayDateString()}`;
      localStorage.setItem(key, Date.now().toString());
    }

    function checkAndSendNotifications() {
      if (!notificationsEnabled) return;
      if (!("Notification" in window) || Notification.permission !== "granted") return;

      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      const today = getTodayEntries();

      const morningMinutes = timeToMinutes(morningReminderTime);
      const eveningMinutes = timeToMinutes(eveningReminderTime);

      // Use a 5-minute window to catch notifications even if check was delayed
      const WINDOW_MINUTES = 5;

      // Check if we've already sent today (persisted in localStorage)
      const lastMorningNotif = getLastNotificationTime('morning');
      const lastEveningNotif = getLastNotificationTime('evening');
      const tenMinutesAgo = Date.now() - (10 * 60 * 1000);

      // Morning reminder - trigger if within window and not already sent today
      const morningDiff = currentMinutes - morningMinutes;
      if (morningDiff >= 0 && morningDiff <= WINDOW_MINUTES && !today.morning && lastMorningNotif < tenMinutesAgo) {
        console.log('Sending morning notification...');
        sendNotification(
          'Morning Check-In',
          'Your life matters. Your time is limited. Start your day with intention.',
          'morning'
        );
        setLastNotificationTime('morning');
      }

      // Evening reminder - trigger if within window and morning is done
      const eveningDiff = currentMinutes - eveningMinutes;
      if (eveningDiff >= 0 && eveningDiff <= WINDOW_MINUTES && today.morning && !today.evening && lastEveningNotif < tenMinutesAgo) {
        console.log('Sending evening notification...');
        sendNotification(
          'Evening Reflection',
          'Did you do what you said you\'d do? Complete your evening check-in.',
          'evening'
        );
        setLastNotificationTime('evening');
      }
    }
    
    async function sendNotification(title, body, type) {
      if (!("Notification" in window) || Notification.permission !== "granted") {
        console.log('Notification permission not granted');
        return;
      }

      // Use Service Worker for notifications (required for Samsung/Android)
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.ready;
          await registration.showNotification(title, {
            body: body,
            icon: '/icons/icon-192.png',
            badge: '/icons/icon-192.png',
            vibrate: [200, 100, 200, 100, 200],
            tag: 'identity-forge-' + type,
            requireInteraction: true,
            actions: [
              { action: 'open', title: 'Open App' },
              { action: 'dismiss', title: 'Dismiss' }
            ],
            data: { type: type }
          });
          console.log('Notification sent via Service Worker');
          return;
        } catch (err) {
          console.error('Service Worker notification failed:', err);
        }
      }

      // Fallback to direct notification (desktop browsers)
      try {
        const notification = new Notification(title, {
          body: body,
          icon: '/icons/icon-192.png',
          badge: '/icons/icon-192.png',
          requireInteraction: false,
          silent: false
        });

        notification.onclick = function() {
          window.focus();
          switchView(type);
          notification.close();
        };
      } catch (err) {
        console.error('Direct notification failed:', err);
      }
    }
    
    // Data management
    function exportData() {
      const dataStr = JSON.stringify({
        entries: entries,
        exportDate: new Date().toISOString(),
        version: '1.0'
      }, null, 2);
      
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `identity-forge-backup-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('Data exported successfully');
    }
    
    function confirmReset() {
      if (confirm('Are you absolutely sure? This will delete ALL your entries and cannot be undone.')) {
        if (confirm('Last chance. Delete everything?')) {
          entries = [];
          saveToStorage();
          updateStats();
          displayHistory();
          showToast('All data cleared');
        }
      }
    }
    
    // Toast notification
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ===== PRINCIPLES SECTION =====

    // Get today's principle (based on day of week)
    function getTodayPrinciple() {
      const dayOfWeek = new Date().getDay(); // 0 (Sun) to 6 (Sat)
      // Map: Sun=7, Mon=1, Tue=2, Wed=3, Thu=4, Fri=5, Sat=6
      const principleIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
      return principles[principleIndex];
    }

    // Load principles data from localStorage
    function loadPrinciplesData() {
      try {
        const data = localStorage.getItem('principlesData');
        if (data) {
          principlesData = JSON.parse(data);
          // Clean up entries older than 90 days
          const ninetyDaysAgo = new Date();
          ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
          principlesData.tracking = principlesData.tracking.filter(entry => {
            return new Date(entry.date) > ninetyDaysAgo;
          });
          savePrinciplesData();
          console.log(`Loaded ${principlesData.tracking.length} principles tracking entries`);
        }
      } catch (e) {
        console.error('Failed to load principles data:', e);
        principlesData = { tracking: [] };
      }
    }

    // Save principles data to localStorage
    function savePrinciplesData() {
      try {
        localStorage.setItem('principlesData', JSON.stringify(principlesData));
      } catch (e) {
        console.error('Failed to save principles data:', e);
      }
    }

    // Save today's principles tracking (called from saveEvening)
    function savePrinciplesTracking() {
      const today = new Date().toISOString().split('T')[0];
      const reflection = document.getElementById('principlesReflection')?.value || '';

      // Remove existing entry for today
      principlesData.tracking = principlesData.tracking.filter(entry => entry.date !== today);

      // Add new entry
      principlesData.tracking.push({
        date: today,
        principlesHonored: [...selectedPrinciples],
        reflection: reflection
      });

      savePrinciplesData();
    }

    // Initialize principles UI (called on app load)
    function initPrinciplesUI() {
      // Set up morning principle reminder
      updateMorningPrincipleReminder();
      // Set up evening checkboxes
      initPrinciplesCheckboxes();
    }

    // Update morning principle reminder
    function updateMorningPrincipleReminder() {
      const todayPrinciple = getTodayPrinciple();
      const morningTextEl = document.getElementById('morningPrincipleText');
      const morningPromptEl = document.getElementById('morningPrinciplePrompt');

      if (morningTextEl) {
        morningTextEl.textContent = `Principle #${todayPrinciple.number}: ${todayPrinciple.full}`;
      }
      if (morningPromptEl) {
        morningPromptEl.textContent = todayPrinciple.prompt;
      }
    }

    // Initialize principles checkboxes in evening view
    function initPrinciplesCheckboxes() {
      const container = document.getElementById('principlesCheckboxList');
      if (!container) return;

      // Check if already tracked today
      const today = new Date().toISOString().split('T')[0];
      const todayEntry = principlesData.tracking.find(e => e.date === today);

      if (todayEntry) {
        selectedPrinciples = [...todayEntry.principlesHonored];
      }

      container.innerHTML = principles.map(p => {
        const isChecked = selectedPrinciples.includes(p.number);
        return `
          <div class="principle-checkbox-item ${isChecked ? 'checked' : ''}" onclick="togglePrincipleCheckbox(${p.number})">
            <div class="principle-checkbox">${isChecked ? 'âœ“' : ''}</div>
            <div class="principle-checkbox-text">${p.number}. ${p.short}</div>
          </div>
        `;
      }).join('');
    }

    // Toggle principle checkbox
    function togglePrincipleCheckbox(principleNumber) {
      const index = selectedPrinciples.indexOf(principleNumber);
      if (index > -1) {
        selectedPrinciples.splice(index, 1);
      } else {
        selectedPrinciples.push(principleNumber);
      }
      initPrinciplesCheckboxes();
    }

    // Update the main Principles view
    function updatePrinciplesView() {
      updateTodayPrincipleCard();
      updatePrinciplesList();
      updateWeeklyTracking();
      updateMonthlyStats();
    }

    // Update Today's Principle card in Principles view
    function updateTodayPrincipleCard() {
      const todayPrinciple = getTodayPrinciple();
      const numberEl = document.getElementById('todayPrincipleNumber');
      const textEl = document.getElementById('todayPrincipleText');
      const statusEl = document.getElementById('todayPrincipleStatus');

      if (numberEl) numberEl.textContent = `Principle #${todayPrinciple.number}`;
      if (textEl) textEl.textContent = todayPrinciple.full;

      // Check if today was tracked
      const today = new Date().toISOString().split('T')[0];
      const todayEntry = principlesData.tracking.find(e => e.date === today);

      if (statusEl) {
        if (todayEntry) {
          const honored = todayEntry.principlesHonored.includes(todayPrinciple.number);
          if (honored) {
            statusEl.textContent = 'âœ“ Honored today';
            statusEl.classList.add('honored');
          } else {
            statusEl.textContent = 'Not honored today';
            statusEl.classList.remove('honored');
          }
        } else {
          statusEl.textContent = 'Check in evening';
          statusEl.classList.remove('honored');
        }
      }
    }

    // Update Principles list in Principles view
    function updatePrinciplesList() {
      const container = document.getElementById('principlesList');
      if (!container) return;

      const todayPrinciple = getTodayPrinciple();

      container.innerHTML = principles.map(p => `
        <div class="principle-item ${p.number === todayPrinciple.number ? 'today-highlight' : ''}">
          <div class="principle-number">${p.number}</div>
          <div class="principle-text">${p.full}</div>
        </div>
      `).join('');
    }

    // Update weekly tracking display
    function updateWeeklyTracking() {
      const container = document.getElementById('weeklyTracking');
      const weekScoreEl = document.getElementById('weekScoreValue');
      if (!container) return;

      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const today = new Date();
      const todayDayIndex = today.getDay();

      // Get last 7 days
      const weekDays = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        weekDays.push({
          date: date,
          dayName: days[date.getDay()],
          dateStr: date.toISOString().split('T')[0],
          isToday: i === 0
        });
      }

      let totalPrinciples = 0;

      container.innerHTML = weekDays.map(day => {
        const entry = principlesData.tracking.find(e => e.date === day.dateStr);
        let content = 'â€”';

        if (entry && entry.principlesHonored.length > 0) {
          const principleNums = entry.principlesHonored.sort((a, b) => a - b);
          content = `<span class="honored">âœ“ #${principleNums.join(', #')} (${principleNums.length})</span>`;
          totalPrinciples += principleNums.length;
        } else if (day.isToday) {
          content = 'Track in evening';
        }

        return `
          <div class="week-day-row ${day.isToday ? 'today' : ''}">
            <div class="week-day-name">${day.dayName}</div>
            <div class="week-day-principles">${content}</div>
          </div>
        `;
      }).join('');

      if (weekScoreEl) {
        weekScoreEl.textContent = totalPrinciples;
      }
    }

    // Update monthly stats display
    function updateMonthlyStats() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      // Filter entries for current month
      const monthEntries = principlesData.tracking.filter(entry => {
        const entryDate = new Date(entry.date);
        return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
      });

      if (monthEntries.length === 0) {
        document.getElementById('mostHonoredPrinciple').textContent = 'Not enough data';
        document.getElementById('leastHonoredPrinciple').textContent = 'Not enough data';
        document.getElementById('bestDayPrinciple').textContent = 'Not enough data';
        document.getElementById('avgPrinciplesDay').textContent = 'Not enough data';
        return;
      }

      // Count occurrences of each principle
      const counts = {};
      principles.forEach(p => counts[p.number] = 0);

      let bestDay = null;
      let bestDayCount = 0;
      let totalPrinciples = 0;

      monthEntries.forEach(entry => {
        const count = entry.principlesHonored.length;
        totalPrinciples += count;

        if (count > bestDayCount) {
          bestDayCount = count;
          bestDay = entry.date;
        }

        entry.principlesHonored.forEach(num => {
          counts[num]++;
        });
      });

      // Find most and least honored
      let mostHonored = { num: 1, count: 0 };
      let leastHonored = { num: 1, count: Infinity };

      Object.entries(counts).forEach(([num, count]) => {
        if (count > mostHonored.count) {
          mostHonored = { num: parseInt(num), count };
        }
        if (count < leastHonored.count) {
          leastHonored = { num: parseInt(num), count };
        }
      });

      // Update display
      const mostPrinciple = principles.find(p => p.number === mostHonored.num);
      const leastPrinciple = principles.find(p => p.number === leastHonored.num);

      document.getElementById('mostHonoredPrinciple').innerHTML =
        `<span class="highlight">#${mostHonored.num}</span> - ${mostPrinciple.short} (${mostHonored.count} times)`;

      document.getElementById('leastHonoredPrinciple').innerHTML =
        `<span class="highlight">#${leastHonored.num}</span> - ${leastPrinciple.short} (${leastHonored.count} times)`;

      if (bestDay) {
        const bestDate = new Date(bestDay);
        const formatted = bestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        document.getElementById('bestDayPrinciple').innerHTML =
          `${formatted} (<span class="highlight">${bestDayCount}/7</span> principles)`;
      }

      const avg = (totalPrinciples / monthEntries.length).toFixed(1);
      document.getElementById('avgPrinciplesDay').innerHTML =
        `<span class="highlight">${avg}</span> principles per day`;
    }

    // Get principles stats for settings
    function getPrinciplesStats() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      const monthEntries = principlesData.tracking.filter(entry => {
        const entryDate = new Date(entry.date);
        return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
      });

      if (monthEntries.length === 0) {
        return { avg: 0, count: 0 };
      }

      let total = 0;
      monthEntries.forEach(entry => {
        total += entry.principlesHonored.length;
      });

      return {
        avg: (total / monthEntries.length).toFixed(1),
        count: monthEntries.length
      };
    }

    // ===== END PRINCIPLES SECTION =====

    // Initialize on load
    // ===== GROUND CHECK (Reality Check) =====

    // Ground check questions data
    const groundQuestions = [
      // Category 1: Family & Love
      {
        question: "Did you grow up with both parents present and involved in your life?",
        yesResponse: "Millions grew up without one or both parents. You had stability, support, love from day one. That's wealth most never know.",
        noResponse: "That absence shaped you. Acknowledge it.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Do you have a healthy child in your life?",
        yesResponse: "Some parents bury their children. Yours is alive, healthy, watching you. Every day with him is a gift denied to many.",
        noResponse: "That longing is real. Honor it.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Is there someone who would drop everything to help you if you called right now?",
        yesResponse: "Most people die without experiencing that level of loyalty. You have it. When did you last tell them they matter?",
        noResponse: "That solitude teaches strength. But connection is still possible.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      // Category 2: Health & Body
      {
        question: "Can you walk, run, and move your body without assistance?",
        yesResponse: "Right now someone your age is in a wheelchair wishing they could do what you're avoiding. Your legs work. Use them.",
        noResponse: "Your body has limits. You're working with what you have. That takes courage.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Is your mind clear enough to read, think, plan, and make decisions?",
        yesResponse: "Mental clarity is priceless. People lose it to disease, trauma, age. You have it right now. Are you using it to build or to worry?",
        noResponse: "Mental fog is real. Seeking help is strength, not weakness.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Did you wake up today without chronic physical pain?",
        yesResponse: "That alone makes you wealthier than millions who suffer daily. You have a body that doesn't fight you. What are you waiting for?",
        noResponse: "Pain is a relentless teacher. You're still here. That's resilience.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Can you see clearly, hear sounds, and speak your thoughts?",
        yesResponse: "People would give everything for what you take for granted. You can witness beauty, hear your son laugh, speak your truth. Why aren't you?",
        noResponse: "You've adapted to limitation. That's a different kind of strength.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      // Category 3: Opportunity & Freedom
      {
        question: "Were you born in a country without war, persecution, or violent oppression?",
        yesResponse: "Billions live in fear, violence, chaos. You were born into peace and freedom. That's not luckâ€”that's massive privilege. What are you building with it?",
        noResponse: "You know what instability costs. That knowledge is power.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Did you receive an education that taught you to read, write, think, and learn independently?",
        yesResponse: "Most of humanity never gets that. You can teach yourself anything. That's a superpower. Are you expanding or stagnating?",
        noResponse: "You've taught yourself despite the gaps. That resourcefulness matters.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Have you traveled beyond your home country and experienced other cultures?",
        yesResponse: "You're a citizen of the world while others never leave their village. You've seen perspective most never get. What are you doing with it?",
        noResponse: "Your world is smaller but no less rich. Depth beats breadth.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Can you choose how you earn money and spend your time?",
        yesResponse: "That's not normalâ€”that's extraordinary. You're not forced into labor. You choose your path. So why are you choosing to play small?",
        noResponse: "Limited freedom sharpens focus. You work with what you control.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      // Category 4: Resources & Security
      {
        question: "Do you have access to clean water whenever you want it?",
        yesResponse: "Half the world doesn't. You turn a tap and life flows out. Basic survival isn't your struggle. What worthy problem are you solving instead?",
        noResponse: "Scarcity teaches gratitude. You know what matters.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Do you have a safe, warm place to sleep tonight?",
        yesResponse: "People sleep on streets, in war zones, in fear. You have shelter. Safety. Peace. What are you doing with that security?",
        noResponse: "Instability is exhausting. You're surviving it. That takes everything.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Do you have enough food that you never go to bed hungry?",
        yesResponse: "Hunger is not your battle. You have the luxury of choosing harder problems. Are you choosing worthy ones?",
        noResponse: "Food insecurity is invisible suffering. You're navigating it.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      },
      {
        question: "Do you have daily access to the internet and unlimited information?",
        yesResponse: "You carry the entire library of human knowledge in your pocket. Billions don't. What are you learning? What are you creating?",
        noResponse: "You find ways without easy access. That's resourcefulness.",
        yesPrompt: "Name one way you will respect this gift today.",
        noPrompt: "What would having this change for you?"
      }
    ];

    // Ground check state
    let groundState = {
      mode: null,
      questionIndices: [],
      currentIndex: 0,
      currentAnswer: null,
      responses: [],
      inProgress: false
    };

    // Initialize Ground view
    function initGroundView() {
      loadGroundData();
      updateGroundLastCheck();
      checkForResume();
      showGroundScreen('groundModeSelect');
    }

    // Load ground data from localStorage
    function loadGroundData() {
      try {
        const data = localStorage.getItem('groundCheckData');
        if (data) {
          return JSON.parse(data);
        }
      } catch (e) {
        console.error('Failed to load ground data:', e);
      }
      return null;
    }

    // Save ground data to localStorage
    function saveGroundData(data) {
      try {
        localStorage.setItem('groundCheckData', JSON.stringify(data));
      } catch (e) {
        console.error('Failed to save ground data:', e);
      }
    }

    // Save in-progress state
    function saveGroundProgress() {
      try {
        localStorage.setItem('groundCheckProgress', JSON.stringify(groundState));
      } catch (e) {
        console.error('Failed to save ground progress:', e);
      }
    }

    // Load in-progress state
    function loadGroundProgress() {
      try {
        const data = localStorage.getItem('groundCheckProgress');
        if (data) {
          return JSON.parse(data);
        }
      } catch (e) {
        console.error('Failed to load ground progress:', e);
      }
      return null;
    }

    // Clear in-progress state
    function clearGroundProgress() {
      localStorage.removeItem('groundCheckProgress');
    }

    // Update last check display
    function updateGroundLastCheck() {
      const data = loadGroundData();
      const lastCheckDisplay = document.getElementById('groundLastCheckDisplay');
      const settingsLastCheck = document.getElementById('lastGroundCheck');

      if (data && data.lastCompleted) {
        const date = new Date(data.lastCompleted);
        const formatted = date.toLocaleDateString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
        if (lastCheckDisplay) lastCheckDisplay.textContent = `Last check: ${formatted}`;
        if (settingsLastCheck) settingsLastCheck.textContent = formatted;
      } else {
        if (lastCheckDisplay) lastCheckDisplay.textContent = 'Last check: Never';
        if (settingsLastCheck) settingsLastCheck.textContent = 'Never completed';
      }
    }

    // Check if there's a resumable session
    function checkForResume() {
      const progress = loadGroundProgress();
      const resumeOption = document.getElementById('groundResumeOption');

      if (progress && progress.inProgress && progress.responses.length > 0) {
        resumeOption.style.display = 'block';
      } else {
        resumeOption.style.display = 'none';
      }
    }

    // Show a specific ground screen
    function showGroundScreen(screenId) {
      const screens = document.querySelectorAll('.ground-screen');
      screens.forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    // Start ground check
    function startGroundCheck(mode) {
      groundState = {
        mode: mode,
        questionIndices: [],
        currentIndex: 0,
        currentAnswer: null,
        responses: [],
        inProgress: true
      };

      if (mode === 'quick') {
        // Random 5 questions
        const indices = [];
        while (indices.length < 5) {
          const rand = Math.floor(Math.random() * groundQuestions.length);
          if (!indices.includes(rand)) {
            indices.push(rand);
          }
        }
        groundState.questionIndices = indices;
      } else {
        // All 15 questions in order
        groundState.questionIndices = groundQuestions.map((_, i) => i);
      }

      clearGroundProgress();
      saveGroundProgress();
      showQuestion();
    }

    // Resume ground check
    function resumeGroundCheck() {
      const progress = loadGroundProgress();
      if (progress && progress.inProgress) {
        groundState = progress;
        showQuestion();
      } else {
        showToast('No session to resume');
        checkForResume();
      }
    }

    // Show current question
    function showQuestion() {
      showGroundScreen('groundQuestion');

      const total = groundState.questionIndices.length;
      const current = groundState.currentIndex + 1;
      const qIndex = groundState.questionIndices[groundState.currentIndex];
      const q = groundQuestions[qIndex];

      // Update progress
      document.getElementById('groundProgressText').textContent = `${current} / ${total}`;
      document.getElementById('groundProgressFill').style.width = `${(current / total) * 100}%`;

      // Update question
      document.getElementById('groundQuestionText').textContent = q.question;

      // Reset answer state
      groundState.currentAnswer = null;
      document.getElementById('groundYes').classList.remove('selected');
      document.getElementById('groundNo').classList.remove('selected');
      document.getElementById('groundResponseArea').style.display = 'none';
      document.getElementById('groundCommitmentInput').value = '';
      document.getElementById('groundNextBtn').style.display = 'none';
    }

    // Handle yes/no answer
    function groundAnswer(answer) {
      groundState.currentAnswer = answer;

      const qIndex = groundState.questionIndices[groundState.currentIndex];
      const q = groundQuestions[qIndex];

      // Update button states
      document.getElementById('groundYes').classList.toggle('selected', answer === 'yes');
      document.getElementById('groundNo').classList.toggle('selected', answer === 'no');

      // Show response area
      document.getElementById('groundResponseArea').style.display = 'block';

      if (answer === 'yes') {
        document.getElementById('groundTruthText').textContent = q.yesResponse;
        document.getElementById('groundCommitmentLabel').textContent = q.yesPrompt;
        document.getElementById('groundCommitmentInput').placeholder = 'I will...';
        document.getElementById('groundCommitmentInput').required = true;
        document.getElementById('groundNextBtn').style.display = 'none';

        // Add input listener for required field
        const input = document.getElementById('groundCommitmentInput');
        input.oninput = function() {
          document.getElementById('groundNextBtn').style.display = this.value.trim() ? 'block' : 'none';
        };
      } else {
        document.getElementById('groundTruthText').textContent = q.noResponse;
        document.getElementById('groundCommitmentLabel').textContent = q.noPrompt;
        document.getElementById('groundCommitmentInput').placeholder = '(Optional)';
        document.getElementById('groundCommitmentInput').required = false;
        document.getElementById('groundNextBtn').style.display = 'block';

        // Remove required input listener
        document.getElementById('groundCommitmentInput').oninput = null;
      }
    }

    // Go to next question
    function groundNext() {
      const qIndex = groundState.questionIndices[groundState.currentIndex];
      const q = groundQuestions[qIndex];
      const commitment = document.getElementById('groundCommitmentInput').value.trim();

      // Validate if yes answer
      if (groundState.currentAnswer === 'yes' && !commitment) {
        showToast('Please enter your commitment');
        return;
      }

      // Save response
      groundState.responses.push({
        questionIndex: qIndex,
        question: q.question,
        answer: groundState.currentAnswer,
        commitment: commitment || null
      });

      // Save progress
      groundState.currentIndex++;
      saveGroundProgress();

      // Check if complete
      if (groundState.currentIndex >= groundState.questionIndices.length) {
        completeGroundCheck();
      } else {
        showQuestion();
      }
    }

    // Exit ground check (save progress)
    function exitGroundCheck() {
      if (groundState.inProgress && groundState.responses.length > 0) {
        saveGroundProgress();
        showToast('Progress saved. You can resume later.');
      }
      showGroundScreen('groundModeSelect');
      checkForResume();
    }

    // Complete ground check
    function completeGroundCheck() {
      groundState.inProgress = false;
      clearGroundProgress();

      // Count wealth (yes answers)
      const wealthCount = groundState.responses.filter(r => r.answer === 'yes').length;
      const totalQuestions = groundState.questionIndices.length;

      // Save completed data
      const data = {
        lastCompleted: new Date().toISOString(),
        mode: groundState.mode,
        totalWealth: wealthCount,
        responses: groundState.responses
      };
      saveGroundData(data);

      // Update displays
      updateGroundLastCheck();

      // Show summary
      document.getElementById('groundWealthCount').textContent = wealthCount;
      document.getElementById('groundSummaryWealth').textContent = wealthCount;
      document.getElementById('groundSummaryTotal').textContent = totalQuestions;
      document.getElementById('groundSummaryDate').textContent = new Date().toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });

      showGroundScreen('groundSummary');
    }

    // View commitments
    function viewGroundCommitments() {
      const data = loadGroundData();
      const list = document.getElementById('groundCommitmentsList');

      if (!data || !data.responses) {
        list.innerHTML = '<p style="color: var(--text-dim);">No commitments recorded.</p>';
        showGroundScreen('groundCommitments');
        return;
      }

      const commitments = data.responses.filter(r => r.answer === 'yes' && r.commitment);

      if (commitments.length === 0) {
        list.innerHTML = '<p style="color: var(--text-dim);">No commitments recorded.</p>';
      } else {
        list.innerHTML = commitments.map(c => `
          <div class="ground-commitment-item">
            <div class="ground-commitment-q">${c.question}</div>
            <div class="ground-commitment-a">${c.commitment}</div>
          </div>
        `).join('');
      }

      showGroundScreen('groundCommitments');
    }

    // Show ground summary
    function showGroundSummary() {
      showGroundScreen('groundSummary');
    }

    // Reset ground check
    function resetGroundCheck() {
      groundState = {
        mode: null,
        questionIndices: [],
        currentIndex: 0,
        currentAnswer: null,
        responses: [],
        inProgress: false
      };
      clearGroundProgress();
      showGroundScreen('groundModeSelect');
      checkForResume();
    }

    // ===== END GROUND CHECK =====

    // ===== EXECUTION & PRESENCE TRACKING SYSTEM =====

    // Tracking State
    let executionData = {};
    let presenceData = {};
    let streaksData = {
      planStreak: { current: 0, best: 0 },
      awarenessStreak: { current: 0, best: 0 },
      completeStreak: { current: 0, best: 0 }
    };
    let badges = {
      executionWeek: { earned: false, date: null },
      presenceWeek: { earned: false, date: null },
      perfectDay: { earned: false, date: null },
      thirtyDay: { earned: false, date: null }
    };

    // Time block management
    let timeBlocks = [];
    let editingBlockId = null;

    // Presence check state
    let presenceOptions = {
      caughtUrge: false,
      used5Second: false,
      stayedPresent: false,
      brokePlan: false
    };
    let selectedBlockStatus = null;
    let intentionHonored = false;

    // Load tracking data
    function loadTrackingData() {
      try {
        const today = getTodayDateString();

        // Load execution data
        const execData = localStorage.getItem('executionData');
        if (execData) {
          const parsed = JSON.parse(execData);
          executionData = parsed;
          // Load today's time blocks if they exist
          if (executionData.date === today && executionData.timeBlocks) {
            timeBlocks = executionData.timeBlocks;
          } else if (executionData.date !== today) {
            // New day, reset execution data but keep time blocks if morning not done
            timeBlocks = [];
            executionData = { date: today, timeBlocks: [], executionScore: 0 };
          }
        } else {
          executionData = { date: today, timeBlocks: [], executionScore: 0 };
        }

        // Load presence data
        const presData = localStorage.getItem('presenceData');
        if (presData) {
          const parsed = JSON.parse(presData);
          if (parsed.date === today) {
            presenceData = parsed;
          } else {
            presenceData = { date: today, checks: [], presenceScore: 0 };
          }
        } else {
          presenceData = { date: today, checks: [], presenceScore: 0 };
        }

        // Load streaks data
        const streaks = localStorage.getItem('streaksData');
        if (streaks) {
          streaksData = JSON.parse(streaks);
        }

        // Load badges
        const badgesData = localStorage.getItem('badgesData');
        if (badgesData) {
          badges = JSON.parse(badgesData);
        }

        console.log('Tracking data loaded');
      } catch (e) {
        console.error('Failed to load tracking data:', e);
      }
    }

    // Save tracking data
    function saveTrackingData() {
      try {
        localStorage.setItem('executionData', JSON.stringify(executionData));
        localStorage.setItem('presenceData', JSON.stringify(presenceData));
        localStorage.setItem('streaksData', JSON.stringify(streaksData));
        localStorage.setItem('badgesData', JSON.stringify(badges));
      } catch (e) {
        console.error('Failed to save tracking data:', e);
      }
    }

    // ===== TIME BLOCK MANAGEMENT =====

    function showAddBlockForm() {
      document.getElementById('addBlockForm').classList.add('active');
      document.getElementById('addBlockBtn').style.display = 'none';
      editingBlockId = null;
      // Clear form
      document.getElementById('blockActivity').value = '';
      document.getElementById('blockIntention').value = '';
    }

    function cancelAddBlock() {
      document.getElementById('addBlockForm').classList.remove('active');
      document.getElementById('addBlockBtn').style.display = 'block';
      editingBlockId = null;
    }

    function saveTimeBlock() {
      const startTime = document.getElementById('blockStartTime').value;
      const endTime = document.getElementById('blockEndTime').value;
      const activity = document.getElementById('blockActivity').value.trim();
      const intention = document.getElementById('blockIntention').value.trim();

      if (!activity) {
        showToast('Please enter an activity');
        return;
      }

      if (!intention) {
        showToast('Please enter your intention');
        return;
      }

      // Validate times
      if (startTime >= endTime) {
        showToast('End time must be after start time');
        return;
      }

      // Check for overlaps
      const newStart = timeToMinutes(startTime);
      const newEnd = timeToMinutes(endTime);

      for (const block of timeBlocks) {
        if (editingBlockId && block.id === editingBlockId) continue;

        const blockStart = timeToMinutes(block.startTime);
        const blockEnd = timeToMinutes(block.endTime);

        if ((newStart < blockEnd && newEnd > blockStart)) {
          showToast('Time blocks cannot overlap');
          return;
        }
      }

      // Check max blocks
      if (!editingBlockId && timeBlocks.length >= 10) {
        showToast('Maximum 10 time blocks per day');
        return;
      }

      if (editingBlockId) {
        // Update existing block
        const index = timeBlocks.findIndex(b => b.id === editingBlockId);
        if (index !== -1) {
          timeBlocks[index] = {
            ...timeBlocks[index],
            startTime,
            endTime,
            activity,
            intention
          };
        }
      } else {
        // Add new block
        const newBlock = {
          id: 'block_' + Date.now(),
          startTime,
          endTime,
          activity,
          intention,
          status: 'upcoming',
          honoredIntention: false,
          notes: ''
        };
        timeBlocks.push(newBlock);
      }

      // Sort blocks by start time
      timeBlocks.sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));

      // Update execution data
      executionData.timeBlocks = timeBlocks;
      executionData.date = getTodayDateString();
      saveTrackingData();

      // Update UI
      cancelAddBlock();
      renderMorningTimeBlocks();
      updateBlockCount();
      updateLiveScores();
      showToast(editingBlockId ? 'Block updated' : 'Block added');
    }

    function editTimeBlock(blockId) {
      const block = timeBlocks.find(b => b.id === blockId);
      if (!block) return;

      editingBlockId = blockId;
      document.getElementById('blockStartTime').value = block.startTime;
      document.getElementById('blockEndTime').value = block.endTime;
      document.getElementById('blockActivity').value = block.activity;
      document.getElementById('blockIntention').value = block.intention;

      document.getElementById('addBlockForm').classList.add('active');
      document.getElementById('addBlockBtn').style.display = 'none';
    }

    function deleteTimeBlock(blockId) {
      if (!confirm('Delete this time block?')) return;

      timeBlocks = timeBlocks.filter(b => b.id !== blockId);
      executionData.timeBlocks = timeBlocks;
      saveTrackingData();

      renderMorningTimeBlocks();
      updateBlockCount();
      updateLiveScores();
      showToast('Block deleted');
    }

    function renderMorningTimeBlocks() {
      const container = document.getElementById('morningTimeBlocks');
      const noBlocksMsg = document.getElementById('noBlocksMessage');

      if (timeBlocks.length === 0) {
        container.innerHTML = '';
        container.appendChild(noBlocksMsg);
        noBlocksMsg.style.display = 'block';
        return;
      }

      noBlocksMsg.style.display = 'none';
      container.innerHTML = timeBlocks.map(block => `
        <div class="time-block-item ${block.status}">
          <div class="time-block-header">
            <span class="time-block-time">${block.startTime} - ${block.endTime}</span>
          </div>
          <div class="time-block-activity">${block.activity}</div>
          <div class="time-block-intention">Intention: ${block.intention}</div>
          <div class="time-block-actions">
            <button class="time-block-btn" onclick="editTimeBlock('${block.id}')">Edit</button>
            <button class="time-block-btn" onclick="deleteTimeBlock('${block.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function updateBlockCount() {
      const countEl = document.getElementById('blockCount');
      if (countEl) {
        countEl.textContent = timeBlocks.length > 0 ? `Total Blocks: ${timeBlocks.length}` : '';
      }
    }

    // ===== TRACK VIEW FUNCTIONS =====

    function renderTrackTimeBlocks() {
      const container = document.getElementById('trackTimeBlocks');
      const noBlocksMsg = document.getElementById('noTrackBlocksMessage');

      if (timeBlocks.length === 0) {
        container.innerHTML = '';
        const msgDiv = document.createElement('div');
        msgDiv.className = 'empty-state';
        msgDiv.id = 'noTrackBlocksMessage';
        msgDiv.innerHTML = `
          <div class="empty-state-icon">ðŸ“…</div>
          <p>No plan created yet.</p>
          <p style="font-size: 0.85rem; color: var(--text-dim); margin-top: 8px;">Create your plan in the morning check-in to start tracking.</p>
          <button class="btn" onclick="switchView('morning')" style="margin-top: 16px; padding: 12px 24px; width: auto;">Go to Morning</button>
        `;
        container.appendChild(msgDiv);
        return;
      }

      // Update block statuses based on current time
      updateBlockStatuses();

      container.innerHTML = timeBlocks.map(block => {
        const statusIcon = getBlockStatusIcon(block.status);
        const statusText = getBlockStatusText(block.status);
        const statusClass = block.status;

        let actionBtn = '';
        if (block.status === 'in-progress' || block.status === 'upcoming') {
          actionBtn = `<button class="time-block-btn primary" onclick="openBlockCompleteModal('${block.id}')">Complete Now</button>`;
        } else if (block.status !== 'completed' && block.status !== 'skipped' && block.status !== 'partial') {
          actionBtn = `<button class="time-block-btn" onclick="openBlockCompleteModal('${block.id}')">Mark Status</button>`;
        }

        return `
          <div class="time-block-item ${statusClass}">
            <div class="time-block-header">
              <span class="time-block-status-icon">${statusIcon}</span>
              <span class="time-block-time">${block.startTime} - ${block.endTime}</span>
            </div>
            <div class="time-block-activity">${block.activity}</div>
            <div class="time-block-intention">Intention: ${block.intention}</div>
            <div class="time-block-status" style="color: ${getStatusColor(block.status)};">
              Status: ${statusText}
              ${block.honoredIntention ? ' â€¢ âœ“ Intention honored' : ''}
            </div>
            ${actionBtn ? `<div class="time-block-actions">${actionBtn}</div>` : ''}
          </div>
        `;
      }).join('');

      // Update execution score display
      updateExecutionScoreDisplay();
    }

    function updateBlockStatuses() {
      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();

      timeBlocks.forEach(block => {
        if (block.status === 'completed' || block.status === 'skipped' || block.status === 'partial') {
          return; // Don't change completed statuses
        }

        const startMinutes = timeToMinutes(block.startTime);
        const endMinutes = timeToMinutes(block.endTime);

        if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
          block.status = 'in-progress';
        } else if (currentMinutes >= endMinutes) {
          // Block time has passed but not marked - keep as upcoming to let user decide
          block.status = 'upcoming';
        } else {
          block.status = 'upcoming';
        }
      });

      executionData.timeBlocks = timeBlocks;
      saveTrackingData();
    }

    function getBlockStatusIcon(status) {
      switch (status) {
        case 'completed': return 'âœ…';
        case 'partial': return 'ðŸ”„';
        case 'skipped': return 'âŒ';
        case 'in-progress': return 'â³';
        case 'upcoming': return 'â°';
        default: return 'â°';
      }
    }

    function getBlockStatusText(status) {
      switch (status) {
        case 'completed': return 'COMPLETED';
        case 'partial': return 'PARTIAL';
        case 'skipped': return 'SKIPPED';
        case 'in-progress': return 'IN PROGRESS';
        case 'upcoming': return 'UPCOMING';
        default: return 'UPCOMING';
      }
    }

    function getStatusColor(status) {
      switch (status) {
        case 'completed': return 'var(--success)';
        case 'partial': return 'var(--warning)';
        case 'skipped': return '#ff4444';
        case 'in-progress': return 'var(--warning)';
        default: return 'var(--text-dim)';
      }
    }

    // ===== BLOCK COMPLETION MODAL =====

    function openBlockCompleteModal(blockId) {
      const block = timeBlocks.find(b => b.id === blockId);
      if (!block) return;

      document.getElementById('currentBlockId').value = blockId;
      document.getElementById('modalBlockTime').textContent = `${block.startTime} - ${block.endTime}`;
      document.getElementById('modalBlockActivity').textContent = block.activity;
      document.getElementById('modalIntentionText').textContent = `"${block.intention}"`;

      // Reset selections
      selectedBlockStatus = null;
      intentionHonored = false;
      document.querySelectorAll('#blockStatusOptions .presence-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      document.getElementById('intentionOption').classList.remove('selected');
      document.getElementById('blockNote').value = '';

      document.getElementById('blockCompleteModal').classList.add('active');
    }

    function closeBlockModal() {
      document.getElementById('blockCompleteModal').classList.remove('active');
    }

    function selectBlockStatus(status) {
      selectedBlockStatus = status;
      document.querySelectorAll('#blockStatusOptions .presence-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
    }

    function toggleIntentionHonored() {
      intentionHonored = !intentionHonored;
      document.getElementById('intentionOption').classList.toggle('selected', intentionHonored);
    }

    function completeBlock() {
      if (!selectedBlockStatus) {
        showToast('Please select a status');
        return;
      }

      const blockId = document.getElementById('currentBlockId').value;
      const note = document.getElementById('blockNote').value.trim();

      const index = timeBlocks.findIndex(b => b.id === blockId);
      if (index === -1) return;

      timeBlocks[index].status = selectedBlockStatus;
      timeBlocks[index].honoredIntention = intentionHonored;
      timeBlocks[index].notes = note;

      executionData.timeBlocks = timeBlocks;
      calculateExecutionScore();
      saveTrackingData();

      closeBlockModal();
      renderTrackTimeBlocks();
      updateLiveScores();

      const points = selectedBlockStatus === 'completed' ? 8 : (selectedBlockStatus === 'partial' ? 4 : -5);
      const bonus = intentionHonored ? 2 : 0;
      showToast(`Block ${selectedBlockStatus}! ${points + bonus >= 0 ? '+' : ''}${points + bonus} points`);
    }

    // ===== EXECUTION SCORE CALCULATION =====

    function calculateExecutionScore() {
      if (timeBlocks.length === 0) {
        executionData.executionScore = 0;
        return 0;
      }

      let score = 50; // Base score for having a plan

      timeBlocks.forEach(block => {
        switch (block.status) {
          case 'completed':
            score += 8;
            break;
          case 'partial':
            score += 4;
            break;
          case 'skipped':
            score -= 5;
            break;
        }

        if (block.honoredIntention && (block.status === 'completed' || block.status === 'partial')) {
          score += 2;
        }
      });

      // Check if evening review is done
      const todayEvening = getTodayEntries().evening;
      if (todayEvening) {
        score += 10;
      }

      // Cap at 100
      score = Math.max(0, Math.min(100, score));

      executionData.executionScore = score;
      return score;
    }

    function updateExecutionScoreDisplay() {
      const score = calculateExecutionScore();
      const scoreEl = document.getElementById('trackExecutionScore');
      const fillEl = document.getElementById('trackExecutionFill');

      if (scoreEl) {
        scoreEl.textContent = `${score}/100`;
        scoreEl.className = 'execution-score-value ' + getScoreColorClass(score);
      }

      if (fillEl) {
        fillEl.style.width = `${score}%`;
        fillEl.style.background = getScoreGradient(score);
      }
    }

    function getScoreColorClass(score) {
      if (score >= 90) return 'score-green';
      if (score >= 70) return 'score-yellow';
      if (score >= 50) return 'score-orange';
      return 'score-red';
    }

    function getScoreGradient(score) {
      if (score >= 90) return 'linear-gradient(90deg, #00ff88, #00cc6f)';
      if (score >= 70) return 'linear-gradient(90deg, #ffcc00, #ff9500)';
      if (score >= 50) return 'linear-gradient(90deg, #ff9500, #ff6600)';
      return 'linear-gradient(90deg, #ff4444, #ff0000)';
    }

    // ===== PRESENCE CHECK FUNCTIONS =====

    function openPresenceModal() {
      // Reset state
      presenceOptions = {
        caughtUrge: false,
        used5Second: false,
        stayedPresent: false,
        brokePlan: false
      };
      document.querySelectorAll('#presenceOptions .presence-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      document.getElementById('presenceThought').value = '';

      document.getElementById('presenceModal').classList.add('active');
    }

    function closePresenceModal() {
      document.getElementById('presenceModal').classList.remove('active');
    }

    function togglePresenceOption(option) {
      presenceOptions[option] = !presenceOptions[option];
      const el = document.getElementById('check-' + option).parentElement;
      el.classList.toggle('selected', presenceOptions[option]);
    }

    function logPresenceCheck() {
      const thought = document.getElementById('presenceThought').value.trim();

      if (!thought) {
        showToast('Please describe your thought/urge');
        return;
      }

      const check = {
        timestamp: new Date().toISOString(),
        thought: thought,
        caughtUrge: presenceOptions.caughtUrge,
        used5SecondRule: presenceOptions.used5Second,
        stayedPresent: presenceOptions.stayedPresent,
        brokePlan: presenceOptions.brokePlan
      };

      // Calculate points
      let points = 10; // Base points for logging
      if (presenceOptions.caughtUrge) points += 5;
      if (presenceOptions.used5Second) points += 10;
      if (presenceOptions.stayedPresent) points += 5;
      // brokePlan doesn't add/subtract - it's honest tracking

      // Update presence data
      if (!presenceData.checks) presenceData.checks = [];
      presenceData.checks.push(check);
      presenceData.presenceScore = (presenceData.presenceScore || 0) + points;
      presenceData.date = getTodayDateString();

      saveTrackingData();
      closePresenceModal();
      updateLiveScores();

      showToast(`+${points} Presence! Total: ${presenceData.presenceScore}`);
    }

    // ===== LIVE SCORES WIDGET =====

    function updateLiveScores() {
      // Execute Score
      const execScore = calculateExecutionScore();
      const execEl = document.getElementById('executeScoreValue');
      const execIndicator = document.getElementById('executeIndicator');
      if (execEl) {
        if (timeBlocks.length === 0) {
          execEl.textContent = '--';
          execEl.className = 'score-widget-value';
        } else {
          execEl.textContent = execScore;
          execEl.className = 'score-widget-value ' + getScoreColorClass(execScore);
        }
      }
      if (execIndicator) {
        execIndicator.textContent = getScoreIndicator(execScore, 'execution');
      }

      // Presence Score
      const presScore = presenceData.presenceScore || 0;
      const presEl = document.getElementById('presentScoreValue');
      const presIndicator = document.getElementById('presentIndicator');
      if (presEl) {
        presEl.textContent = presScore || '--';
        presEl.className = 'score-widget-value ' + getPresenceColorClass(presScore);
      }
      if (presIndicator) {
        presIndicator.textContent = getScoreIndicator(presScore, 'presence');
      }

      // Plan Score
      const completedBlocks = timeBlocks.filter(b => b.status === 'completed' || b.status === 'partial').length;
      const planEl = document.getElementById('planScoreValue');
      if (planEl) {
        if (timeBlocks.length === 0) {
          planEl.textContent = '--';
        } else {
          planEl.textContent = `${completedBlocks}/${timeBlocks.length}`;
        }
      }
    }

    function getPresenceColorClass(score) {
      if (score >= 81) return 'score-blue';
      if (score >= 51) return 'score-green';
      if (score >= 21) return 'score-yellow';
      return 'score-red';
    }

    function getScoreIndicator(score, type) {
      if (type === 'execution') {
        if (score >= 90) return 'ðŸŸ¢';
        if (score >= 70) return 'ðŸŸ¡';
        if (score >= 50) return 'ðŸŸ ';
        return 'ðŸ”´';
      } else {
        if (score >= 81) return 'ðŸ”µ';
        if (score >= 51) return 'ðŸŸ¢';
        if (score >= 21) return 'ðŸŸ¡';
        return 'ðŸ”´';
      }
    }

    // ===== EXECUTION DETAILS MODAL =====

    function openExecutionDetails() {
      const score = calculateExecutionScore();

      document.getElementById('modalExecutionScore').textContent = `${score}/100`;
      document.getElementById('modalExecutionScore').className = 'execution-score-value ' + getScoreColorClass(score);
      document.getElementById('modalExecutionFill').style.width = `${score}%`;
      document.getElementById('modalExecutionFill').style.background = getScoreGradient(score);

      const listEl = document.getElementById('modalBlocksList');
      if (timeBlocks.length === 0) {
        listEl.innerHTML = '<p style="color: var(--text-dim); text-align: center;">No plan created yet.</p>';
      } else {
        listEl.innerHTML = timeBlocks.map(block => `
          <div class="review-block-item">
            <span class="review-block-status">${getBlockStatusIcon(block.status)}</span>
            <span class="review-block-time">${block.startTime}</span>
            <span class="review-block-activity">${block.activity}</span>
          </div>
        `).join('');
      }

      document.getElementById('executionDetailsModal').classList.add('active');
    }

    function closeExecutionDetailsModal() {
      document.getElementById('executionDetailsModal').classList.remove('active');
    }

    // ===== PRESENCE LOG MODAL =====

    function openPresenceLog() {
      const score = presenceData.presenceScore || 0;
      const checks = presenceData.checks || [];

      document.getElementById('modalPresenceScore').textContent = score;
      document.getElementById('modalCheckCount').textContent = checks.length;

      const logEl = document.getElementById('modalPresenceLog');
      if (checks.length === 0) {
        logEl.innerHTML = '<p style="color: var(--text-dim); font-size: 0.9rem; text-align: center;">No presence checks logged today.</p>';
      } else {
        logEl.innerHTML = checks.map(check => {
          const time = new Date(check.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const tags = [];
          if (check.caughtUrge) tags.push('<span class="presence-tag positive">Caught urge</span>');
          if (check.used5SecondRule) tags.push('<span class="presence-tag positive">5-second rule</span>');
          if (check.stayedPresent) tags.push('<span class="presence-tag positive">Stayed present</span>');
          if (check.brokePlan) tags.push('<span class="presence-tag">Broke plan</span>');

          return `
            <div class="presence-log-item">
              <div class="presence-log-time">${time}</div>
              <div class="presence-log-thought">${check.thought}</div>
              <div class="presence-log-tags">${tags.join('')}</div>
            </div>
          `;
        }).reverse().join('');
      }

      document.getElementById('presenceLogModal').classList.add('active');
    }

    function closePresenceLogModal() {
      document.getElementById('presenceLogModal').classList.remove('active');
    }

    // ===== STREAKS & GAMIFICATION =====

    function updateStreaks() {
      const today = getTodayDateString();

      // Load historical data to calculate streaks
      const allExecData = getAllExecutionHistory();
      const allPresData = getAllPresenceHistory();

      // Calculate plan streak (plan created + execution >= 70)
      let planStreak = 0;
      for (let i = 0; i < 365; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];

        const dayExec = allExecData[dateStr];
        if (dayExec && dayExec.timeBlocks && dayExec.timeBlocks.length > 0 && dayExec.executionScore >= 70) {
          planStreak++;
        } else if (i > 0) {
          break;
        }
      }

      // Calculate awareness streak (3+ presence checks)
      let awarenessStreak = 0;
      for (let i = 0; i < 365; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];

        const dayPres = allPresData[dateStr];
        if (dayPres && dayPres.checks && dayPres.checks.length >= 3) {
          awarenessStreak++;
        } else if (i > 0) {
          break;
        }
      }

      // Calculate complete streak (both conditions)
      let completeStreak = 0;
      for (let i = 0; i < 365; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];

        const dayExec = allExecData[dateStr];
        const dayPres = allPresData[dateStr];

        const hasPlan = dayExec && dayExec.timeBlocks && dayExec.timeBlocks.length > 0 && dayExec.executionScore >= 70;
        const hasAwareness = dayPres && dayPres.checks && dayPres.checks.length >= 3;

        if (hasPlan && hasAwareness) {
          completeStreak++;
        } else if (i > 0) {
          break;
        }
      }

      // Update best records
      streaksData.planStreak.current = planStreak;
      streaksData.planStreak.best = Math.max(streaksData.planStreak.best, planStreak);

      streaksData.awarenessStreak.current = awarenessStreak;
      streaksData.awarenessStreak.best = Math.max(streaksData.awarenessStreak.best, awarenessStreak);

      streaksData.completeStreak.current = completeStreak;
      streaksData.completeStreak.best = Math.max(streaksData.completeStreak.best, completeStreak);

      saveTrackingData();
      updateStreaksDisplay();
      checkBadges();
    }

    function getAllExecutionHistory() {
      try {
        const data = localStorage.getItem('executionHistory');
        return data ? JSON.parse(data) : {};
      } catch (e) {
        return {};
      }
    }

    function getAllPresenceHistory() {
      try {
        const data = localStorage.getItem('presenceHistory');
        return data ? JSON.parse(data) : {};
      } catch (e) {
        return {};
      }
    }

    function saveToHistory() {
      const today = getTodayDateString();

      // Save execution history
      const execHistory = getAllExecutionHistory();
      execHistory[today] = { ...executionData };
      localStorage.setItem('executionHistory', JSON.stringify(execHistory));

      // Save presence history
      const presHistory = getAllPresenceHistory();
      presHistory[today] = { ...presenceData };
      localStorage.setItem('presenceHistory', JSON.stringify(presHistory));
    }

    function updateStreaksDisplay() {
      document.getElementById('planStreakCurrent').textContent = streaksData.planStreak.current;
      document.getElementById('planStreakBest').textContent = `Best: ${streaksData.planStreak.best} days`;

      document.getElementById('awarenessStreakCurrent').textContent = streaksData.awarenessStreak.current;
      document.getElementById('awarenessStreakBest').textContent = `Best: ${streaksData.awarenessStreak.best} days`;

      document.getElementById('completeStreakCurrent').textContent = streaksData.completeStreak.current;
      document.getElementById('completeStreakBest').textContent = `Best: ${streaksData.completeStreak.best} days`;

      // Update level
      updateLevel();
    }

    function updateLevel() {
      const streak = streaksData.completeStreak.current;
      let level, icon, nextMilestone;

      if (streak >= 91) {
        level = 'MASTER';
        icon = 'ðŸ‘‘';
        nextMilestone = 'You are a master!';
      } else if (streak >= 61) {
        level = 'TRANSFORMED';
        icon = 'ðŸ¦‹';
        nextMilestone = `${91 - streak} days to Master`;
      } else if (streak >= 31) {
        level = 'DISCIPLINED';
        icon = 'ðŸ’ª';
        nextMilestone = `${61 - streak} days to Transformed`;
      } else if (streak >= 15) {
        level = 'CONSISTENT';
        icon = 'ðŸŽ¯';
        nextMilestone = `${31 - streak} days to Disciplined`;
      } else if (streak >= 8) {
        level = 'AWARE';
        icon = 'ðŸ‘ï¸';
        nextMilestone = `${15 - streak} days to Consistent`;
      } else {
        level = 'BEGINNER';
        icon = 'ðŸŒ±';
        nextMilestone = `${8 - streak} days to Aware`;
      }

      document.getElementById('levelBadge').innerHTML = `${icon} ${level}`;
      document.getElementById('levelProgress').textContent = nextMilestone;
    }

    function checkBadges() {
      // Week of Execution
      if (!badges.executionWeek.earned && streaksData.planStreak.current >= 7) {
        badges.executionWeek.earned = true;
        badges.executionWeek.date = new Date().toISOString();
        document.getElementById('badge-execution-week').classList.remove('locked');
        document.getElementById('badge-execution-week').classList.add('earned');
        showToast('ðŸ”¥ Badge Earned: Week of Execution!');
      }

      // Week of Presence
      if (!badges.presenceWeek.earned && streaksData.awarenessStreak.current >= 7) {
        badges.presenceWeek.earned = true;
        badges.presenceWeek.date = new Date().toISOString();
        document.getElementById('badge-presence-week').classList.remove('locked');
        document.getElementById('badge-presence-week').classList.add('earned');
        showToast('ðŸ§˜ Badge Earned: Week of Presence!');
      }

      // Perfect Day
      const execScore = calculateExecutionScore();
      const presScore = presenceData.presenceScore || 0;
      if (!badges.perfectDay.earned && execScore >= 90 && presScore >= 90) {
        badges.perfectDay.earned = true;
        badges.perfectDay.date = new Date().toISOString();
        document.getElementById('badge-perfect-day').classList.remove('locked');
        document.getElementById('badge-perfect-day').classList.add('earned');
        showToast('ðŸ’Ž Badge Earned: Perfect Day!');
      }

      // 30-Day Master
      if (!badges.thirtyDay.earned && streaksData.completeStreak.current >= 30) {
        badges.thirtyDay.earned = true;
        badges.thirtyDay.date = new Date().toISOString();
        document.getElementById('badge-30-day').classList.remove('locked');
        document.getElementById('badge-30-day').classList.add('earned');
        showToast('ðŸ† Badge Earned: 30-Day Master!');
      }

      saveTrackingData();
      updateBadgesDisplay();
    }

    function updateBadgesDisplay() {
      if (badges.executionWeek.earned) {
        document.getElementById('badge-execution-week').classList.remove('locked');
        document.getElementById('badge-execution-week').classList.add('earned');
      }
      if (badges.presenceWeek.earned) {
        document.getElementById('badge-presence-week').classList.remove('locked');
        document.getElementById('badge-presence-week').classList.add('earned');
      }
      if (badges.perfectDay.earned) {
        document.getElementById('badge-perfect-day').classList.remove('locked');
        document.getElementById('badge-perfect-day').classList.add('earned');
      }
      if (badges.thirtyDay.earned) {
        document.getElementById('badge-30-day').classList.remove('locked');
        document.getElementById('badge-30-day').classList.add('earned');
      }
    }

    // ===== EVENING REVIEW FUNCTIONS =====

    function updateEveningReview() {
      // Update execution review
      const completedBlocks = timeBlocks.filter(b => b.status === 'completed').length;
      const partialBlocks = timeBlocks.filter(b => b.status === 'partial').length;
      const skippedBlocks = timeBlocks.filter(b => b.status === 'skipped').length;
      const doneBlocks = completedBlocks + partialBlocks;

      document.getElementById('eveningBlocksCompleted').textContent = `${doneBlocks}/${timeBlocks.length} completed`;

      const execScore = calculateExecutionScore();
      document.getElementById('eveningExecutionScore').textContent = `${execScore}/100`;
      document.getElementById('eveningExecutionScore').className = 'review-summary-score ' + getScoreColorClass(execScore);

      // Render blocks list
      const blocksListEl = document.getElementById('eveningBlocksList');
      if (timeBlocks.length === 0) {
        blocksListEl.innerHTML = '<p style="color: var(--text-dim); font-size: 0.85rem;">No blocks to review yet.</p>';
      } else {
        blocksListEl.innerHTML = timeBlocks.map(block => `
          <div class="review-block-item">
            <span class="review-block-status">${getBlockStatusIcon(block.status)}</span>
            <span class="review-block-time">${block.startTime}</span>
            <span class="review-block-activity">${block.activity} - ${getBlockStatusText(block.status)}</span>
          </div>
        `).join('');
      }

      // Update presence review
      const checks = presenceData.checks || [];
      const presScore = presenceData.presenceScore || 0;

      document.getElementById('eveningPresenceChecks').textContent = `${checks.length} times`;
      document.getElementById('eveningPresenceScore').textContent = `${presScore}/100`;
      document.getElementById('eveningPresenceScore').className = 'review-summary-score ' + getPresenceColorClass(presScore);

      // Urges list
      const urgeChecks = checks.filter(c => c.caughtUrge);
      const urgeListEl = document.getElementById('urgeListContainer');
      if (urgeChecks.length === 0) {
        urgeListEl.innerHTML = '<p style="color: var(--text-dim); font-size: 0.85rem;">No urges logged today. Use the âš¡ button to log presence checks.</p>';
      } else {
        urgeListEl.innerHTML = urgeChecks.map(check => {
          const time = new Date(check.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          return `
            <div class="urge-item">
              <span class="urge-time">${time}</span>
              <span class="urge-text">"${check.thought}"</span>
            </div>
          `;
        }).join('');
      }

      // 5-second rule count
      const fiveSecondCount = checks.filter(c => c.used5SecondRule).length;
      document.getElementById('evening5SecondCount').textContent = fiveSecondCount;

      // Stayed present count
      const stayedPresentCount = checks.filter(c => c.stayedPresent).length;
      document.getElementById('eveningStayedPresentCount').textContent = stayedPresentCount;

      // Common urge analysis
      analyzeCommonUrge();
    }

    function analyzeCommonUrge() {
      const checks = presenceData.checks || [];
      if (checks.length < 2) {
        document.getElementById('commonUrgeDisplay').textContent = 'Not enough data yet.';
        return;
      }

      // Simple keyword analysis
      const keywords = {};
      const commonWords = ['i', 'to', 'the', 'a', 'want', 'feel', 'like', 'am', 'my', 'and', 'or', 'is', 'it', 'that', 'this', 'be'];

      checks.forEach(check => {
        const words = check.thought.toLowerCase().split(/\s+/);
        words.forEach(word => {
          if (word.length > 3 && !commonWords.includes(word)) {
            keywords[word] = (keywords[word] || 0) + 1;
          }
        });
      });

      const sorted = Object.entries(keywords).sort((a, b) => b[1] - a[1]);
      if (sorted.length > 0) {
        const topWords = sorted.slice(0, 3).map(([word, count]) => word).join(', ');
        document.getElementById('commonUrgeDisplay').textContent = `Common themes: ${topWords}`;
      } else {
        document.getElementById('commonUrgeDisplay').textContent = 'Keep tracking to see patterns.';
      }
    }

    // ===== PATTERNS VIEW =====

    function updatePatternsView() {
      const execHistory = getAllExecutionHistory();
      const presHistory = getAllPresenceHistory();

      // Time of day analysis
      let morningTotal = 0, morningCompleted = 0;
      let afternoonTotal = 0, afternoonCompleted = 0;
      let eveningTotal = 0, eveningCompleted = 0;

      Object.values(execHistory).forEach(day => {
        if (day.timeBlocks) {
          day.timeBlocks.forEach(block => {
            const hour = parseInt(block.startTime.split(':')[0]);
            const isCompleted = block.status === 'completed' || block.status === 'partial';

            if (hour >= 6 && hour < 12) {
              morningTotal++;
              if (isCompleted) morningCompleted++;
            } else if (hour >= 12 && hour < 18) {
              afternoonTotal++;
              if (isCompleted) afternoonCompleted++;
            } else if (hour >= 18 && hour < 22) {
              eveningTotal++;
              if (isCompleted) eveningCompleted++;
            }
          });
        }
      });

      document.getElementById('patternMorning').textContent = morningTotal > 0 ?
        `${Math.round(morningCompleted / morningTotal * 100)}%` : '--%';
      document.getElementById('patternAfternoon').textContent = afternoonTotal > 0 ?
        `${Math.round(afternoonCompleted / afternoonTotal * 100)}%` : '--%';
      document.getElementById('patternEvening').textContent = eveningTotal > 0 ?
        `${Math.round(eveningCompleted / eveningTotal * 100)}%` : '--%';

      // Activity analysis - find most skipped
      const activitySkips = {};
      Object.values(execHistory).forEach(day => {
        if (day.timeBlocks) {
          day.timeBlocks.forEach(block => {
            if (block.status === 'skipped') {
              activitySkips[block.activity] = (activitySkips[block.activity] || 0) + 1;
            }
          });
        }
      });

      const mostSkipped = Object.entries(activitySkips).sort((a, b) => b[1] - a[1])[0];
      document.getElementById('patternMostSkipped').textContent = mostSkipped ?
        `${mostSkipped[0]} (${mostSkipped[1]}x)` : 'No data';

      // Best/Worst day
      let bestDay = null, bestScore = 0;
      let worstDay = null, worstScore = 100;

      Object.entries(execHistory).forEach(([date, day]) => {
        if (day.executionScore !== undefined) {
          if (day.executionScore > bestScore) {
            bestScore = day.executionScore;
            bestDay = date;
          }
          if (day.executionScore < worstScore && day.timeBlocks && day.timeBlocks.length > 0) {
            worstScore = day.executionScore;
            worstDay = date;
          }
        }
      });

      document.getElementById('patternBestDay').textContent = bestDay ?
        `${formatDateShort(bestDay)} (${bestScore}/100)` : 'No data';
      document.getElementById('patternWorstDay').textContent = worstDay ?
        `${formatDateShort(worstDay)} (${worstScore}/100)` : 'No data';

      // Average execution
      const scores = Object.values(execHistory)
        .filter(d => d.executionScore !== undefined && d.timeBlocks && d.timeBlocks.length > 0)
        .map(d => d.executionScore);
      const avgExec = scores.length > 0 ?
        Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : '--';
      document.getElementById('patternAvgExecution').textContent = `${avgExec}/100`;

      // Presence patterns
      let totalChecks = 0, totalDays = 0, fiveSecondSuccess = 0, fiveSecondTotal = 0;

      Object.values(presHistory).forEach(day => {
        if (day.checks && day.checks.length > 0) {
          totalDays++;
          totalChecks += day.checks.length;
          day.checks.forEach(check => {
            if (check.used5SecondRule) {
              fiveSecondTotal++;
              if (check.stayedPresent && !check.brokePlan) fiveSecondSuccess++;
            }
          });
        }
      });

      document.getElementById('patternTotalChecks').textContent = totalChecks;
      document.getElementById('patternAvgChecks').textContent = totalDays > 0 ?
        (totalChecks / totalDays).toFixed(1) : '0';
      document.getElementById('pattern5SecondRate').textContent = fiveSecondTotal > 0 ?
        `${Math.round(fiveSecondSuccess / fiveSecondTotal * 100)}%` : '--%';

      // Common urges across all days
      const allUrges = {};
      Object.values(presHistory).forEach(day => {
        if (day.checks) {
          day.checks.forEach(check => {
            if (check.caughtUrge) {
              const words = check.thought.toLowerCase().split(/\s+/);
              words.forEach(word => {
                if (word.length > 4) {
                  allUrges[word] = (allUrges[word] || 0) + 1;
                }
              });
            }
          });
        }
      });

      const sortedUrges = Object.entries(allUrges).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const urgesContainer = document.getElementById('commonUrgesContainer');
      if (sortedUrges.length > 0) {
        urgesContainer.innerHTML = sortedUrges.map(([word, count], i) => `
          <div class="pattern-row">
            <span class="pattern-label">${i + 1}. ${word}</span>
            <span class="pattern-value">${count} times</span>
          </div>
        `).join('');
      } else {
        urgesContainer.innerHTML = '<p style="color: var(--text-dim); font-size: 0.9rem;">Not enough data yet.</p>';
      }

      // Generate insight
      generateInsight(morningCompleted, morningTotal, afternoonCompleted, afternoonTotal, eveningCompleted, eveningTotal);
    }

    function formatDateShort(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    function generateInsight(mc, mt, ac, at, ec, et) {
      const insightEl = document.getElementById('executionInsight');

      if (mt + at + et < 5) {
        insightEl.innerHTML = '<strong>ðŸ’¡ Insight:</strong> Complete more days to see patterns in your execution.';
        return;
      }

      const morningRate = mt > 0 ? mc / mt : 0;
      const afternoonRate = at > 0 ? ac / at : 0;
      const eveningRate = et > 0 ? ec / et : 0;

      let insight = '<strong>ðŸ’¡ Insight:</strong> ';

      if (morningRate > afternoonRate && morningRate > eveningRate) {
        insight += "You're strongest in the mornings. Schedule your hardest work before noon.";
      } else if (afternoonRate < morningRate && afternoonRate < eveningRate) {
        insight += "You struggle in the afternoons. Consider a power nap or schedule lighter tasks after lunch.";
      } else if (eveningRate > morningRate && eveningRate > afternoonRate) {
        insight += "You're a night owl! Protect your evening focus time.";
      } else {
        insight += "Your performance is consistent throughout the day. Look for other patterns.";
      }

      insightEl.innerHTML = insight;
    }

    // ===== SWITCH VIEW UPDATES =====

    // Override the original switchView to include tracking views
    const originalSwitchView = switchView;
    switchView = function(viewName) {
      const tabs = document.querySelectorAll('.nav-tab');
      const views = document.querySelectorAll('.view');

      tabs.forEach(tab => tab.classList.remove('active'));
      views.forEach(view => view.classList.remove('active'));

      // Find and activate the correct tab
      tabs.forEach(tab => {
        const tabText = tab.textContent.toLowerCase();
        if (tabText.includes(viewName.toLowerCase())) {
          tab.classList.add('active');
        }
      });

      const viewEl = document.getElementById(viewName);
      if (viewEl) {
        viewEl.classList.add('active');
      }

      // Special handling for each view
      if (viewName === 'evening') {
        checkEveningAvailability();
        initPrinciplesCheckboxes();
        updateEveningReview();
      } else if (viewName === 'history') {
        displayHistory();
      } else if (viewName === 'settings') {
        updateSettingsUI();
      } else if (viewName === 'ground') {
        initGroundView();
      } else if (viewName === 'principles') {
        updatePrinciplesView();
      } else if (viewName === 'track') {
        renderTrackTimeBlocks();
        updateStreaks();
        updateBadgesDisplay();
      } else if (viewName === 'patterns') {
        updatePatternsView();
      } else if (viewName === 'morning') {
        renderMorningTimeBlocks();
        updateBlockCount();
      }
    };

    // ===== SAVE MORNING OVERRIDE =====

    const originalSaveMorning = saveMorning;
    saveMorning = function() {
      const data = {
        date: new Date().toISOString(),
        type: 'morning',
        dayIndex: currentDayIndex,
        truthResponse: document.getElementById('truthResponse').value,
        foundationalResponse: document.getElementById('foundationalResponse').value,
        identityDeclaration: document.getElementById('identityDeclaration').value,
        proofAction: document.getElementById('proofAction').value,
        energy: parseInt(document.getElementById('energySlider').value),
        optimism: parseInt(document.getElementById('optimismSlider').value),
        confidence: parseInt(document.getElementById('confidenceSlider').value)
      };

      // Validate
      if (!data.truthResponse || !data.foundationalResponse || !data.identityDeclaration || !data.proofAction) {
        showToast('Please complete all fields');
        return;
      }

      // Remove old morning entry for today
      const today = new Date().toDateString();
      entries = entries.filter(e => !(e.type === 'morning' && new Date(e.date).toDateString() === today));

      entries.push(data);
      saveToStorage();

      // Save execution data with time blocks
      executionData.date = getTodayDateString();
      executionData.timeBlocks = timeBlocks;
      executionData.executionScore = timeBlocks.length > 0 ? 50 : 0; // Base score
      saveTrackingData();
      saveToHistory();

      showToast('Morning complete. Make it count.');
      updateStats();
      updateLiveScores();
      scheduleNextNotifications();

      // Clear form
      document.getElementById('truthResponse').value = '';
      document.getElementById('foundationalResponse').value = '';
      document.getElementById('identityDeclaration').value = '';
      document.getElementById('proofAction').value = '';
    };

    // ===== SAVE EVENING OVERRIDE =====

    const originalSaveEvening = saveEvening;
    saveEvening = function() {
      const todayMorning = getTodayEntries().morning;

      if (!todayMorning) {
        showToast('Complete your morning check-in first');
        return;
      }

      if (eveningDidIt === null) {
        showToast('Please select Yes or No for accountability');
        return;
      }

      const data = {
        date: new Date().toISOString(),
        type: 'evening',
        dayIndex: currentDayIndex,
        didIt: eveningDidIt,
        accountabilityWhy: document.getElementById('accountabilityWhy').value,
        todayWin: document.getElementById('todayWin').value,
        happiness: parseInt(document.getElementById('happinessSlider').value),
        challenges: parseInt(document.getElementById('challengesSlider').value),
        connection: parseInt(document.getElementById('connectionSlider').value),
        tomorrowFocus: document.getElementById('tomorrowFocus').value,
        // New tracking fields
        executionPattern: document.getElementById('executionPattern')?.value || '',
        executionTomorrow: document.getElementById('executionTomorrow')?.value || '',
        awarenessFocus: document.getElementById('awarenessFocus')?.value || ''
      };

      // Validate
      if (!data.accountabilityWhy || !data.todayWin || !data.tomorrowFocus) {
        showToast('Please complete all fields');
        return;
      }

      // Remove old evening entry for today
      const today = new Date().toDateString();
      entries = entries.filter(e => !(e.type === 'evening' && new Date(e.date).toDateString() === today));

      entries.push(data);
      saveToStorage();

      // Save principles tracking
      savePrinciplesTracking();

      // Update execution score (add evening bonus)
      calculateExecutionScore();
      saveTrackingData();
      saveToHistory();

      // Update streaks
      updateStreaks();

      showToast('Evening complete. Rest well.');
      updateStats();
      updateLiveScores();
      scheduleNextNotifications();

      // Clear form
      eveningDidIt = null;
      document.getElementById('didItYes').classList.remove('selected');
      document.getElementById('didItNo').classList.remove('selected');
      document.getElementById('accountabilityWhy').value = '';
      document.getElementById('todayWin').value = '';
      document.getElementById('tomorrowFocus').value = '';
      document.getElementById('principlesReflection').value = '';
      document.getElementById('executionPattern').value = '';
      document.getElementById('executionTomorrow').value = '';
      document.getElementById('awarenessFocus').value = '';
      selectedPrinciples = [];
      initPrinciplesCheckboxes();
    };

    // ===== INITIALIZE TRACKING =====

    function initTracking() {
      loadTrackingData();
      renderMorningTimeBlocks();
      updateBlockCount();
      updateLiveScores();
      updateStreaks();
      updateBadgesDisplay();

      // Check for auto-status updates every minute
      setInterval(() => {
        if (document.getElementById('track').classList.contains('active')) {
          renderTrackTimeBlocks();
        }
        updateLiveScores();
      }, 60000);

      console.log('Tracking system initialized');
    }

    // ===== END EXECUTION & PRESENCE TRACKING SYSTEM =====

    loadFromStorage();
    init();
    initTracking();
  </script>
</body>
</html>
